<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanroom DataLog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE",
            authDomain: "sistema-monitoramento-anvisa.firebaseapp.com",
            projectId: "sistema-monitoramento-anvisa",
            storageBucket: "sistema-monitoramento-anvisa.firebasestorage.app",
            messagingSenderId: "551458347466",
            appId: "1:551458347466:web:541f0b0f77e4faa67c5733"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        console.log('Firebase inicializado!');
    </script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            font-size: 14px;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--primary);
            color: white;
            transition: all 0.3s;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 20px;
            background-color: rgba(0,0,0,0.2);
            text-align: center;
            position: sticky;
            top: 0;
            background-color: var(--primary);
        }
        
        .sidebar-menu {
            padding: 15px 0;
        }
        
        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .menu-item.active {
            background-color: var(--secondary);
            border-left: 4px solid white;
        }
        
        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            margin-left: 250px;
            width: calc(100% - 250px);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .user-role {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: var(--success);
            color: white;
            margin-left: 10px;
        }
        
        .user-role.admin {
            background-color: var(--warning);
        }
        
        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Status indicators */
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-normal {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-alert {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-critical {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Page Content */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Login Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
        }
        
        /* Mobile Cards */
        .mobile-cards {
            display: none;
        }
        
        .mobile-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .mobile-card-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .mobile-card-field {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .mobile-card-label {
            font-weight: 500;
            color: var(--dark);
        }
        
        .mobile-card-value {
            color: var(--gray);
        }
        
        .mobile-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        /* Novos estilos para cards de osmose */
        .osmosis-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .osmosis-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .osmosis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .osmosis-card-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .osmosis-card-field {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .osmosis-card-label {
            font-weight: 500;
            color: var(--dark);
            min-width: 120px;
        }
        
        .osmosis-card-value {
            color: var(--gray);
            flex: 1;
            text-align: right;
        }
        
        .osmosis-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .osmosis-card-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
            
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                z-index: 1000;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }
            
            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding: 10px 0;
            }
            
            .menu-item {
                flex: 1;
                min-width: 120px;
                justify-content: center;
                border-left: none;
                border-top: 4px solid transparent;
                padding: 12px 10px;
                font-size: 12px;
                flex-direction: column;
                text-align: center;
            }
            
            .menu-item i {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 16px;
            }
            
            .menu-item.active {
                border-left: none;
                border-top: 4px solid white;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px 0;
            }
            
            .user-info {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .card-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            table {
                display: none;
            }
            
            .mobile-cards {
                display: block;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            
            .btn-sm {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .osmosis-cards-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                padding: 10px;
            }
            
            .sidebar-header h2 {
                font-size: 18px;
            }
            
            .sidebar-header p {
                font-size: 12px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
            }
            
            .user-role {
                font-size: 10px;
                padding: 2px 6px;
            }
        }
        
        /* Hidden elements for non-admin users */
        .admin-only {
            display: none;
        }
        
        .user-admin .admin-only {
            display: block;
        }
        
        .user-admin .admin-only-inline {
            display: inline-block;
        }
        
        /* Edit Modal */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .edit-modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .edit-modal-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-title">Login do Sistema</div>
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label for="login-password">Senha:</label>
                <input type="password" id="login-password" placeholder="Sua senha">
            </div>
            <div id="login-error" style="color: red; margin-bottom: 15px; display: none;"></div>
            <button class="btn btn-primary" id="login-btn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div style="margin-top: 15px; text-align: center; font-size: 12px; color: #666;">
                <!-- Informações adicionais podem ser adicionadas aqui -->
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="edit-modal" id="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-title" id="edit-modal-title">Editar Registro</div>
            <div id="edit-modal-content">
                <!-- Conteúdo dinâmico será inserido aqui -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" id="cancel-edit-btn">Cancelar</button>
                <button class="btn btn-primary" id="save-edit-btn">Salvar</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-clinic-medical"></i> Clean DataLog</h2>
                <p>Sistema de Monitoramento</p>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-page="temperature">
                    <i class="fas fa-thermometer-half"></i>
                    <span>Temperatura & Umidade</span>
                </div>
                <div class="menu-item" data-page="pressure">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Pressão</span>
                </div>
                <div class="menu-item" data-page="osmosis">
                    <i class="fas fa-tint"></i>
                    <span>Sistema de Osmose</span>
                </div>
                <div class="menu-item admin-only" data-page="rooms">
                    <i class="fas fa-door-open"></i>
                    <span>Gerenciar Salas</span>
                </div>
                <div class="menu-item admin-only" data-page="users">
                    <i class="fas fa-users"></i>
                    <span>Gerenciar Usuários</span>
                </div>
                <div class="menu-item admin-only" data-page="traceability">
                    <i class="fas fa-history"></i>
                    <span>Rastreabilidade</span>
                </div>
                <div class="menu-item admin-only" data-page="reports">
                    <i class="fas fa-file-pdf"></i>
                    <span>Relatórios</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="page-title">Monitoramento de Ambiente</div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div>Operador: <span id="current-user">Usuário</span></div>
                        <div style="font-size: 12px; color: var(--gray);">Último login: <span id="last-login">--:--</span></div>
                    </div>
                    <div class="user-role" id="user-role">Usuário</div>
                    <button class="btn btn-warning btn-sm" id="logout-btn" style="margin-left: 10px;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
            
            <!-- Temperature & Humidity Page -->
            <div class="page-content active" id="temperature-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Registro de Temperatura e Umidade</div>
                        <div class="current-time" id="current-time">Carregando data/hora...</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="room-select">Selecione a Sala:</label>
                        <select id="room-select">
                            <option value="">Carregando salas...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="periodo">Período:</label>
                        <select id="periodo">
                            <option value="manha">Manhã</option>
                            <option value="tarde">Tarde</option>
                        </select>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Temperatura</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="temp-min">Temperatura Mínima (°C):</label>
                                <input type="number" id="temp-min" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="temp-max">Temperatura Máxima (°C):</label>
                                <input type="number" id="temp-max" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="temp-atual">Temperatura Atual (°C):</label>
                                <input type="number" id="temp-atual" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Umidade</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="umid-min">Umidade Mínima (%):</label>
                                <input type="number" id="umid-min" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="umid-max">Umidade Máxima (%):</label>
                                <input type="number" id="umid-max" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="umid-atual">Umidade Atual (%):</label>
                                <input type="number" id="umid-atual" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="temp-notes">Observações:</label>
                        <textarea id="temp-notes" rows="3" placeholder="Adicione observações se necessário..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="save-temp-btn">
                        <i class="fas fa-save"></i> Registrar Leitura
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Histórico de Temperatura e Umidade</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm admin-only" id="export-temp-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Sala</th>
                                    <th>Período</th>
                                    <th>Temp. Mín</th>
                                    <th>Temp. Máx</th>
                                    <th>Temp. Atual</th>
                                    <th>Umid. Mín</th>
                                    <th>Umid. Máx</th>
                                    <th>Umid. Atual</th>
                                    <th>Status</th>
                                    <th>Operador</th>
                                    <th class="admin-only">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="temp-history">
                                <tr>
                                    <td colspan="12" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="temp-history-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Pressure Page -->
            <div class="page-content" id="pressure-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Registro de Pressão</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-room">Selecione a Sala:</label>
                        <select id="pressure-room">
                            <option value="">Carregando salas...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-periodo">Período:</label>
                        <select id="pressure-periodo">
                            <option value="manha">Manhã</option>
                            <option value="tarde">Tarde</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-value">Pressão (Pa):</label>
                        <input type="number" id="pressure-value" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="correcao-imediata">Correção Imediata:</label>
                        <textarea id="correcao-imediata" rows="3" placeholder="Descreva a correção realizada, se aplicável..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-notes">Observações:</label>
                        <textarea id="pressure-notes" rows="3" placeholder="Adicione observações se necessário..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="save-pressure-btn">
                        <i class="fas fa-save"></i> Registrar Pressão
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Histórico de Pressão</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm admin-only" id="export-pressure-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Sala</th>
                                    <th>Período</th>
                                    <th>Pressão (Pa)</th>
                                    <th>Correção Imediata</th>
                                    <th>Status</th>
                                    <th>Operador</th>
                                    <th class="admin-only">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="pressure-history">
                                <tr>
                                    <td colspan="8" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="pressure-history-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Osmosis Page -->
            <div class="page-content" id="osmosis-page">
                <div class="tabs">
                    <div class="tab active" data-tab="daily">Controle Diário</div>
                    <div class="tab" data-tab="maintenance">Controle de Manutenção</div>
                </div>
                
                <!-- Daily Control Tab -->
                <div id="daily-tab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Controle Diário do Sistema de Osmose Reversa</div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">1. Condutividade da Água Purificada</div>
                            <div class="form-group">
                                <label for="condutividade">Resultado observado no condutivímetro de linha (µS/cm):</label>
                                <input type="number" id="condutividade" step="0.1" min="0">
                                <small style="color: var(--gray);">Limite: 1.3 µS/cm</small>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">2. Sanitização do Sistema de Osmose Reversa ou Downtime</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ultima-sanitizacao">Data da última sanitização/downtime:</label>
                                    <input type="date" id="ultima-sanitizacao">
                                </div>
                                
                                <div class="form-group">
                                    <label for="proxima-sanitizacao">Data prevista para a próxima sanitização/downtime:</label>
                                    <input type="date" id="proxima-sanitizacao">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">3. Higienização</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ultima-higienizacao">Data da última higienização:</label>
                                    <input type="date" id="ultima-higienizacao">
                                </div>
                                
                                <div class="form-group">
                                    <label for="proxima-higienizacao">Data prevista para a próxima higienização:</label>
                                    <input type="date" id="proxima-higienizacao">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">4. Coleta de Água para Análise</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ultima-coleta">Data da última coleta:</label>
                                    <input type="date" id="ultima-coleta">
                                </div>
                                
                                <div class="form-group">
                                    <label for="proxima-coleta">Data prevista para a próxima coleta:</label>
                                    <input type="date" id="proxima-coleta">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">5. O equipamento apresenta alguma anormalidade no funcionamento?</div>
                            <div class="checkbox-group">
                                <input type="radio" id="anormalidade-sim" name="anormalidade" value="sim">
                                <label for="anormalidade-sim">Sim</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="anormalidade-nao" name="anormalidade" value="nao" checked>
                                <label for="anormalidade-nao">Não</label>
                            </div>
                            
                            <div class="form-group" id="anormalidade-detalhes" style="display: none;">
                                <label for="motivo-anormalidade">Descreva o motivo:</label>
                                <textarea id="motivo-anormalidade" rows="3" placeholder="Descreva a anormalidade observada..."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">6. Troca de Filtros</div>
                            
                            <div class="form-group">
                                <label>Data da última troca:</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="ultima-fpp001">FPP-001:</label>
                                        <input type="date" id="ultima-fpp001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ultima-fca001">FCA-001:</label>
                                        <input type="date" id="ultima-fca001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ultima-drm001">DRM-001:</label>
                                        <input type="date" id="ultima-drm001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ultima-drm002">DRM-002:</label>
                                        <input type="date" id="ultima-drm002">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Data prevista para a próxima troca:</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="proxima-fpp001">FPP-001:</label>
                                        <input type="date" id="proxima-fpp001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxima-fca001">FCA-001:</label>
                                        <input type="date" id="proxima-fca001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxima-drm001">DRM-001:</label>
                                        <input type="date" id="proxima-drm001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxima-drm002">DRM-002:</label>
                                        <input type="date" id="proxima-drm002">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="osmosis-daily-notes">Observações:</label>
                            <textarea id="osmosis-daily-notes" rows="3" placeholder="Adicione observações sobre o sistema de osmose..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" id="save-osmosis-daily-btn">
                            <i class="fas fa-save"></i> Registrar Controle Diário
                        </button>
                    </div>
                </div>
                
                <!-- Maintenance Control Tab -->
                <div id="maintenance-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Controle de Manutenção do Sistema de Osmose Reversa</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="procedimento">Procedimento Realizado:</label>
                            <textarea id="procedimento" rows="3" placeholder="Descreva o procedimento de manutenção realizado..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="data-manutencao">Data da Manutenção:</label>
                            <input type="date" id="data-manutencao">
                        </div>
                        
                        <div class="form-group">
                            <label for="obs-manutencao">Observações:</label>
                            <textarea id="obs-manutencao" rows="3" placeholder="Adicione observações sobre a manutenção..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" id="save-osmosis-maintenance-btn">
                            <i class="fas fa-save"></i> Registrar Manutenção
                        </button>
                    </div>

                    <div class="card admin-only">
                        <div class="card-header">
                            <div class="card-title">Histórico de Manutenções</div>
                            <div class="card-actions">
                                <button class="btn btn-success btn-sm" id="export-maintenance-pdf">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Procedimento</th>
                                        <th>Observações</th>
                                        <th>Operador</th>
                                        <th class="admin-only">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-history">
                                    <tr>
                                        <td colspan="5" style="text-align: center;">Carregando dados...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mobile-cards" id="maintenance-history-cards">
                            <!-- Cards serão inseridos aqui dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="card admin-only">
                    <div class="card-header">
                        <div class="card-title">Histórico de Osmose - Controles Diários</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" id="export-osmosis-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Condutividade</th>
                                    <th>Status</th>
                                    <th>Anormalidade</th>
                                    <th>Operador</th>
                                    <th class="admin-only">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="osmosis-history">
                                <tr>
                                    <td colspan="6" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="osmosis-history-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>

                <!-- Seção de Cards Detalhados de Osmose -->
                <div class="card admin-only">
                    <div class="card-header">
                        <div class="card-title">Controles Diários Detalhados - Sistema de Osmose</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" onclick="exportAllOsmosisCardsToPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar Todos em PDF
                            </button>
                        </div>
                    </div>
                    <div class="osmosis-cards-container" id="osmosis-detailed-cards">
                        <!-- Cards detalhados serão inseridos aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Rooms Page -->
            <div class="page-content" id="rooms-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Adicionar Nova Sala</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="room-name">Nome da Sala:</label>
                            <input type="text" id="room-name" placeholder="Ex: Sala 05 - Qualidade">
                        </div>
                        
                        <div class="form-group">
                            <label for="room-code">Código da Sala:</label>
                            <input type="text" id="room-code" placeholder="Ex: SALA05">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="room-type">Tipo de Sala:</label>
                            <select id="room-type">
                                <option value="estoque">Estoque</option>
                                <option value="preparacao">Preparação</option>
                                <option value="producao">Produção</option>
                                <option value="embalagem">Embalagem</option>
                                <option value="qualidade">Controle de Qualidade</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="room-responsible">Responsável:</label>
                            <input type="text" id="room-responsible" placeholder="Nome do responsável">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Parâmetros de Temperatura</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="temp-min-room">Temperatura Mínima (°C):</label>
                                <input type="number" id="temp-min-room" step="0.1" placeholder="Ex: 18.0" value="18.0">
                            </div>
                            <div class="form-group">
                                <label for="temp-max-room">Temperatura Máxima (°C):</label>
                                <input type="number" id="temp-max-room" step="0.1" placeholder="Ex: 26.0" value="26.0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Parâmetros de Umidade</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="umid-min-room">Umidade Mínima (%):</label>
                                <input type="number" id="umid-min-room" step="0.1" placeholder="Ex: 40.0" value="40.0">
                            </div>
                            <div class="form-group">
                                <label for="umid-max-room">Umidade Máxima (%):</label>
                                <input type="number" id="umid-max-room" step="0.1" placeholder="Ex: 60.0" value="60.0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-value-min">Pressão deve ser maior ou igual a (Pa):</label>
                        <input type="number" id="pressure-value-min" placeholder="Ex: 5" value="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="room-description">Descrição:</label>
                        <textarea id="room-description" rows="3" placeholder="Descreva a finalidade da sala..."></textarea>
                    </div>
                    
                    <button class="btn btn-success" id="add-room-btn">
                        <i class="fas fa-plus"></i> Adicionar Sala
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Salas Cadastradas</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" id="export-rooms-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Responsável</th>
                                    <th>Temp. Min-Max</th>
                                    <th>Umid. Min-Max</th>
                                    <th>Pressão Mínima</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="rooms-list">
                                <tr>
                                    <td colspan="9" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="rooms-list-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Users Management Page -->
            <div class="page-content" id="users-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Adicionar Novo Usuário</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-name">Nome Completo:</label>
                            <input type="text" id="user-name" placeholder="Nome do usuário">
                        </div>
                        
                        <div class="form-group">
                            <label for="user-email">Email:</label>
                            <input type="email" id="user-email" placeholder="email@empresa.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-password">Senha:</label>
                            <input type="password" id="user-password" placeholder="Senha temporária">
                        </div>
                        
                        <div class="form-group">
                            <label for="user-role">Tipo de Usuário:</label>
                            <select id="user-role">
                                <option value="user">Usuário Normal</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" id="add-user-btn">
                        <i class="fas fa-user-plus"></i> Adicionar Usuário
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Usuários do Sistema</div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>Data de Criação</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <tr>
                                    <td colspan="6" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="users-list-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Traceability Page -->
            <div class="page-content" id="traceability-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Rastreabilidade do Sistema</div>
                        <div class="card-actions admin-only">
                            <button class="btn btn-success btn-sm" onclick="exportTraceabilityToPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar Relatório Completo
                            </button>
                            <button class="btn btn-success btn-sm" id="export-traceability-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-title">Filtros</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filter-date">Filtrar por Data:</label>
                                <input type="date" id="filter-date">
                            </div>
                            
                            <div class="form-group">
                                <label for="filter-user">Filtrar por Usuário:</label>
                                <select id="filter-user">
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filter-action">Filtrar por Ação:</label>
                                <select id="filter-action">
                                    <option value="all">Todas</option>
                                    <option value="temperature">Temperatura/Umidade</option>
                                    <option value="pressure">Pressão</option>
                                    <option value="osmosis">Osmose</option>
                                    <option value="room">Sala</option>
                                    <option value="user">Usuário</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Detalhes</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="traceability-log">
                                <tr>
                                    <td colspan="5" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="traceability-log-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Reports Page -->
            <div class="page-content" id="reports-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Relatórios do Sistema</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="report-type">Tipo de Relatório:</label>
                        <select id="report-type">
                            <option value="temperature">Temperatura e Umidade</option>
                            <option value="pressure">Pressão</option>
                            <option value="osmosis">Sistema de Osmose</option>
                            <option value="rooms">Salas</option>
                            <option value="users">Usuários</option>
                            <option value="traceability">Rastreabilidade</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="report-start-date">Data Inicial:</label>
                            <input type="date" id="report-start-date">
                        </div>
                        
                        <div class="form-group">
                            <label for="report-end-date">Data Final:</label>
                            <input type="date" id="report-end-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="report-format">Formato do Relatório:</label>
                        <select id="report-format">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" id="generate-report-btn">
                        <i class="fas fa-file-export"></i> Gerar Relatório
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global da aplicação
        let currentUser = null;
        let rooms = [];
        let allUsers = [];
        let currentEditData = null;
        let traceabilityData = [];
        let osmosisDailyData = [];

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            console.log('Inicializando aplicação...');
            
            // Verificar se usuário já está logado
            auth.onAuthStateChanged(async (user) => {
                console.log('Estado de autenticação alterado:', user);
                if (user) {
                    await handleUserLogin(user);
                } else {
                    showLoginModal();
                }
            });

            // Configurar event listeners
            setupEventListeners();
            setupOsmosisTabs();
            
            // Atualizar hora atual
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }

        function setupEventListeners() {
            // Login
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Navegação
            const menuItems = document.querySelectorAll('.menu-item');
            const pages = document.querySelectorAll('.page-content');
            
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('admin-only') && currentUser && currentUser.role !== 'admin') {
                        alert('Apenas administradores podem acessar esta funcionalidade.');
                        return;
                    }
                    
                    const targetPage = this.getAttribute('data-page');
                    
                    // Update active menu item
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target page
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === `${targetPage}-page`) {
                            page.classList.add('active');
                        }
                    });
                    
                    // Update page title
                    updatePageTitle(targetPage);

                    // Carregar dados específicos da página
                    if (targetPage === 'users') {
                        loadUsersList();
                    } else if (targetPage === 'rooms') {
                        loadRoomsList();
                    } else if (targetPage === 'traceability') {
                        loadTraceabilityLog();
                    } else if (targetPage === 'osmosis') {
                        loadOsmosisHistory();
                    }
                });
            });

            // Salvar dados
            document.getElementById('save-temp-btn').addEventListener('click', saveTemperatureData);
            document.getElementById('save-pressure-btn').addEventListener('click', savePressureData);
            document.getElementById('save-osmosis-daily-btn').addEventListener('click', saveOsmosisDaily);
            document.getElementById('save-osmosis-maintenance-btn').addEventListener('click', saveOsmosisMaintenance);
            document.getElementById('add-room-btn').addEventListener('click', addRoom);
            document.getElementById('add-user-btn').addEventListener('click', addUser);

            // Toggle anormalidade
            document.getElementById('anormalidade-sim').addEventListener('change', function() {
                document.getElementById('anormalidade-detalhes').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('anormalidade-nao').addEventListener('change', function() {
                document.getElementById('anormalidade-detalhes').style.display = this.checked ? 'none' : 'block';
            });

            // Exportar PDF
            document.getElementById('export-temp-pdf').addEventListener('click', () => exportToPDF('temperature'));
            document.getElementById('export-pressure-pdf').addEventListener('click', () => exportToPDF('pressure'));
            document.getElementById('export-osmosis-pdf').addEventListener('click', () => exportToPDF('osmosis'));
            document.getElementById('export-maintenance-pdf').addEventListener('click', () => exportToPDF('maintenance'));
            document.getElementById('export-rooms-pdf').addEventListener('click', () => exportToPDF('rooms'));
            document.getElementById('export-traceability-pdf').addEventListener('click', () => exportToPDF('traceability'));
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);

            // Filtros
            document.getElementById('filter-date').addEventListener('change', loadTraceabilityLog);
            document.getElementById('filter-user').addEventListener('change', loadTraceabilityLog);
            document.getElementById('filter-action').addEventListener('change', loadTraceabilityLog);

            // Edit Modal
            document.getElementById('cancel-edit-btn').addEventListener('click', hideEditModal);
            document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
        }

        function setupOsmosisTabs() {
            const tabs = document.querySelectorAll('#osmosis-page .tab');
            const tabContents = document.querySelectorAll('#osmosis-page .tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(`${targetTab}-tab`).classList.add('active');
                });
            });
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            try {
                // Mostrar loading
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
                loginBtn.disabled = true;

                console.log('Tentando login com:', email);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Login bem-sucedido:', userCredential.user);
                await handleUserLogin(userCredential.user);
                
            } catch (error) {
                console.error('Erro no login:', error);
                errorDiv.textContent = getAuthErrorMessage(error.code);
                errorDiv.style.display = 'block';
            } finally {
                // Restaurar botão
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                loginBtn.disabled = false;
            }
        }

        async function handleUserLogin(user) {
            console.log('Processando login do usuário:', user.email);
            
            try {
                // Buscar dados do usuário no Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        ...userDoc.data()
                    };
                    console.log('Dados do usuário carregados:', currentUser);
                } else {
                    // Criar usuário padrão se não existir
                    console.log('Usuário não encontrado no Firestore, criando...');
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.email.split('@')[0],
                        role: 'user',
                        createdAt: new Date()
                    };
                    
                    await db.collection('users').doc(user.uid).set(currentUser);
                }

                updateUI();
                await loadInitialData();
                hideLoginModal();
                
                // Registrar login no log de rastreabilidade
                await addTraceability('Login no sistema', `Usuário ${currentUser.name} fez login`);
                
            } catch (error) {
                console.error('Erro ao processar login:', error);
                alert('Erro ao carregar dados do usuário: ' + error.message);
            }
        }

        function handleLogout() {
            auth.signOut();
            currentUser = null;
            showLoginModal();
        }

        function updateUI() {
            document.getElementById('current-user').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuário';
            document.getElementById('user-role').className = `user-role ${currentUser.role === 'admin' ? 'admin' : ''}`;
            document.getElementById('last-login').textContent = new Date().toLocaleTimeString('pt-BR');
            
            if (currentUser.role === 'admin') {
                document.body.classList.add('user-admin');
            } else {
                document.body.classList.remove('user-admin');
            }
        }

        function updatePageTitle(page) {
            const titles = {
                'temperature': 'Monitoramento de Temperatura e Umidade',
                'pressure': 'Monitoramento de Pressão',
                'osmosis': 'Sistema de Osmose',
                'rooms': 'Gerenciamento de Salas',
                'users': 'Gerenciamento de Usuários',
                'traceability': 'Rastreabilidade do Sistema',
                'reports': 'Relatórios do Sistema'
            };
            document.querySelector('.page-title').textContent = titles[page] || 'Sistema de Monitoramento';
        }

        async function loadInitialData() {
            try {
                // Carregar salas
                await loadRooms();
                
                // Carregar históricos
                loadTemperatureHistory();
                loadPressureHistory();
                loadOsmosisHistory();
                loadMaintenanceHistory();
                loadTraceabilityLog();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados iniciais');
            }
        }

        async function loadRooms() {
            try {
                const roomsSnapshot = await db.collection('rooms')
                    .where('status', '==', 'active')
                    .get();
                
                rooms = [];
                roomsSnapshot.forEach(doc => {
                    rooms.push({ id: doc.id, ...doc.data() });
                });
                
                updateRoomsSelect();
                
            } catch (error) {
                console.error('Erro ao carregar salas:', error);
                // Continua mesmo com erro para não bloquear a aplicação
            }
        }

        function updateRoomsSelect() {
            const roomSelect = document.getElementById('room-select');
            const pressureRoomSelect = document.getElementById('pressure-room');
            
            roomSelect.innerHTML = '';
            pressureRoomSelect.innerHTML = '';
            
            if (rooms.length === 0) {
                roomSelect.innerHTML = '<option value="">Nenhuma sala cadastrada</option>';
                pressureRoomSelect.innerHTML = '<option value="">Nenhuma sala cadastrada</option>';
                return;
            }
            
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = `${room.code} - ${room.name}`;
                
                roomSelect.appendChild(option.cloneNode(true));
                pressureRoomSelect.appendChild(option);
            });
        }

        // ========== FUNÇÕES PARA SALVAR DADOS ==========

        async function saveTemperatureData() {
            if (!currentUser) return;
            
            const roomId = document.getElementById('room-select').value;
            const room = rooms.find(r => r.id === roomId);
            
            if (!room) {
                alert('Por favor, selecione uma sala válida.');
                return;
            }

            const tempMin = parseFloat(document.getElementById('temp-min').value);
            const tempMax = parseFloat(document.getElementById('temp-max').value);
            const tempActual = parseFloat(document.getElementById('temp-atual').value);
            const humidityMin = parseFloat(document.getElementById('umid-min').value);
            const humidityMax = parseFloat(document.getElementById('umid-max').value);
            const humidityActual = parseFloat(document.getElementById('umid-atual').value);

            // Validação
            if (isNaN(tempMin) || isNaN(tempMax) || isNaN(tempActual) || 
                isNaN(humidityMin) || isNaN(humidityMax) || isNaN(humidityActual)) {
                alert('Por favor, preencha todos os campos obrigatórios com valores numéricos válidos.');
                return;
            }

            const data = {
                roomId: roomId,
                roomName: `${room.code} - ${room.name}`,
                period: document.getElementById('periodo').value,
                tempMin: tempMin,
                tempMax: tempMax,
                tempActual: tempActual,
                humidityMin: humidityMin,
                humidityMax: humidityMax,
                humidityActual: humidityActual,
                notes: document.getElementById('temp-notes').value,
                status: calculateTemperatureStatus(
                    tempActual,
                    humidityActual,
                    room.tempMin,
                    room.tempMax,
                    room.humidityMin,
                    room.humidityMax
                ),
                userId: currentUser.uid,
                userName: currentUser.name,
                createdAt: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('temperature_readings').add(data);
                await addTraceability(
                    'Registro de temperatura', 
                    `${data.roomName} (${data.period}): Temp: ${data.tempMin}-${data.tempMax}°C, Umid: ${data.humidityMin}-${data.humidityMax}%`
                );
                
                alert('Dados de temperatura registrados com sucesso!');
                clearTemperatureForm();
                loadTemperatureHistory();
                
            } catch (error) {
                console.error('Erro ao salvar temperatura:', error);
                alert('Erro ao salvar dados de temperatura: ' + error.message);
            }
        }

        async function savePressureData() {
            if (!currentUser) return;
            
            const roomId = document.getElementById('pressure-room').value;
            const room = rooms.find(r => r.id === roomId);
            
            if (!room) {
                alert('Por favor, selecione uma sala válida.');
                return;
            }

            const pressureValue = parseInt(document.getElementById('pressure-value').value);

            if (isNaN(pressureValue)) {
                alert('Por favor, preencha o campo de pressão com um valor numérico válido.');
                return;
            }

            const data = {
                roomId: roomId,
                roomName: `${room.code} - ${room.name}`,
                period: document.getElementById('pressure-periodo').value,
                pressure: pressureValue,
                immediateCorrection: document.getElementById('correcao-imediata').value,
                notes: document.getElementById('pressure-notes').value,
                status: calculatePressureStatus(pressureValue, room.pressureMin),
                userId: currentUser.uid,
                userName: currentUser.name,
                createdAt: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('pressure_readings').add(data);
                await addTraceability(
                    'Registro de pressão', 
                    `${data.roomName}: ${data.pressure} Pa`
                );
                
                alert('Dados de pressão registrados com sucesso!');
                clearPressureForm();
                loadPressureHistory();
                
            } catch (error) {
                console.error('Erro ao salvar pressão:', error);
                alert('Erro ao salvar dados de pressão: ' + error.message);
            }
        }

        async function saveOsmosisDaily() {
            if (!currentUser) return;

            const conductivity = parseFloat(document.getElementById('condutividade').value);

            if (isNaN(conductivity)) {
                alert('Por favor, preencha o campo de condutividade com um valor numérico válido.');
                return;
            }

            const data = {
                conductivity: conductivity,
                conductivityStatus: calculateConductivityStatus(conductivity),
                lastSanitization: document.getElementById('ultima-sanitizacao').value,
                nextSanitization: document.getElementById('proxima-sanitizacao').value,
                lastCleaning: document.getElementById('ultima-higienizacao').value,
                nextCleaning: document.getElementById('proxima-higienizacao').value,
                lastCollection: document.getElementById('ultima-coleta').value,
                nextCollection: document.getElementById('proxima-coleta').value,
                hasAbnormality: document.querySelector('input[name="anormalidade"]:checked').value === 'sim',
                abnormalityReason: document.getElementById('motivo-anormalidade').value,
                lastFilterChange: {
                    fpp001: document.getElementById('ultima-fpp001').value,
                    fca001: document.getElementById('ultima-fca001').value,
                    drm001: document.getElementById('ultima-drm001').value,
                    drm002: document.getElementById('ultima-drm002').value
                },
                nextFilterChange: {
                    fpp001: document.getElementById('proxima-fpp001').value,
                    fca001: document.getElementById('proxima-fca001').value,
                    drm001: document.getElementById('proxima-drm001').value,
                    drm002: document.getElementById('proxima-drm002').value
                },
                notes: document.getElementById('osmosis-daily-notes').value,
                userId: currentUser.uid,
                userName: currentUser.name,
                createdAt: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('osmosis_daily').add(data);
                await addTraceability(
                    'Controle diário de osmose', 
                    `Condutividade: ${data.conductivity} µS/cm`
                );
                
                alert('Controle diário do sistema de osmose registrado com sucesso!');
                clearOsmosisDailyForm();
                loadOsmosisHistory();
                
            } catch (error) {
                console.error('Erro ao salvar osmose diária:', error);
                alert('Erro ao salvar dados de osmose diária: ' + error.message);
            }
        }

        async function saveOsmosisMaintenance() {
            if (!currentUser) return;
            
            const procedure = document.getElementById('procedimento').value;
            const maintenanceDate = document.getElementById('data-manutencao').value;

            if (!procedure || !maintenanceDate) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const data = {
                procedure: procedure,
                maintenanceDate: maintenanceDate,
                observations: document.getElementById('obs-manutencao').value,
                userId: currentUser.uid,
                userName: currentUser.name,
                createdAt: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('osmosis_maintenance').add(data);
                await addTraceability(
                    'Manutenção de osmose', 
                    `Procedimento: ${data.procedure.substring(0, 50)}...`
                );
                
                alert('Manutenção do sistema de osmose registrada com sucesso!');
                clearMaintenanceForm();
                loadMaintenanceHistory();
                
            } catch (error) {
                console.error('Erro ao salvar manutenção de osmose:', error);
                alert('Erro ao salvar dados de manutenção: ' + error.message);
            }
        }

        async function addRoom() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem adicionar salas.');
                return;
            }

            const code = document.getElementById('room-code').value;
            const name = document.getElementById('room-name').value;
            const responsible = document.getElementById('room-responsible').value;
            const tempMin = parseFloat(document.getElementById('temp-min-room').value);
            const tempMax = parseFloat(document.getElementById('temp-max-room').value);
            const humidityMin = parseFloat(document.getElementById('umid-min-room').value);
            const humidityMax = parseFloat(document.getElementById('umid-max-room').value);
            const pressureMin = parseInt(document.getElementById('pressure-value-min').value);

            if (!code || !name || !responsible || isNaN(tempMin) || isNaN(tempMax) || 
                isNaN(humidityMin) || isNaN(humidityMax) || isNaN(pressureMin)) {
                alert('Por favor, preencha todos os campos obrigatórios com valores válidos.');
                return;
            }

            const data = {
                code: code,
                name: name,
                type: document.getElementById('room-type').value,
                responsible: responsible,
                tempMin: tempMin,
                tempMax: tempMax,
                humidityMin: humidityMin,
                humidityMax: humidityMax,
                pressureMin: pressureMin,
                description: document.getElementById('room-description').value,
                status: 'active',
                createdAt: new Date(),
                createdBy: currentUser.uid,
                createdByName: currentUser.name
            };

            try {
                await db.collection('rooms').add(data);
                await addTraceability(
                    'Adição de sala', 
                    `${data.name} (${data.code}) adicionada`
                );
                
                alert('Sala adicionada com sucesso!');
                clearRoomForm();
                await loadRooms(); // Recarregar salas
                loadRoomsList(); // Recarregar lista
                
            } catch (error) {
                console.error('Erro ao adicionar sala:', error);
                alert('Erro ao adicionar sala: ' + error.message);
            }
        }

        // ========== FUNÇÕES DE EDIÇÃO E EXCLUSÃO ==========

        async function editTemperatureReading(docId) {
            try {
                const doc = await db.collection('temperature_readings').doc(docId).get();
                if (!doc.exists) {
                    alert('Registro não encontrado!');
                    return;
                }

                const data = doc.data();
                currentEditData = { collection: 'temperature_readings', id: docId, data: data };

                const modalContent = `
                    <div class="form-group">
                        <label for="edit-temp-min">Temperatura Mínima (°C):</label>
                        <input type="number" id="edit-temp-min" step="0.1" value="${data.tempMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-max">Temperatura Máxima (°C):</label>
                        <input type="number" id="edit-temp-max" step="0.1" value="${data.tempMax || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-atual">Temperatura Atual (°C):</label>
                        <input type="number" id="edit-temp-atual" step="0.1" value="${data.tempActual || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-min">Umidade Mínima (%):</label>
                        <input type="number" id="edit-umid-min" step="0.1" value="${data.humidityMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-max">Umidade Máxima (%):</label>
                        <input type="number" id="edit-umid-max" step="0.1" value="${data.humidityMax || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-atual">Umidade Atual (%):</label>
                        <input type="number" id="edit-umid-atual" step="0.1" value="${data.humidityActual || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-notes">Observações:</label>
                        <textarea id="edit-temp-notes" rows="3">${data.notes || ''}</textarea>
                    </div>
                `;

                document.getElementById('edit-modal-title').textContent = 'Editar Leitura de Temperatura';
                document.getElementById('edit-modal-content').innerHTML = modalContent;
                showEditModal();

            } catch (error) {
                console.error('Erro ao carregar dados para edição:', error);
                alert('Erro ao carregar dados para edição');
            }
        }

        async function editPressureReading(docId) {
            try {
                const doc = await db.collection('pressure_readings').doc(docId).get();
                if (!doc.exists) {
                    alert('Registro não encontrado!');
                    return;
                }

                const data = doc.data();
                currentEditData = { collection: 'pressure_readings', id: docId, data: data };

                const modalContent = `
                    <div class="form-group">
                        <label for="edit-pressure-value">Pressão (Pa):</label>
                        <input type="number" id="edit-pressure-value" step="1" value="${data.pressure || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-correcao-imediata">Correção Imediata:</label>
                        <textarea id="edit-correcao-imediata" rows="3">${data.immediateCorrection || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-pressure-notes">Observações:</label>
                        <textarea id="edit-pressure-notes" rows="3">${data.notes || ''}</textarea>
                    </div>
                `;

                document.getElementById('edit-modal-title').textContent = 'Editar Leitura de Pressão';
                document.getElementById('edit-modal-content').innerHTML = modalContent;
                showEditModal();

            } catch (error) {
                console.error('Erro ao carregar dados para edição:', error);
                alert('Erro ao carregar dados para edição');
            }
        }

        async function editRoom(docId) {
            try {
                const doc = await db.collection('rooms').doc(docId).get();
                if (!doc.exists) {
                    alert('Sala não encontrada!');
                    return;
                }

                const data = doc.data();
                currentEditData = { collection: 'rooms', id: docId, data: data };

                const modalContent = `
                    <div class="form-group">
                        <label for="edit-room-name">Nome da Sala:</label>
                        <input type="text" id="edit-room-name" value="${data.name || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-room-code">Código da Sala:</label>
                        <input type="text" id="edit-room-code" value="${data.code || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-room-type">Tipo de Sala:</label>
                        <select id="edit-room-type">
                            <option value="estoque" ${data.type === 'estoque' ? 'selected' : ''}>Estoque</option>
                            <option value="preparacao" ${data.type === 'preparacao' ? 'selected' : ''}>Preparação</option>
                            <option value="producao" ${data.type === 'producao' ? 'selected' : ''}>Produção</option>
                            <option value="embalagem" ${data.type === 'embalagem' ? 'selected' : ''}>Embalagem</option>
                            <option value="qualidade" ${data.type === 'qualidade' ? 'selected' : ''}>Controle de Qualidade</option>
                            <option value="outro" ${data.type === 'outro' ? 'selected' : ''}>Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-room-responsible">Responsável:</label>
                        <input type="text" id="edit-room-responsible" value="${data.responsible || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-min-room">Temperatura Mínima (°C):</label>
                        <input type="number" id="edit-temp-min-room" step="0.1" value="${data.tempMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-max-room">Temperatura Máxima (°C):</label>
                        <input type="number" id="edit-temp-max-room" step="0.1" value="${data.tempMax || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-min-room">Umidade Mínima (%):</label>
                        <input type="number" id="edit-umid-min-room" step="0.1" value="${data.humidityMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-max-room">Umidade Máxima (%):</label>
                        <input type="number" id="edit-umid-max-room" step="0.1" value="${data.humidityMax || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-pressure-value-min">Pressão Mínima (Pa):</label>
                        <input type="number" id="edit-pressure-value-min" value="${data.pressureMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-room-description">Descrição:</label>
                        <textarea id="edit-room-description" rows="3">${data.description || ''}</textarea>
                    </div>
                `;

                document.getElementById('edit-modal-title').textContent = 'Editar Sala';
                document.getElementById('edit-modal-content').innerHTML = modalContent;
                showEditModal();

            } catch (error) {
                console.error('Erro ao carregar dados para edição:', error);
                alert('Erro ao carregar dados para edição');
            }
        }

        async function saveEdit() {
            if (!currentEditData) return;

            try {
                let updateData = {};
                const room = rooms.find(r => r.id === currentEditData.data.roomId);

                switch(currentEditData.collection) {
                    case 'temperature_readings':
                        updateData = {
                            tempMin: parseFloat(document.getElementById('edit-temp-min').value),
                            tempMax: parseFloat(document.getElementById('edit-temp-max').value),
                            tempActual: parseFloat(document.getElementById('edit-temp-atual').value),
                            humidityMin: parseFloat(document.getElementById('edit-umid-min').value),
                            humidityMax: parseFloat(document.getElementById('edit-umid-max').value),
                            humidityActual: parseFloat(document.getElementById('edit-umid-atual').value),
                            notes: document.getElementById('edit-temp-notes').value,
                            status: calculateTemperatureStatus(
                                parseFloat(document.getElementById('edit-temp-atual').value),
                                parseFloat(document.getElementById('edit-umid-atual').value),
                                room?.tempMin,
                                room?.tempMax,
                                room?.humidityMin,
                                room?.humidityMax
                            ),
                            updatedAt: new Date(),
                            updatedBy: currentUser.uid,
                            updatedByName: currentUser.name
                        };
                        break;

                    case 'pressure_readings':
                        updateData = {
                            pressure: parseInt(document.getElementById('edit-pressure-value').value),
                            immediateCorrection: document.getElementById('edit-correcao-imediata').value,
                            notes: document.getElementById('edit-pressure-notes').value,
                            status: calculatePressureStatus(
                                parseInt(document.getElementById('edit-pressure-value').value),
                                room?.pressureMin
                            ),
                            updatedAt: new Date(),
                            updatedBy: currentUser.uid,
                            updatedByName: currentUser.name
                        };
                        break;

                    case 'rooms':
                        updateData = {
                            name: document.getElementById('edit-room-name').value,
                            code: document.getElementById('edit-room-code').value,
                            type: document.getElementById('edit-room-type').value,
                            responsible: document.getElementById('edit-room-responsible').value,
                            tempMin: parseFloat(document.getElementById('edit-temp-min-room').value),
                            tempMax: parseFloat(document.getElementById('edit-temp-max-room').value),
                            humidityMin: parseFloat(document.getElementById('edit-umid-min-room').value),
                            humidityMax: parseFloat(document.getElementById('edit-umid-max-room').value),
                            pressureMin: parseInt(document.getElementById('edit-pressure-value-min').value),
                            description: document.getElementById('edit-room-description').value,
                            updatedAt: new Date(),
                            updatedBy: currentUser.uid,
                            updatedByName: currentUser.name
                        };
                        break;
                }

                await db.collection(currentEditData.collection).doc(currentEditData.id).update(updateData);
                
                await addTraceability(
                    `Edição de ${currentEditData.collection.replace('_', ' ')}`, 
                    `Registro ${currentEditData.id} atualizado`
                );

                alert('Registro atualizado com sucesso!');
                hideEditModal();
                
                // Recarregar dados
                switch(currentEditData.collection) {
                    case 'temperature_readings':
                        loadTemperatureHistory();
                        break;
                    case 'pressure_readings':
                        loadPressureHistory();
                        break;
                    case 'rooms':
                        loadRoomsList();
                        loadRooms(); // Para atualizar os selects
                        break;
                }

            } catch (error) {
                console.error('Erro ao salvar edição:', error);
                alert('Erro ao salvar edição: ' + error.message);
            }
        }

        async function deleteRecord(collection, docId, confirmationMessage) {
            if (!confirm(confirmationMessage || 'Tem certeza que deseja excluir este registro?')) {
                return;
            }

            try {
                await db.collection(collection).doc(docId).delete();
                
                await addTraceability(
                    `Exclusão de ${collection.replace('_', ' ')}`, 
                    `Registro ${docId} excluído`
                );

                alert('Registro excluído com sucesso!');
                
                // Recarregar dados
                switch(collection) {
                    case 'temperature_readings':
                        loadTemperatureHistory();
                        break;
                    case 'pressure_readings':
                        loadPressureHistory();
                        break;
                    case 'rooms':
                        loadRoomsList();
                        loadRooms(); // Para atualizar os selects
                        break;
                    case 'osmosis_daily':
                        loadOsmosisHistory();
                        break;
                    case 'osmosis_maintenance':
                        loadMaintenanceHistory();
                        break;
                }

            } catch (error) {
                console.error('Erro ao excluir registro:', error);
                alert('Erro ao excluir registro: ' + error.message);
            }
        }

        // ========== GERENCIAMENTO DE USUÁRIOS ==========

        async function addUser() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem adicionar usuários.');
                return;
            }

            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;

            if (!name || !email || !password) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Validar formato do email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor, insira um email válido.');
                return;
            }

            // Validar senha
            if (password.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres.');
                return;
            }

            // Verificar se o email já existe no Firestore
            try {
                const existingUsers = await db.collection('users')
                    .where('email', '==', email)
                    .get();
                
                if (!existingUsers.empty) {
                    alert('Este email já está cadastrado no sistema.');
                    return;
                }
            } catch (error) {
                console.error('Erro ao verificar email:', error);
            }

            // Desabilitar botão durante o processo
            const addButton = document.getElementById('add-user-btn');
            const originalText = addButton.innerHTML;
            addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando usuário...';
            addButton.disabled = true;

            try {
                // Salvar o usuário atual antes de criar um novo
                const adminUser = auth.currentUser;
                
                // Criar usuário no Authentication usando Firebase Admin SDK (via Cloud Functions)
                // Em um ambiente real, você usaria uma Cloud Function para isso
                // Por enquanto, vamos apenas salvar no Firestore e o usuário terá que usar "Esqueci minha senha"
                
                // Salvar dados no Firestore
                const userData = {
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date(),
                    status: 'active',
                    createdBy: currentUser.uid,
                    createdByName: currentUser.name
                };

                // Adicionar um documento temporário
                const userRef = await db.collection('users_temp').add(userData);
                
                await addTraceability(
                    'Criação de usuário', 
                    `Usuário ${name} (${email}) criado como ${role}. Senha temporária: ${password}`
                );
                
                alert(`Usuário "${name}" criado com sucesso!\n\nEmail: ${email}\nSenha: ${password}\n\nO usuário deve usar a função "Esqueci minha senha" para definir sua senha.`);
                clearUserForm();
                
                // Recarregar lista de usuários
                loadUsersList();
                
            } catch (error) {
                console.error('Erro ao criar usuário:', error);
                alert('Erro ao criar usuário: ' + getAuthErrorMessage(error.code));
            } finally {
                // Restaurar botão
                addButton.innerHTML = originalText;
                addButton.disabled = false;
            }
        }

        async function loadUsersList() {
            try {
                const snapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const tbody = document.getElementById('users-list');
                const cardsContainer = document.getElementById('users-list-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usuário cadastrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum usuário cadastrado</div></div>';
                    return;
                }
                
                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allUsers.push({ id: doc.id, ...data });
                    const row = createUserRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createUserCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar lista de usuários:', error);
                document.getElementById('users-list').innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('users-list-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        function createUserRow(data, userId) {
            const row = document.createElement('tr');
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${data.name || '-'}</td>
                <td>${data.email || '-'}</td>
                <td>${data.role === 'admin' ? 'Administrador' : 'Usuário Normal'}</td>
                <td>${createdAt}</td>
                <td><span class="status ${data.status === 'active' ? 'status-normal' : 'status-critical'}">${data.status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editUser('${userId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${userId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    ${data.status === 'active' ? 
                        `<button class="btn btn-secondary btn-sm" onclick="deactivateUser('${userId}')">
                            <i class="fas fa-user-slash"></i>
                        </button>` :
                        `<button class="btn btn-success btn-sm" onclick="activateUser('${userId}')">
                            <i class="fas fa-user-check"></i>
                        </button>`
                    }
                </td>
            `;
            return row;
        }

        function createUserCard(data, userId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.name || '-'}</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Email:</span>
                            <span class="mobile-card-value">${data.email || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Tipo:</span>
                            <span class="mobile-card-value">${data.role === 'admin' ? 'Administrador' : 'Usuário Normal'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Criado em:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${data.status === 'active' ? 'status-normal' : 'status-critical'}">${data.status === 'active' ? 'Ativo' : 'Inativo'}</span></span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions">
                    <button class="btn btn-warning btn-sm" onclick="editUser('${userId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${userId}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    ${data.status === 'active' ? 
                        `<button class="btn btn-secondary btn-sm" onclick="deactivateUser('${userId}')">
                            <i class="fas fa-user-slash"></i> Desativar
                        </button>` :
                        `<button class="btn btn-success btn-sm" onclick="activateUser('${userId}')">
                            <i class="fas fa-user-check"></i> Ativar
                        </button>`
                    }
                </div>
            `;
            return card;
        }

        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const newName = prompt('Novo nome:', user.name);
            if (!newName) return;

            const newRole = prompt('Novo tipo (admin/user):', user.role);
            if (!newRole || !['admin', 'user'].includes(newRole)) {
                alert('Tipo inválido. Use "admin" ou "user".');
                return;
            }

            try {
                await db.collection('users').doc(userId).update({
                    name: newName,
                    role: newRole
                });

                await addTraceability(
                    'Edição de usuário', 
                    `Usuário ${user.email} atualizado: nome="${newName}", tipo="${newRole}"`
                );

                alert('Usuário atualizado com sucesso!');
                loadUsersList();
            } catch (error) {
                console.error('Erro ao editar usuário:', error);
                alert('Erro ao editar usuário');
            }
        }

        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Tem certeza que deseja excluir permanentemente o usuário ${user.name} (${user.email})?`)) {
                return;
            }

            try {
                // Deletar do Firestore
                await db.collection('users').doc(userId).delete();

                await addTraceability(
                    'Exclusão de usuário', 
                    `Usuário ${user.name} (${user.email}) excluído permanentemente`
                );

                alert('Usuário excluído com sucesso!');
                loadUsersList();
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                alert('Erro ao excluir usuário: ' + error.message);
            }
        }

        async function deactivateUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            try {
                await db.collection('users').doc(userId).update({
                    status: 'inactive'
                });

                await addTraceability(
                    'Desativação de usuário', 
                    `Usuário ${user.name} (${user.email}) desativado`
                );

                alert('Usuário desativado com sucesso!');
                loadUsersList();
            } catch (error) {
                console.error('Erro ao desativar usuário:', error);
                alert('Erro ao desativar usuário');
            }
        }

        async function activateUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            try {
                await db.collection('users').doc(userId).update({
                    status: 'active'
                });

                await addTraceability(
                    'Ativação de usuário', 
                    `Usuário ${user.name} (${user.email}) ativado`
                );

                alert('Usuário ativado com sucesso!');
                loadUsersList();
            } catch (error) {
                console.error('Erro ao ativar usuário:', error);
                alert('Erro ao ativar usuário');
            }
        }

        function clearUserForm() {
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = 'user';
        }

        // ========== FUNÇÕES PARA CARREGAR DADOS ==========

        async function loadTemperatureHistory() {
            try {
                const snapshot = await db.collection('temperature_readings')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('temp-history');
                const cardsContainer = document.getElementById('temp-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createTemperatureRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createTemperatureCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico de temperatura:', error);
                document.getElementById('temp-history').innerHTML = '<tr><td colspan="12" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('temp-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadPressureHistory() {
            try {
                const snapshot = await db.collection('pressure_readings')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('pressure-history');
                const cardsContainer = document.getElementById('pressure-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createPressureRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createPressureCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico de pressão:', error);
                document.getElementById('pressure-history').innerHTML = '<tr><td colspan="8" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('pressure-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadOsmosisHistory() {
            try {
                const snapshot = await db.collection('osmosis_daily')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('osmosis-history');
                const cardsContainer = document.getElementById('osmosis-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                osmosisDailyData = [];
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    osmosisDailyData.push(data);
                    const row = createOsmosisRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createOsmosisCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
                // Carregar cards detalhados
                loadOsmosisDetailedCards();
                
            } catch (error) {
                console.error('Erro ao carregar histórico de osmose:', error);
                document.getElementById('osmosis-history').innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('osmosis-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        function loadOsmosisDetailedCards() {
            const container = document.getElementById('osmosis-detailed-cards');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (osmosisDailyData.length === 0) {
                container.innerHTML = '<div class="card"><div class="card-body text-center">Nenhum registro de controle diário encontrado</div></div>';
                return;
            }
            
            osmosisDailyData.forEach(data => {
                const card = createOsmosisDetailedCard(data);
                container.appendChild(card);
            });
        }

        function createOsmosisDetailedCard(data) {
            const card = document.createElement('div');
            card.className = 'osmosis-card';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            const statusClass = `status-${data.conductivityStatus || 'normal'}`;
            
            card.innerHTML = `
                <div class="osmosis-card-header">
                    <div>
                        <div class="osmosis-card-title">Controle Diário de Osmose</div>
                        <div class="osmosis-card-field">
                            <span class="osmosis-card-label">Data/Hora:</span>
                            <span class="osmosis-card-value">${createdAt}</span>
                        </div>
                        <div class="osmosis-card-field">
                            <span class="osmosis-card-label">Operador:</span>
                            <span class="osmosis-card-value">${data.userName || '-'}</span>
                        </div>
                        <div class="osmosis-card-field">
                            <span class="osmosis-card-label">Status:</span>
                            <span class="osmosis-card-value"><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Condutividade:</span>
                        <span class="osmosis-card-value">${data.conductivity || '-'} µS/cm</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Sanitização/Downtime</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Última:</span>
                        <span class="osmosis-card-value">${data.lastSanitization || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Próxima:</span>
                        <span class="osmosis-card-value">${data.nextSanitization || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Higienização</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Última:</span>
                        <span class="osmosis-card-value">${data.lastCleaning || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Próxima:</span>
                        <span class="osmosis-card-value">${data.nextCleaning || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Coleta para Análise</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Última:</span>
                        <span class="osmosis-card-value">${data.lastCollection || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Próxima:</span>
                        <span class="osmosis-card-value">${data.nextCollection || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Anormalidade</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Apresenta:</span>
                        <span class="osmosis-card-value">${data.hasAbnormality ? 'Sim' : 'Não'}</span>
                    </div>
                    ${data.hasAbnormality ? `
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Motivo:</span>
                        <span class="osmosis-card-value">${data.abnormalityReason || '-'}</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Troca de Filtros - Última</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FPP-001:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.fpp001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FCA-001:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.fca001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-001:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.drm001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-002:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.drm002 || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Troca de Filtros - Próxima</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FPP-001:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.fpp001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FCA-001:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.fca001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-001:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.drm001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-002:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.drm002 || '-'}</span>
                    </div>
                </div>
                
                ${data.notes ? `
                <div class="osmosis-card-section">
                    <div class="section-title">Observações</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-value" style="text-align: left;">${data.notes}</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="osmosis-card-actions">
                    <button class="btn btn-primary btn-sm" onclick="exportOsmosisCardToPDF('${data.id}')">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
            `;
            
            return card;
        }

        async function loadMaintenanceHistory() {
            try {
                const snapshot = await db.collection('osmosis_maintenance')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('maintenance-history');
                const cardsContainer = document.getElementById('maintenance-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createMaintenanceRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createMaintenanceCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico de manutenções:', error);
                document.getElementById('maintenance-history').innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('maintenance-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadRoomsList() {
            try {
                const snapshot = await db.collection('rooms')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const tbody = document.getElementById('rooms-list');
                const cardsContainer = document.getElementById('rooms-list-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhuma sala cadastrada</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhuma sala cadastrada</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createRoomRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createRoomCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar lista de salas:', error);
                document.getElementById('rooms-list').innerHTML = '<tr><td colspan="9" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('rooms-list-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadTraceabilityLog() {
            try {
                let query = db.collection('traceability').orderBy('timestamp', 'desc');
                
                // Aplicar filtros
                const filterDate = document.getElementById('filter-date').value;
                const filterUser = document.getElementById('filter-user').value;
                const filterAction = document.getElementById('filter-action').value;
                
                if (filterDate) {
                    const startDate = new Date(filterDate);
                    const endDate = new Date(filterDate);
                    endDate.setDate(endDate.getDate() + 1);
                    
                    query = query.where('createdAt', '>=', startDate)
                                .where('createdAt', '<', endDate);
                }
                
                if (filterUser && filterUser !== 'all') {
                    query = query.where('userId', '==', filterUser);
                }
                
                if (filterAction && filterAction !== 'all') {
                    // Filtro por tipo de ação (implementação básica)
                    // Em uma implementação real, você teria um campo específico para tipo
                }
                
                const snapshot = await query.limit(100).get();
                
                const tbody = document.getElementById('traceability-log');
                const cardsContainer = document.getElementById('traceability-log-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                traceabilityData = [];
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    traceabilityData.push(data);
                    const row = createTraceabilityRow(data);
                    tbody.appendChild(row);
                    
                    const card = createTraceabilityCard(data);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar log de rastreabilidade:', error);
                document.getElementById('traceability-log').innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('traceability-log-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        // ========== FUNÇÕES PARA CRIAR LINHAS DE TABELA ==========

        function createTemperatureRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.roomName || '-'}</td>
                <td>${data.period || '-'}</td>
                <td>${data.tempMin || '-'}°C</td>
                <td>${data.tempMax || '-'}°C</td>
                <td>${data.tempActual || '-'}°C</td>
                <td>${data.humidityMin || '-'}%</td>
                <td>${data.humidityMax || '-'}%</td>
                <td>${data.humidityActual || '-'}%</td>
                <td><span class="status ${statusClass}">${getStatusText(data.status)}</span></td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editTemperatureReading('${docId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('temperature_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de temperatura?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createTemperatureCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.roomName || '-'} - ${data.period || '-'}</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Temperatura:</span>
                            <span class="mobile-card-value">${data.tempActual || '-'}°C (${data.tempMin || '-'} - ${data.tempMax || '-'})</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Umidade:</span>
                            <span class="mobile-card-value">${data.humidityActual || '-'}% (${data.humidityMin || '-'} - ${data.humidityMax || '-'})</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${getStatusText(data.status)}</span></span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editTemperatureReading('${docId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('temperature_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de temperatura?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createPressureRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.roomName || '-'}</td>
                <td>${data.period || '-'}</td>
                <td>${data.pressure || '-'} Pa</td>
                <td>${data.immediateCorrection || '-'}</td>
                <td><span class="status ${statusClass}">${getStatusText(data.status)}</span></td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editPressureReading('${docId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('pressure_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de pressão?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createPressureCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.roomName || '-'} - ${data.period || '-'}</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Pressão:</span>
                            <span class="mobile-card-value">${data.pressure || '-'} Pa</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Correção:</span>
                            <span class="mobile-card-value">${data.immediateCorrection || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${getStatusText(data.status)}</span></span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editPressureReading('${docId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('pressure_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de pressão?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createOsmosisRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = `status-${data.conductivityStatus || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.conductivity || '-'} µS/cm</td>
                <td><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></td>
                <td>${data.hasAbnormality ? 'Sim' : 'Não'}</td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_daily', '${docId}', 'Tem certeza que deseja excluir este registro de osmose?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createOsmosisCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = `status-${data.conductivityStatus || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">Controle de Osmose</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Condutividade:</span>
                            <span class="mobile-card-value">${data.conductivity || '-'} µS/cm</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Anormalidade:</span>
                            <span class="mobile-card-value">${data.hasAbnormality ? 'Sim' : 'Não'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_daily', '${docId}', 'Tem certeza que deseja excluir este registro de osmose?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createMaintenanceRow(data, docId) {
            const row = document.createElement('tr');
            const maintenanceDate = data.maintenanceDate ? 
                new Date(data.maintenanceDate).toLocaleDateString('pt-BR') : '-';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${maintenanceDate}</td>
                <td>${data.procedure || '-'}</td>
                <td>${data.observations || '-'}</td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_maintenance', '${docId}', 'Tem certeza que deseja excluir este registro de manutenção?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createMaintenanceCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const maintenanceDate = data.maintenanceDate ? 
                new Date(data.maintenanceDate).toLocaleDateString('pt-BR') : '-';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">Manutenção de Osmose</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data da Manutenção:</span>
                            <span class="mobile-card-value">${maintenanceDate}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Procedimento:</span>
                            <span class="mobile-card-value">${data.procedure || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Observações:</span>
                            <span class="mobile-card-value">${data.observations || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_maintenance', '${docId}', 'Tem certeza que deseja excluir este registro de manutenção?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createRoomRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = data.status === 'active' ? 'status-normal' : 'status-critical';
            const statusText = data.status === 'active' ? 'Ativa' : 'Inativa';
            
            row.innerHTML = `
                <td>${data.code || '-'}</td>
                <td>${data.name || '-'}</td>
                <td>${formatRoomType(data.type)}</td>
                <td>${data.responsible || '-'}</td>
                <td>${data.tempMin || '-'}°C - ${data.tempMax || '-'}°C</td>
                <td>${data.humidityMin || '-'}% - ${data.humidityMax || '-'}%</td>
                <td>${data.pressureMin || '-'} Pa</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editRoom('${docId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('rooms', '${docId}', 'Tem certeza que deseja excluir esta sala?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createRoomCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = data.status === 'active' ? 'status-normal' : 'status-critical';
            const statusText = data.status === 'active' ? 'Ativa' : 'Inativa';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.name || '-'} (${data.code || '-'})</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Tipo:</span>
                            <span class="mobile-card-value">${formatRoomType(data.type)}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Responsável:</span>
                            <span class="mobile-card-value">${data.responsible || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Temperatura:</span>
                            <span class="mobile-card-value">${data.tempMin || '-'}°C - ${data.tempMax || '-'}°C</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Umidade:</span>
                            <span class="mobile-card-value">${data.humidityMin || '-'}% - ${data.humidityMax || '-'}%</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Pressão Mínima:</span>
                            <span class="mobile-card-value">${data.pressureMin || '-'} Pa</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${statusText}</span></span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions">
                    <button class="btn btn-primary btn-sm" onclick="editRoom('${docId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('rooms', '${docId}', 'Tem certeza que deseja excluir esta sala?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createTraceabilityRow(data) {
            const row = document.createElement('tr');
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.userName || '-'}</td>
                <td>${data.action || '-'}</td>
                <td>${data.details || '-'}</td>
                <td>${data.userIp || '-'}</td>
            `;
            return row;
        }

        function createTraceabilityCard(data) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.action || '-'}</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Usuário:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Detalhes:</span>
                            <span class="mobile-card-value">${data.details || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">IP:</span>
                            <span class="mobile-card-value">${data.userIp || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // ========== FUNÇÕES AUXILIARES ==========

        function calculateTemperatureStatus(temperature, humidity, tempMin, tempMax, humidityMin, humidityMax) {
            if (!tempMin || !tempMax || !humidityMin || !humidityMax) {
                return 'normal'; // Fallback se não houver parâmetros definidos
            }

            const tempInRange = temperature >= tempMin && temperature <= tempMax;
            const humidityInRange = humidity >= humidityMin && humidity <= humidityMax;

            if (tempInRange && humidityInRange) {
                return 'normal';
            } else if ((temperature >= tempMin - 1 && temperature <= tempMax + 1) || 
                       (humidity >= humidityMin - 5 && humidity <= humidityMax + 5)) {
                return 'alert';
            } else {
                return 'critical';
            }
        }

        function calculatePressureStatus(pressure, minPressure) {
            if (!minPressure) return 'normal'; // Fallback

            if (pressure >= minPressure) {
                return 'normal';
            } else if (pressure >= minPressure - 2) {
                return 'alert';
            } else {
                return 'critical';
            }
        }

        function calculateConductivityStatus(conductivity) {
            if (conductivity === undefined || conductivity === null) return 'normal';
            
            if (conductivity < 1.0) {
                return 'normal';
            } else if (conductivity >= 1.0 && conductivity <= 1.2) {
                return 'alert';
            } else {
                return 'critical';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'normal': 'Normal',
                'alert': 'Alerta', 
                'critical': 'Crítico'
            };
            return statusMap[status] || status;
        }

        function formatRoomType(type) {
            const types = {
                'estoque': 'Estoque',
                'preparacao': 'Preparação',
                'producao': 'Produção',
                'embalagem': 'Embalagem',
                'qualidade': 'Controle de Qualidade',
                'outro': 'Outro'
            };
            return types[type] || type;
        }

        // Função auxiliar para adicionar rastreabilidade
        async function addTraceability(action, details) {
            try {
                await db.collection('traceability').add({
                    action: action,
                    details: details,
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    userIp: await getUserIP(),
                    createdAt: new Date(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                // Recarregar o log de rastreabilidade
                if (currentUser.role === 'admin') {
                    loadTraceabilityLog();
                }
            } catch (error) {
                console.error('Erro ao registrar rastreabilidade:', error);
            }
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'IP não disponível';
            }
        }

        function getAuthErrorMessage(errorCode) {
            console.log('Código de erro:', errorCode);
            
            const messages = {
                'auth/invalid-email': 'Email inválido',
                'auth/user-disabled': 'Usuário desativado',
                'auth/user-not-found': 'Usuário não encontrado',
                'auth/wrong-password': 'Senha incorreta',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
                'auth/internal-error': 'Erro interno do servidor'
            };
            
            return messages[errorCode] || `Erro desconhecido: ${errorCode}`;
        }

        // Funções para limpar formulários
        function clearTemperatureForm() {
            document.getElementById('temp-min').value = '';
            document.getElementById('temp-max').value = '';
            document.getElementById('temp-atual').value = '';
            document.getElementById('umid-min').value = '';
            document.getElementById('umid-max').value = '';
            document.getElementById('umid-atual').value = '';
            document.getElementById('temp-notes').value = '';
        }

        function clearPressureForm() {
            document.getElementById('pressure-value').value = '';
            document.getElementById('correcao-imediata').value = '';
            document.getElementById('pressure-notes').value = '';
        }

        function clearOsmosisDailyForm() {
            document.getElementById('condutividade').value = '';
            document.getElementById('ultima-sanitizacao').value = '';
            document.getElementById('proxima-sanitizacao').value = '';
            document.getElementById('ultima-higienizacao').value = '';
            document.getElementById('proxima-higienizacao').value = '';
            document.getElementById('ultima-coleta').value = '';
            document.getElementById('proxima-coleta').value = '';
            document.getElementById('anormalidade-nao').checked = true;
            document.getElementById('anormalidade-detalhes').style.display = 'none';
            document.getElementById('motivo-anormalidade').value = '';
            document.getElementById('ultima-fpp001').value = '';
            document.getElementById('ultima-fca001').value = '';
            document.getElementById('ultima-drm001').value = '';
            document.getElementById('ultima-drm002').value = '';
            document.getElementById('proxima-fpp001').value = '';
            document.getElementById('proxima-fca001').value = '';
            document.getElementById('proxima-drm001').value = '';
            document.getElementById('proxima-drm002').value = '';
            document.getElementById('osmosis-daily-notes').value = '';
        }

        function clearMaintenanceForm() {
            document.getElementById('procedimento').value = '';
            document.getElementById('data-manutencao').value = '';
            document.getElementById('obs-manutencao').value = '';
        }

        function clearRoomForm() {
            document.getElementById('room-name').value = '';
            document.getElementById('room-code').value = '';
            document.getElementById('room-type').value = 'estoque';
            document.getElementById('room-responsible').value = '';
            document.getElementById('temp-min-room').value = '18.0';
            document.getElementById('temp-max-room').value = '26.0';
            document.getElementById('umid-min-room').value = '40.0';
            document.getElementById('umid-max-room').value = '60.0';
            document.getElementById('pressure-value-min').value = '5';
            document.getElementById('room-description').value = '';
        }

        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }

        function showEditModal() {
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function hideEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditData = null;
        }

        // Atualizar hora atual
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                `Data: ${now.toLocaleDateString('pt-BR')} Hora: ${now.toLocaleTimeString('pt-BR')}`;
        }

        // ========== FUNÇÕES DE EXPORTAÇÃO PDF ==========

        async function exportTraceabilityToPDF() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text('Relatório Completo de Rastreabilidade', 14, 15);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 14, 22);
            doc.text(`Gerado por: ${currentUser.name}`, 14, 28);
            
            // Informações do filtro
            const filterDate = document.getElementById('filter-date').value;
            const filterUser = document.getElementById('filter-user').value;
            const filterAction = document.getElementById('filter-action').value;
            
            let filterInfo = 'Filtros aplicados: ';
            if (filterDate) filterInfo += `Data: ${filterDate} `;
            if (filterUser && filterUser !== 'all') filterInfo += `Usuário: ${filterUser} `;
            if (filterAction && filterAction !== 'all') filterInfo += `Ação: ${filterAction} `;
            if (filterInfo === 'Filtros aplicados: ') filterInfo = 'Todos os registros (sem filtros)';
            
            doc.text(filterInfo, 14, 35);
            
            try {
                const headers = [['Data/Hora', 'Usuário', 'Ação', 'Detalhes', 'IP']];
                const data = [];
                
                // Usar dados já carregados ou carregar todos se necessário
                let recordsToExport = traceabilityData;
                
                if (recordsToExport.length === 0) {
                    // Carregar todos os registros se não houver filtro
                    const snapshot = await db.collection('traceability')
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    recordsToExport = [];
                    snapshot.forEach(doc => {
                        recordsToExport.push({ id: doc.id, ...doc.data() });
                    });
                }
                
                recordsToExport.forEach(item => {
                    const date = item.createdAt ? 
                        new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                    data.push([
                        date,
                        item.userName || '-',
                        item.action || '-',
                        item.details || '-',
                        item.userIp || '-'
                    ]);
                });
                
                // Generate table
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: 45,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] }
                });
                
                // Save the PDF
                doc.save(`relatorio_rastreabilidade_completo_${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                console.error('Erro ao gerar PDF de rastreabilidade:', error);
                alert('Erro ao gerar relatório PDF de rastreabilidade');
            }
        }

        function exportOsmosisCardToPDF(cardId) {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            const data = osmosisDailyData.find(item => item.id === cardId);
            if (!data) {
                alert('Dados não encontrados para exportação.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurações da página
            const pageWidth = doc.internal.pageSize.width;
            const margin = 14;
            let yPosition = margin;
            
            // Header
            doc.setFontSize(16);
            doc.text('Relatório de Controle Diário - Sistema de Osmose', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.text(`Data do Registro: ${new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR')}`, margin, yPosition);
            yPosition += 5;
            doc.text(`Operador: ${data.userName || '-'}`, margin, yPosition);
            yPosition += 5;
            doc.text(`Status: ${getStatusText(data.conductivityStatus)}`, margin, yPosition);
            yPosition += 10;
            
            // Linha divisória
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            // Condutividade
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('1. Condutividade da Água Purificada', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Resultado: ${data.conductivity || '-'} µS/cm`, margin + 5, yPosition);
            yPosition += 10;
            
            // Sanitização
            doc.setFont(undefined, 'bold');
            doc.text('2. Sanitização do Sistema', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Última sanitização: ${data.lastSanitization || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`Próxima sanitização: ${data.nextSanitization || '-'}`, margin + 5, yPosition);
            yPosition += 10;
            
            // Higienização
            doc.setFont(undefined, 'bold');
            doc.text('3. Higienização', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Última higienização: ${data.lastCleaning || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`Próxima higienização: ${data.nextCleaning || '-'}`, margin + 5, yPosition);
            yPosition += 10;
            
            // Coleta
            doc.setFont(undefined, 'bold');
            doc.text('4. Coleta de Água para Análise', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Última coleta: ${data.lastCollection || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`Próxima coleta: ${data.nextCollection || '-'}`, margin + 5, yPosition);
            yPosition += 10;
            
            // Anormalidade
            doc.setFont(undefined, 'bold');
            doc.text('5. Anormalidade no Funcionamento', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Apresenta anormalidade: ${data.hasAbnormality ? 'Sim' : 'Não'}`, margin + 5, yPosition);
            yPosition += 5;
            
            if (data.hasAbnormality && data.abnormalityReason) {
                doc.text(`Motivo: ${data.abnormalityReason}`, margin + 5, yPosition);
                yPosition += 10;
            } else {
                yPosition += 5;
            }
            
            // Troca de Filtros - Última
            doc.setFont(undefined, 'bold');
            doc.text('6. Troca de Filtros - Última', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            const lastFilters = data.lastFilterChange || {};
            doc.text(`FPP-001: ${lastFilters.fpp001 || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`FCA-001: ${lastFilters.fca001 || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`DRM-001: ${lastFilters.drm001 || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`DRM-002: ${lastFilters.drm002 || '-'}`, margin + 5, yPosition);
            yPosition += 10;
            
            // Troca de Filtros - Próxima
            doc.setFont(undefined, 'bold');
            doc.text('7. Troca de Filtros - Próxima', margin, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            const nextFilters = data.nextFilterChange || {};
            doc.text(`FPP-001: ${nextFilters.fpp001 || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`FCA-001: ${nextFilters.fca001 || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`DRM-001: ${nextFilters.drm001 || '-'}`, margin + 5, yPosition);
            yPosition += 5;
            doc.text(`DRM-002: ${nextFilters.drm002 || '-'}`, margin + 5, yPosition);
            yPosition += 10;
            
            // Observações
            if (data.notes) {
                doc.setFont(undefined, 'bold');
                doc.text('8. Observações', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                const splitNotes = doc.splitTextToSize(data.notes, pageWidth - margin * 2);
                doc.text(splitNotes, margin + 5, yPosition);
            }
            
            // Footer
            const footerY = doc.internal.pageSize.height - 10;
            doc.setFontSize(8);
            doc.text(`Relatório gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, footerY);
            doc.text(`Página 1 de 1`, pageWidth - margin - 20, footerY, { align: 'right' });
            
            // Save the PDF
            doc.save(`controle_osmose_${new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toISOString().slice(0, 10)}.pdf`);
        }

        async function exportAllOsmosisCardsToPDF() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            if (osmosisDailyData.length === 0) {
                alert('Nenhum registro de controle diário encontrado para exportação.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            for (let i = 0; i < osmosisDailyData.length; i++) {
                const data = osmosisDailyData[i];
                
                // Adicionar nova página para cada card (exceto a primeira)
                if (i > 0) {
                    doc.addPage();
                }
                
                // Configurações da página
                const pageWidth = doc.internal.pageSize.width;
                const margin = 14;
                let yPosition = margin;
                
                // Header
                doc.setFontSize(16);
                doc.text('Relatório de Controle Diário - Sistema de Osmose', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.text(`Data do Registro: ${new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR')}`, margin, yPosition);
                yPosition += 5;
                doc.text(`Operador: ${data.userName || '-'}`, margin, yPosition);
                yPosition += 5;
                doc.text(`Status: ${getStatusText(data.conductivityStatus)}`, margin, yPosition);
                yPosition += 10;
                
                // Linha divisória
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Condutividade
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('1. Condutividade da Água Purificada', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Resultado: ${data.conductivity || '-'} µS/cm`, margin + 5, yPosition);
                yPosition += 10;
                
                // Sanitização
                doc.setFont(undefined, 'bold');
                doc.text('2. Sanitização do Sistema', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Última sanitização: ${data.lastSanitization || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Próxima sanitização: ${data.nextSanitization || '-'}`, margin + 5, yPosition);
                yPosition += 10;
                
                // Higienização
                doc.setFont(undefined, 'bold');
                doc.text('3. Higienização', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Última higienização: ${data.lastCleaning || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Próxima higienização: ${data.nextCleaning || '-'}`, margin + 5, yPosition);
                yPosition += 10;
                
                // Coleta
                doc.setFont(undefined, 'bold');
                doc.text('4. Coleta de Água para Análise', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Última coleta: ${data.lastCollection || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Próxima coleta: ${data.nextCollection || '-'}`, margin + 5, yPosition);
                yPosition += 10;
                
                // Anormalidade
                doc.setFont(undefined, 'bold');
                doc.text('5. Anormalidade no Funcionamento', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Apresenta anormalidade: ${data.hasAbnormality ? 'Sim' : 'Não'}`, margin + 5, yPosition);
                yPosition += 5;
                
                if (data.hasAbnormality && data.abnormalityReason) {
                    doc.text(`Motivo: ${data.abnormalityReason}`, margin + 5, yPosition);
                    yPosition += 10;
                } else {
                    yPosition += 5;
                }
                
                // Troca de Filtros - Última
                doc.setFont(undefined, 'bold');
                doc.text('6. Troca de Filtros - Última', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                const lastFilters = data.lastFilterChange || {};
                doc.text(`FPP-001: ${lastFilters.fpp001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`FCA-001: ${lastFilters.fca001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-001: ${lastFilters.drm001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-002: ${lastFilters.drm002 || '-'}`, margin + 5, yPosition);
                yPosition += 10;
                
                // Troca de Filtros - Próxima
                doc.setFont(undefined, 'bold');
                doc.text('7. Troca de Filtros - Próxima', margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                const nextFilters = data.nextFilterChange || {};
                doc.text(`FPP-001: ${nextFilters.fpp001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`FCA-001: ${nextFilters.fca001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-001: ${nextFilters.drm001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-002: ${nextFilters.drm002 || '-'}`, margin + 5, yPosition);
                yPosition += 10;
                
                // Observações
                if (data.notes) {
                    doc.setFont(undefined, 'bold');
                    doc.text('8. Observações', margin, yPosition);
                    yPosition += 7;
                    
                    doc.setFont(undefined, 'normal');
                    const splitNotes = doc.splitTextToSize(data.notes, pageWidth - margin * 2);
                    doc.text(splitNotes, margin + 5, yPosition);
                }
                
                // Footer para cada página
                const footerY = doc.internal.pageSize.height - 10;
                doc.setFontSize(8);
                doc.text(`Relatório gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, footerY);
                doc.text(`Página ${i + 1} de ${osmosisDailyData.length}`, pageWidth - margin - 20, footerY, { align: 'right' });
            }
            
            // Save the PDF
            doc.save(`controles_osmose_completo_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // Funções de exportação PDF existentes
        async function exportToPDF(type) {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text(`Relatório de ${getReportTitle(type)}`, 14, 15);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, 22);
            doc.text(`Gerado por: ${currentUser.name}`, 14, 28);
            
            try {
                let headers = [];
                let data = [];
                
                switch(type) {
                    case 'temperature':
                        headers = [['Data/Hora', 'Sala', 'Período', 'Temp. Mín', 'Temp. Máx', 'Temp. Atual', 'Umid. Mín', 'Umid. Máx', 'Umid. Atual', 'Status']];
                        const tempSnapshot = await db.collection('temperature_readings')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        tempSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                item.roomName || '-',
                                item.period || '-',
                                `${item.tempMin || '-'}°C`,
                                `${item.tempMax || '-'}°C`,
                                `${item.tempActual || '-'}°C`,
                                `${item.humidityMin || '-'}%`,
                                `${item.humidityMax || '-'}%`,
                                `${item.humidityActual || '-'}%`,
                                getStatusText(item.status)
                            ]);
                        });
                        break;
                        
                    case 'pressure':
                        headers = [['Data/Hora', 'Sala', 'Período', 'Pressão (Pa)', 'Correção', 'Status']];
                        const pressureSnapshot = await db.collection('pressure_readings')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        pressureSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                item.roomName || '-',
                                item.period || '-',
                                item.pressure || '-',
                                item.immediateCorrection || '-',
                                getStatusText(item.status)
                            ]);
                        });
                        break;
                        
                    case 'osmosis':
                        headers = [['Data/Hora', 'Condutividade (µS/cm)', 'Status', 'Anormalidade', 'Operador']];
                        const osmosisSnapshot = await db.collection('osmosis_daily')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        osmosisSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                `${item.conductivity || '-'} µS/cm`,
                                getStatusText(item.conductivityStatus),
                                item.hasAbnormality ? 'Sim' : 'Não',
                                item.userName || '-'
                            ]);
                        });
                        break;

                    case 'maintenance':
                        headers = [['Data', 'Procedimento', 'Observações', 'Operador']];
                        const maintenanceSnapshot = await db.collection('osmosis_maintenance')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        maintenanceSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.maintenanceDate ? 
                                new Date(item.maintenanceDate).toLocaleDateString('pt-BR') : '-';
                            data.push([
                                date,
                                item.procedure || '-',
                                item.observations || '-',
                                item.userName || '-'
                            ]);
                        });
                        break;
                        
                    case 'rooms':
                        headers = [['Código', 'Nome', 'Tipo', 'Responsável', 'Temp. Min-Max', 'Umid. Min-Max', 'Pressão Mínima', 'Status']];
                        const roomsSnapshot = await db.collection('rooms').get();
                        
                        roomsSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            data.push([
                                item.code || '-',
                                item.name || '-',
                                formatRoomType(item.type),
                                item.responsible || '-',
                                `${item.tempMin || '-'}°C - ${item.tempMax || '-'}°C`,
                                `${item.humidityMin || '-'}% - ${item.humidityMax || '-'}%`,
                                `${item.pressureMin || '-'} Pa`,
                                item.status === 'active' ? 'Ativa' : 'Inativa'
                            ]);
                        });
                        break;

                    case 'users':
                        headers = [['Nome', 'Email', 'Tipo', 'Data de Criação', 'Status']];
                        const usersSnapshot = await db.collection('users').get();
                        
                        usersSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleDateString('pt-BR') : '-';
                            data.push([
                                item.name || '-',
                                item.email || '-',
                                item.role === 'admin' ? 'Administrador' : 'Usuário Normal',
                                date,
                                item.status === 'active' ? 'Ativo' : 'Inativo'
                            ]);
                        });
                        break;

                    case 'traceability':
                        headers = [['Data/Hora', 'Usuário', 'Ação', 'Detalhes', 'IP']];
                        const traceabilitySnapshot = await db.collection('traceability')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        traceabilitySnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                item.userName || '-',
                                item.action || '-',
                                item.details || '-',
                                item.userIp || '-'
                            ]);
                        });
                        break;
                }
                
                // Generate table
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: 35,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] }
                });
                
                // Save the PDF
                doc.save(`relatorio_${type}_${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar relatório PDF');
            }
        }

        function generateReport() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem gerar relatórios personalizados.');
                return;
            }
            
            const reportType = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const format = document.getElementById('report-format').value;
            
            if (format === 'pdf') {
                exportToPDF(reportType);
            } else {
                alert('Relatório CSV gerado com sucesso! (Funcionalidade de demonstração)');
            }
        }

        function getReportTitle(type) {
            const titles = {
                'temperature': 'Temperatura e Umidade',
                'pressure': 'Pressão',
                'osmosis': 'Sistema de Osmose',
                'rooms': 'Salas',
                'users': 'Usuários',
                'traceability': 'Rastreabilidade',
                'maintenance': 'Manutenções de Osmose'
            };
            return titles[type] || type;
        }

        // Criar usuário admin automaticamente se não existir
        async function createAdminUserIfNotExists() {
            try {
                const usersSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .limit(1)
                    .get();

                if (usersSnapshot.empty) {
                    // Tentar criar admin
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword('admin@labmonitor.com', '123456');
                        const adminData = {
                            name: 'Administrador',
                            email: 'admin@labmonitor.com',
                            role: 'admin',
                            createdAt: new Date(),
                            status: 'active'
                        };
                        await db.collection('users').doc(userCredential.user.uid).set(adminData);
                        console.log('Usuário admin criado automaticamente');
                    } catch (error) {
                        console.log('Admin já existe ou erro ao criar:', error);
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar admin:', error);
            }
        }

        // Executar na inicialização
        createAdminUserIfNotExists();
    </script>
</body>
</html>