<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanroom DataLog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    // Configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE",
    authDomain: "sistema-monitoramento-anvisa.firebaseapp.com",
    projectId: "sistema-monitoramento-anvisa",
    storageBucket: "sistema-monitoramento-anvisa.firebasestorage.app",
    messagingSenderId: "551458347466",
    appId: "1:551458347466:web:541f0b0f77e4faa67c5733"
};

// Inicializar Firebase APENAS uma vez
let app;
let auth;
let db;

try {
    console.log('=== INICIALIZANDO FIREBASE ===');
    
    // Verificar se já existe uma app inicializada
    if (!firebase.apps.length) {
        app = firebase.initializeApp(firebaseConfig);
        console.log('✅ Firebase App inicializado:', app.name);
    } else {
        app = firebase.app();
        console.log('✅ Firebase App já inicializado:', app.name);
    }
    
    // Inicializar serviços
    auth = firebase.auth();
    db = firebase.firestore();
    
    console.log('✅ Serviços Firebase inicializados');
    console.log('- Auth:', auth ? 'OK' : 'FALHA');
    console.log('- Firestore:', db ? 'OK' : 'FALHA');
    
} catch (error) {
    console.error('❌ ERRO CRÍTICO ao inicializar Firebase:', error);
    alert('Erro ao inicializar sistema. Recarregue a página ou contate o administrador.');
}
    </script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            font-size: 14px;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        

        /* Estilos para Modais Personalizados */
.custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 3000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.custom-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    animation: slideUp 0.3s;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.custom-modal-header {
    padding: 20px 25px;
    background: linear-gradient(135deg, var(--primary) 0%, #1a2530 100%);
    color: white;
    display: flex;
    align-items: center;
    gap: 15px;
}

.custom-modal-header i {
    font-size: 28px;
}

.custom-modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.custom-modal-body {
    padding: 25px;
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    max-height: 60vh;
    overflow-y: auto;
}

.custom-modal-body p {
    margin: 0;
}

.custom-modal-footer {
    padding: 20px 25px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* Tipos de modais */
.custom-modal.success .custom-modal-header {
    background: linear-gradient(135deg, var(--success) 0%, #1e8449 100%);
}

.custom-modal.warning .custom-modal-header {
    background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%);
}

.custom-modal.error .custom-modal-header {
    background: linear-gradient(135deg, var(--danger) 0%, #b03a2e 100%);
}

.custom-modal.info .custom-modal-header {
    background: linear-gradient(135deg, var(--secondary) 0%, #21618c 100%);
}
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--primary);
            color: white;
            transition: all 0.3s;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 20px;
            background-color: rgba(0,0,0,0.2);
            text-align: center;
            position: sticky;
            top: 0;
            background-color: var(--primary);
        }
        
        .sidebar-menu {
            padding: 15px 0;
        }
        
        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .menu-item.active {
            background-color: var(--secondary);
            border-left: 4px solid white;
        }
        
        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            margin-left: 250px;
            width: calc(100% - 250px);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .user-role {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: var(--success);
            color: white;
            margin-left: 10px;
        }
        
        .user-role.admin {
            background-color: var(--warning);
        }
        
        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }

        .btn-ok {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* Animações para notificações */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(-20px);
    }
}

@keyframes highlight {
    0% {
        background-color: #fff3cd;
    }
    50% {
        background-color: #ffeaa7;
    }
    100% {
        background-color: #fff3cd;
    }
}

/* Efeito de notificação nova */
.notification-item.new-notification {
    animation: highlight 2s ease-in-out;
}

/* Scrollbar personalizada para lista de notificações */
.notification-list::-webkit-scrollbar {
    width: 8px;
}

.notification-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.notification-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Botão de notificações com estados */
#notification-btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: visible;
}

#notification-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#notification-btn.has-notifications {
    animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
    0% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
    }
}

/* Ícone de sino animado */
#notification-btn i.fa-bell {
    transition: transform 0.3s;
}

#notification-btn:hover i.fa-bell {
    transform: rotate(15deg);
}

#notification-btn.has-notifications i.fa-bell {
    animation: ring 0.5s ease-in-out;
}

@keyframes ring {
    0% { transform: rotate(0); }
    25% { transform: rotate(15deg); }
    50% { transform: rotate(-15deg); }
    75% { transform: rotate(10deg); }
    100% { transform: rotate(0); }
}
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Status indicators */
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-normal {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-alert {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-critical {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Page Content */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Login Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* Animação para o contador de notificações */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
    }
    70% {
        transform: scale(1.1);
        box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
    }
}

/* Estilo adicional para o modal de notificações */
.notification-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 4px;
    margin-bottom: 5px;
}

.notification-item.unread {
    background-color: #f0f8ff;
    border-left: 4px solid #3498db;
}

.notification-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.notification-type {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-right: 8px;
    text-transform: uppercase;
}

.notification-type.alert {
    background-color: #f39c12;
    color: white;
}

.notification-type.critical {
    background-color: #e74c3c;
    color: white;
}
        
        .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    width: 30%;
}
        
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
        }
        
        /* Mobile Cards */
        .mobile-cards {
            display: none;
        }
        
        .mobile-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .mobile-card-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .mobile-card-field {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .mobile-card-label {
            font-weight: 500;
            color: var(--dark);
        }
        
        .mobile-card-value {
            color: var(--gray);
        }
        
        .mobile-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        /* Novos estilos para cards de osmose */
        .osmosis-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .osmosis-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .osmosis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .osmosis-card-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .osmosis-card-field {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .osmosis-card-label {
            font-weight: 500;
            color: var(--dark);
            min-width: 120px;
        }
        
        .osmosis-card-value {
            color: var(--gray);
            flex: 1;
            text-align: right;
        }
        
        .osmosis-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .osmosis-card-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Notification Styles */
            #notification-count {
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: var(--danger);
                color: white;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                font-size: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .notification-item {
                padding: 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: all 0.2s;
            }

            .notification-item:hover {
                background-color: #f8f9fa;
            }

            .notification-item.unread {
                background-color: #e8f4fc;
                border-left: 4px solid var(--secondary);
            }

            .notification-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 5px;
            }

            .notification-title {
                font-weight: 600;
                color: var(--primary);
            }

            .notification-time {
                font-size: 11px;
                color: var(--gray);
            }

            .notification-message {
                font-size: 13px;
                color: var(--dark);
                margin-bottom: 5px;
            }

            .notification-type {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: 500;
            }

            .notification-type.alert {
                background-color: #fff3cd;
                color: #856404;
            }

            .notification-type.critical {
                background-color: #f8d7da;
                color: #721c24;
            }

            .notification-type.info {
                background-color: #d1ecf1;
                color: #0c5460;
            }

            /* Animação para o contador de notificações */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
    }
    70% {
        transform: scale(1.1);
        box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
    }
}

/* Estilo para notificações críticas */
.notification-critical {
    border-left: 4px solid #e74c3c !important;
    background-color: #ffeaea !important;
}

.notification-critical .notification-type {
    background-color: #e74c3c !important;
    color: white !important;
}

/* Estilo para notificações de alerta */
.notification-alert {
    border-left: 4px solid #f39c12 !important;
    background-color: #fff8e1 !important;
}

.notification-alert .notification-type {
    background-color: #f39c12 !important;
    color: white !important;
}

/* Estilo para notificações de informação */
.notification-info {
    border-left: 4px solid #3498db !important;
    background-color: #e8f4fc !important;
}

.notification-info .notification-type {
    background-color: #3498db !important;
    color: white !important;
}

/* Modal de notificações melhorado */
.notification-modal-content {
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
}

.notification-list {
    max-height: 60vh;
    overflow-y: auto;
    padding: 10px;
}

.notification-item {
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 6px;
    border: 1px solid #eee;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.notification-item.unread {
    font-weight: 600;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.notification-title {
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
    flex: 1;
}

.notification-time {
    font-size: 11px;
    color: #95a5a6;
    white-space: nowrap;
    margin-left: 10px;
}

.notification-message {
    font-size: 13px;
    color: #34495e;
    line-height: 1.4;
    margin-bottom: 8px;
}

.notification-type {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-right: 8px;
    text-transform: uppercase;
}

.notification-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.empty-notifications {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
}

.empty-notifications i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
            
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                z-index: 1000;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }
            
            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding: 10px 0;
            }
            
            .menu-item {
                flex: 1;
                min-width: 120px;
                justify-content: center;
                border-left: none;
                border-top: 4px solid transparent;
                padding: 12px 10px;
                font-size: 12px;
                flex-direction: column;
                text-align: center;
            }
            
            .menu-item i {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 16px;
            }
            
            .menu-item.active {
                border-left: none;
                border-top: 4px solid white;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px 0;
            }
            
            .user-info {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .card-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            table {
                display: none;
            }
            
            .mobile-cards {
                display: block;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            
            .btn-sm {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .osmosis-cards-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                padding: 10px;
            }
            
            .sidebar-header h2 {
                font-size: 18px;
            }
            
            .sidebar-header p {
                font-size: 12px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
            }
            
            .user-role {
                font-size: 10px;
                padding: 2px 6px;
            }
        }
        
        /* Hidden elements for non-admin users */
        .admin-only {
            display: none;
        }
        
        .user-admin .admin-only {
            display: block;
        }
        
        .user-admin .admin-only-inline {
            display: inline-block;
        }
        
        /* Edit Modal */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .edit-modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .edit-modal-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-title">Login do Sistema</div>
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label for="login-password">Senha:</label>
                <input type="password" id="login-password" placeholder="Sua senha">
            </div>
            <div id="login-error" style="color: red; margin-bottom: 15px; display: none;"></div>
            <button class="btn btn-primary" id="login-btn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div style="margin-top: 15px; text-align: center; font-size: 12px; color: #666;">
                <!-- Informações adicionais podem ser adicionadas aqui -->
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="edit-modal" id="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-title" id="edit-modal-title">Editar Registro</div>
            <div id="edit-modal-content">
                <!-- Conteúdo dinâmico será inserido aqui -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" id="cancel-edit-btn">Cancelar</button>
                <button class="btn btn-primary" id="save-edit-btn">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="edit-modal" id="notification-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-title">
                <i class="fas fa-bell"></i> Notificações do Sistema
                <button class="btn btn-sm" onclick="markAllAsRead()" style="float: right;">
                    Marcar todas como lidas
                </button>
            </div>
            <div id="notification-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Notificações serão carregadas aqui -->
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-bell-slash" style="font-size: 48px; color: #ccc;"></i>
                    <p>Nenhuma notificação</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-clinic-medical"></i> Clean DataLog</h2>
                <p>Sistema de Monitoramento</p>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-page="temperature">
                    <i class="fas fa-thermometer-half"></i>
                    <span>Temperatura & Umidade</span>
                </div>
                <div class="menu-item" data-page="pressure">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Pressão</span>
                </div>
                <div class="menu-item" data-page="osmosis">
                    <i class="fas fa-tint"></i>
                    <span>Sistema de Osmose</span>
                </div>
                <div class="menu-item admin-only" data-page="rooms">
                    <i class="fas fa-door-open"></i>
                    <span>Gerenciar Salas</span>
                </div>
                <div class="menu-item admin-only" data-page="users">
                    <i class="fas fa-users"></i>
                    <span>Gerenciar Usuários</span>
                </div>
                <div class="menu-item admin-only" data-page="traceability">
                    <i class="fas fa-history"></i>
                    <span>Rastreabilidade</span>
                </div>
                <div class="menu-item admin-only" data-page="reports">
                    <i class="fas fa-file-pdf"></i>
                    <span>Relatórios</span>
                </div>
                <!-- ADICIONAR AO MENU LATERAL (Após o item de Rastreabilidade) -->
                <div class="menu-item admin-only" data-page="backup">
                    <i class="fas fa-database"></i>
                    <span>Backup & Restauração</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="page-title">Monitoramento de Ambiente</div>
                <!-- Substitua este código no header do seu HTML -->
<div class="user-info">
    <div class="user-avatar">
        <i class="fas fa-user"></i>
    </div>
    <div>
        <div>Operador: <span id="current-user">Usuário</span></div>
        <div style="font-size: 12px; color: var(--gray);">Último login: <span id="last-login">--:--</span></div>
    </div>
    <div class="user-role" id="user-role">Usuário</div>
    
    <!-- Botão de Notificações (apenas para admin/qualidade) -->
    <button class="btn btn-info btn-sm" id="notification-btn" style="margin-left: 10px; display: none; position: relative;">
        <i class="fas fa-bell"></i>
        <span id="notification-count" style="
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
        ">0</span>
    </button>
    
    <button class="btn btn-warning btn-sm" id="logout-btn" style="margin-left: 10px;">
        <i class="fas fa-sign-out-alt"></i> Sair
    </button>
</div>
            </div>
            
            <!-- Temperature & Humidity Page -->
            <div class="page-content active" id="temperature-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Registro de Temperatura e Umidade</div>
                        <div class="current-time" id="current-time">Carregando data/hora...</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="room-select">Selecione a Sala:</label>
                        <select id="room-select">
                            <option value="">Carregando salas...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="periodo">Período:</label>
                        <select id="periodo">
                            <option value="manha">Manhã</option>
                            <option value="tarde">Tarde</option>
                        </select>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Temperatura</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="temp-min">Temperatura Mínima (°C):</label>
                                <input type="number" id="temp-min" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="temp-max">Temperatura Máxima (°C):</label>
                                <input type="number" id="temp-max" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="temp-atual">Temperatura Atual (°C):</label>
                                <input type="number" id="temp-atual" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Umidade</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="umid-min">Umidade Mínima (%):</label>
                                <input type="number" id="umid-min" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="umid-max">Umidade Máxima (%):</label>
                                <input type="number" id="umid-max" step="0.1">
                            </div>
                            
                            <div class="form-group">
                                <label for="umid-atual">Umidade Atual (%):</label>
                                <input type="number" id="umid-atual" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="temp-notes">Observações:</label>
                        <textarea id="temp-notes" rows="3" placeholder="Adicione observações se necessário..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="save-temp-btn">
                        <i class="fas fa-save"></i> Registrar Leitura
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Histórico de Temperatura e Umidade</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm admin-only" id="export-temp-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Sala</th>
                                    <th>Período</th>
                                    <th>Temp. Mín</th>
                                    <th>Temp. Máx</th>
                                    <th>Temp. Atual</th>
                                    <th>Umid. Mín</th>
                                    <th>Umid. Máx</th>
                                    <th>Umid. Atual</th>
                                    <th>Status</th>
                                    <th>Operador</th>
                                    <th class="admin-only">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="temp-history">
                                <tr>
                                    <td colspan="12" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="temp-history-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Pressure Page -->
            <div class="page-content" id="pressure-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Registro de Pressão</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-room">Selecione a Sala:</label>
                        <select id="pressure-room">
                            <option value="">Carregando salas...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-periodo">Período:</label>
                        <select id="pressure-periodo">
                            <option value="manha">Manhã</option>
                            <option value="tarde">Tarde</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-value">Pressão (Pa):</label>
                        <input type="number" id="pressure-value" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="correcao-imediata">Correção Imediata:</label>
                        <textarea id="correcao-imediata" rows="3" placeholder="Descreva a correção realizada, se aplicável..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-notes">Observações:</label>
                        <textarea id="pressure-notes" rows="3" placeholder="Adicione observações se necessário..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="save-pressure-btn">
                        <i class="fas fa-save"></i> Registrar Pressão
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Histórico de Pressão</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm admin-only" id="export-pressure-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Sala</th>
                                    <th>Período</th>
                                    <th>Pressão (Pa)</th>
                                    <th>Correção Imediata</th>
                                    <th>Status</th>
                                    <th>Operador</th>
                                    <th class="admin-only">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="pressure-history">
                                <tr>
                                    <td colspan="8" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="pressure-history-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Osmosis Page -->
            <div class="page-content" id="osmosis-page">
                <div class="tabs">
                    <div class="tab active" data-tab="daily">Controle Diário</div>
                    <div class="tab" data-tab="maintenance">Controle de Manutenção</div>
                </div>
                
                <!-- Daily Control Tab -->
                <div id="daily-tab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Controle Diário do Sistema de Osmose Reversa</div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">1. Condutividade da Água Purificada</div>
                            <div class="form-group">
                                <label for="condutividade">Resultado observado no condutivímetro de linha (µS/cm):</label>
                                <input type="number" id="condutividade" step="0.1" min="0">
                                <small style="color: var(--gray);">Limite: 1.3 µS/cm</small>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">2. Sanitização do Sistema de Osmose Reversa ou Downtime</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ultima-sanitizacao">Data da última sanitização/downtime:</label>
                                    <input type="date" id="ultima-sanitizacao">
                                </div>
                                
                                <div class="form-group">
                                    <label for="proxima-sanitizacao">Data prevista para a próxima sanitização/downtime:</label>
                                    <input type="date" id="proxima-sanitizacao">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">3. Higienização</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ultima-higienizacao">Data da última higienização:</label>
                                    <input type="date" id="ultima-higienizacao">
                                </div>
                                
                                <div class="form-group">
                                    <label for="proxima-higienizacao">Data prevista para a próxima higienização:</label>
                                    <input type="date" id="proxima-higienizacao">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">4. Coleta de Água para Análise</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ultima-coleta">Data da última coleta:</label>
                                    <input type="date" id="ultima-coleta">
                                </div>
                                
                                <div class="form-group">
                                    <label for="proxima-coleta">Data prevista para a próxima coleta:</label>
                                    <input type="date" id="proxima-coleta">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">5. O equipamento apresenta alguma anormalidade no funcionamento?</div>
                            <div class="checkbox-group">
                                <input type="radio" id="anormalidade-sim" name="anormalidade" value="sim">
                                <label for="anormalidade-sim">Sim</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="anormalidade-nao" name="anormalidade" value="nao" checked>
                                <label for="anormalidade-nao">Não</label>
                            </div>
                            
                            <div class="form-group" id="anormalidade-detalhes" style="display: none;">
                                <label for="motivo-anormalidade">Descreva o motivo:</label>
                                <textarea id="motivo-anormalidade" rows="3" placeholder="Descreva a anormalidade observada..."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">6. Troca de Filtros</div>
                            
                            <div class="form-group">
                                <label>Data da última troca:</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="ultima-fpp001">FPP-001:</label>
                                        <input type="date" id="ultima-fpp001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ultima-fca001">FCA-001:</label>
                                        <input type="date" id="ultima-fca001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ultima-drm001">DRM-001:</label>
                                        <input type="date" id="ultima-drm001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ultima-drm002">DRM-002:</label>
                                        <input type="date" id="ultima-drm002">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Data prevista para a próxima troca:</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="proxima-fpp001">FPP-001:</label>
                                        <input type="date" id="proxima-fpp001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxima-fca001">FCA-001:</label>
                                        <input type="date" id="proxima-fca001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxima-drm001">DRM-001:</label>
                                        <input type="date" id="proxima-drm001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxima-drm002">DRM-002:</label>
                                        <input type="date" id="proxima-drm002">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="osmosis-daily-notes">Observações:</label>
                            <textarea id="osmosis-daily-notes" rows="3" placeholder="Adicione observações sobre o sistema de osmose..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" id="save-osmosis-daily-btn">
                            <i class="fas fa-save"></i> Registrar Controle Diário
                        </button>
                    </div>
                </div>
                
                <!-- Maintenance Control Tab -->
                <div id="maintenance-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Controle de Manutenção do Sistema de Osmose Reversa</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="procedimento">Procedimento Realizado:</label>
                            <textarea id="procedimento" rows="3" placeholder="Descreva o procedimento de manutenção realizado..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="data-manutencao">Data da Manutenção:</label>
                            <input type="date" id="data-manutencao">
                        </div>
                        
                        <div class="form-group">
                            <label for="obs-manutencao">Observações:</label>
                            <textarea id="obs-manutencao" rows="3" placeholder="Adicione observações sobre a manutenção..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" id="save-osmosis-maintenance-btn">
                            <i class="fas fa-save"></i> Registrar Manutenção
                        </button>
                    </div>

                    <div class="card admin-only">
                        <div class="card-header">
                            <div class="card-title">Histórico de Manutenções</div>
                            <div class="card-actions">
                                <button class="btn btn-success btn-sm" id="export-maintenance-pdf">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Procedimento</th>
                                        <th>Observações</th>
                                        <th>Operador</th>
                                        <th class="admin-only">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-history">
                                    <tr>
                                        <td colspan="5" style="text-align: center;">Carregando dados...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mobile-cards" id="maintenance-history-cards">
                            <!-- Cards serão inseridos aqui dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="card admin-only">
                    <div class="card-header">
                        <div class="card-title">Histórico de Osmose - Controles Diários</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" id="export-osmosis-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Condutividade</th>
                                    <th>Status</th>
                                    <th>Anormalidade</th>
                                    <th>Operador</th>
                                    <th class="admin-only">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="osmosis-history">
                                <tr>
                                    <td colspan="6" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="osmosis-history-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>

                <!-- Seção de Cards Detalhados de Osmose -->
                <div class="card admin-only">
                    <div class="card-header">
                        <div class="card-title">Controles Diários Detalhados - Sistema de Osmose</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" onclick="exportAllOsmosisCardsToPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar Todos em PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtro por mês -->
                    <div class="filter-section">
                        <div class="filter-title">Filtrar por Mês</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filter-month">Selecione o Mês:</label>
                                <select id="filter-month">
                                    <option value="all">Todos os meses</option>
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Março</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-year">Ano:</label>
                                <select id="filter-year">
                                    <!-- Os anos serão preenchidos dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" id="apply-month-filter">
                                    <i class="fas fa-filter"></i> Aplicar Filtro
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="osmosis-cards-container" id="osmosis-detailed-cards">
                        <!-- Cards detalhados serão inseridos aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Rooms Page -->
            <div class="page-content" id="rooms-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Adicionar Nova Sala</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="room-name">Nome da Sala:</label>
                            <input type="text" id="room-name" placeholder="Ex: Sala 05 - Qualidade">
                        </div>
                        
                        <div class="form-group">
                            <label for="room-code">Código da Sala:</label>
                            <input type="text" id="room-code" placeholder="Ex: SALA05">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="room-type">Tipo de Sala:</label>
                            <select id="room-type">
                                <option value="estoque">Estoque</option>
                                <option value="preparacao">Preparação</option>
                                <option value="producao">Produção</option>
                                <option value="embalagem">Embalagem</option>
                                <option value="qualidade">Controle de Qualidade</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="room-responsible">Responsável:</label>
                            <input type="text" id="room-responsible" placeholder="Nome do responsável">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Parâmetros de Temperatura</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="temp-min-room">Temperatura Mínima (°C):</label>
                                <input type="number" id="temp-min-room" step="0.1" placeholder="Ex: 18.0" value="18.0">
                            </div>
                            <div class="form-group">
                                <label for="temp-max-room">Temperatura Máxima (°C):</label>
                                <input type="number" id="temp-max-room" step="0.1" placeholder="Ex: 26.0" value="26.0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Parâmetros de Umidade</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="umid-min-room">Umidade Mínima (%):</label>
                                <input type="number" id="umid-min-room" step="0.1" placeholder="Ex: 40.0" value="40.0">
                            </div>
                            <div class="form-group">
                                <label for="umid-max-room">Umidade Máxima (%):</label>
                                <input type="number" id="umid-max-room" step="0.1" placeholder="Ex: 60.0" value="60.0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pressure-value-min">Pressão deve ser maior ou igual a (Pa):</label>
                        <input type="number" id="pressure-value-min" placeholder="Ex: 5" value="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="room-description">Descrição:</label>
                        <textarea id="room-description" rows="3" placeholder="Descreva a finalidade da sala..."></textarea>
                    </div>
                    
                    <button class="btn btn-success" id="add-room-btn">
                        <i class="fas fa-plus"></i> Adicionar Sala
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Salas Cadastradas</div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" id="export-rooms-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Responsável</th>
                                    <th>Temp. Min-Max</th>
                                    <th>Umid. Min-Max</th>
                                    <th>Pressão Mínima</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="rooms-list">
                                <tr>
                                    <td colspan="9" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="rooms-list-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Users Management Page -->
            <div class="page-content" id="users-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Adicionar Novo Usuário</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-name">Nome Completo:</label>
                            <input type="text" id="user-name" placeholder="Nome do usuário">
                        </div>
                        
                        <div class="form-group">
                            <label for="user-email">Email:</label>
                            <input type="email" id="user-email" placeholder="email@empresa.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-password">Senha:</label>
                            <input type="password" id="user-password" placeholder="Senha temporária">
                        </div>
                        
                        <div class="form-group">
                            <label for="user-role">Tipo de Usuário:</label>
                            <select id="user-role">
                                <option value="user">Usuário Normal</option>
                                <option value="admin">Administrador</option>
                                <option value="qualidade">Qualidade</option>
                                <option value="manutencao">Manutenção</option>
                            </select>
                            <!-- Colocar APÓS o select de user-role no formulário de adição de usuário -->
<!-- Adicionar APÓS o select de user-role -->
<div class="form-section" id="access-control-section" style="display: none;">
    <div class="section-title">Controle de Acesso por Áreas</div>
    <p style="margin-bottom: 10px; color: var(--gray); font-size: 13px;">
        Selecione as áreas que este usuário poderá acessar:
    </p>
    
    <div class="form-row">
        <div class="checkbox-group">
            <input type="checkbox" id="access-temperature" name="access-areas" value="temperature">
            <label for="access-temperature">Temperatura & Umidade</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="access-pressure" name="access-areas" value="pressure">
            <label for="access-pressure">Pressão</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="access-osmosis" name="access-areas" value="osmosis">
            <label for="access-osmosis">Sistema de Osmose</label>
        </div>
    </div>
    
    <div class="form-row">
        <div class="checkbox-group">
            <input type="checkbox" id="access-rooms" name="access-areas" value="rooms">
            <label for="access-rooms">Gerenciar Salas</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="access-traceability" name="access-areas" value="traceability">
            <label for="access-traceability">Rastreabilidade</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="access-reports" name="access-areas" value="reports">
            <label for="access-reports">Relatórios</label>
        </div>
    </div>
    
    <div class="form-row">
        <div class="checkbox-group">
            <input type="checkbox" id="access-backup" name="access-areas" value="backup">
            <label for="access-backup">Backup & Restauração</label>
        </div>
    </div>
    
    <div class="form-group" style="margin-top: 15px;" id="notifications-section">
        <div class="checkbox-group">
            <input type="checkbox" id="receives-notifications">
            <label for="receives-notifications">Receber notificações do sistema</label>
        </div>
        <small style="color: var(--gray);">(Apenas para admin/qualidade/manutenção)</small>
    </div>
</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" id="add-user-btn">
                        <i class="fas fa-user-plus"></i> Adicionar Usuário
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Usuários do Sistema</div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>Data de Criação</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <tr>
                                    <td colspan="6" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="users-list-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Traceability Page -->
            <div class="page-content" id="traceability-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Rastreabilidade do Sistema</div>
                        <div class="card-actions admin-only">
                            <button class="btn btn-success btn-sm" onclick="exportTraceabilityToPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar Relatório Completo
                            </button>
                            <button class="btn btn-success btn-sm" id="export-traceability-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-title">Filtros</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filter-date">Filtrar por Data:</label>
                                <input type="date" id="filter-date">
                            </div>
                            
                            <div class="form-group">
                                <label for="filter-user">Filtrar por Usuário:</label>
                                <select id="filter-user">
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filter-action">Filtrar por Ação:</label>
                                <select id="filter-action">
                                    <option value="all">Todas</option>
                                    <option value="temperature">Temperatura/Umidade</option>
                                    <option value="pressure">Pressão</option>
                                    <option value="osmosis">Osmose</option>
                                    <option value="room">Sala</option>
                                    <option value="user">Usuário</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Detalhes</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="traceability-log">
                                <tr>
                                    <td colspan="5" style="text-align: center;">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mobile-cards" id="traceability-log-cards">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Reports Page -->
            <div class="page-content" id="reports-page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Relatórios do Sistema</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="report-type">Tipo de Relatório:</label>
                        <select id="report-type">
                            <option value="temperature">Temperatura e Umidade</option>
                            <option value="pressure">Pressão</option>
                            <option value="osmosis">Sistema de Osmose</option>
                            <option value="rooms">Salas</option>
                            <option value="users">Usuários</option>
                            <option value="traceability">Rastreabilidade</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="report-start-date">Data Inicial:</label>
                            <input type="date" id="report-start-date">
                        </div>
                        
                        <div class="form-group">
                            <label for="report-end-date">Data Final:</label>
                            <input type="date" id="report-end-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="report-format">Formato do Relatório:</label>
                        <select id="report-format">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" id="generate-report-btn">
                        <i class="fas fa-file-export"></i> Gerar Relatório
                    </button>
                </div>
            </div>

            <!-- ========== PÁGINA DE BACKUP & RESTAURAÇÃO ========== -->
<!-- LOCAL: Colar após a div com id="reports-page" -->
<div class="page-content" id="backup-page">
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-database"></i> Sistema de Backup & Restauração
            </div>
            <div class="card-actions">
                <button class="btn btn-info btn-sm" onclick="generateBackupReport()">
                    <i class="fas fa-file-contract"></i> Relatório de Conformidade
                </button>
            </div>
        </div>
        
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-robot"></i> Backup Automático (Firestore)
            </div>
            <p style="margin-bottom: 15px; color: var(--gray);">
                Configura backups automáticos diários via Firebase Firestore. 
                Requer plano Blaze e permissões adequadas[citation:4].
            </p>
            <button class="btn btn-primary" id="setup-auto-backup" onclick="configureAutomaticBackupSchedule()">
                <i class="fas fa-cogs"></i> Configurar Backup Automático
            </button>
        </div>
        
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-download"></i> Backup Manual
            </div>
            <p style="margin-bottom: 15px; color: var(--gray);">
                Cria um backup completo do sistema para download local. 
                Armazene em no mínimo dois locais físicos diferentes[citation:5].
            </p>
            <button class="btn btn-success" id="create-backup-btn" onclick="createManualBackup()">
                <i class="fas fa-file-export"></i> Criar & Baixar Backup Completo
            </button>
        </div>
        
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-upload"></i> Restauração do Sistema
            </div>
            <div class="alert alert-warning" style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Atenção:</strong> A restauração substituirá TODOS os dados atuais do sistema. 
                Use apenas em casos de recuperação de desastre.
            </div>
            
            <div class="form-group">
                <label for="backup-file">
                    <i class="fas fa-file-archive"></i> Selecione arquivo de backup (.json):
                </label>
                <input type="file" id="backup-file" accept=".json" style="padding: 8px;">
            </div>
            
            <button class="btn btn-danger" id="restore-backup-btn" onclick="handleRestoreBackup()">
                <i class="fas fa-history"></i> Restaurar Sistema a partir do Backup
            </button>
        </div>
        
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-clipboard-check"></i> Status do Sistema
            </div>
            <div id="backup-status" style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Último Backup:</label>
                        <div id="last-backup-date">Carregando...</div>
                    </div>
                    <div class="form-group">
                        <label>Integridade:</label>
                        <div id="integrity-status">Carregando...</div>
                    </div>
                    <div class="form-group">
                        <label>Total de Dados:</label>
                        <div id="total-data-size">Carregando...</div>
                    </div>
                </div>
                <button class="btn btn-info btn-sm" onclick="checkBackupIntegrity()">
                    <i class="fas fa-sync-alt"></i> Verificar Integridade Agora
                </button>
            </div>
        </div>
        
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-shield-alt"></i> Política de Backup (Conformidade ANVISA)
            </div>
            <div style="background: #e8f4fc; padding: 15px; border-radius: 4px; font-size: 13px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;">Política de Backup e Restore - ANVISA[citation:1]</h4>
                <ul style="padding-left: 20px; margin-bottom: 10px;">
                    <li>Backups diários automáticos configurados</li>
                    <li>Retenção de 7 dias para backups automáticos</li>
                    <li>Criptografia de dados em repouso e em trânsito</li>
                    <li>Backups manuais armazenados em locais físicos distintos</li>
                    <li>Testes de restauração trimestrais obrigatórios</li>
                    <li>Registro de auditoria para todas as operações</li>
                </ul>
                <p style="font-style: italic; color: var(--gray); margin: 0;">
                    <i class="fas fa-info-circle"></i> Esta implementação segue a Portaria ANVISA de Backup e Restauração de Dados
                </p>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

    <!-- Modal Estilizado para Alertas -->
<div id="custom-modal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <i id="modal-icon" class="fas fa-exclamation-circle"></i>
            <h3 id="modal-title">Alerta do Sistema</h3>
        </div>
        <div class="custom-modal-body">
            <p id="modal-message">Mensagem de alerta</p>
        </div>
        <div class="custom-modal-footer">
            <button id="modal-ok-btn" class="btn btn-primary">OK</button>
            <button id="modal-cancel-btn" class="btn btn-secondary" style="display: none;">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirm-modal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <i class="fas fa-question-circle" style="color: #3498db;"></i>
            <h3>Confirmação</h3>
        </div>
        <div class="custom-modal-body">
            <p id="confirm-message">Tem certeza que deseja continuar?</p>
        </div>
        <div class="custom-modal-footer">
            <button id="confirm-yes-btn" class="btn btn-primary">Sim</button>
            <button id="confirm-no-btn" class="btn btn-secondary">Não</button>
        </div>
    </div>
</div>

    <script>
        // ========== FUNÇÕES DE VALIDAÇÃO GLOBAIS ==========

// Validação de dados de temperatura
function validateTemperatureData(tempMin, tempMax, tempActual, humidityMin, humidityMax, humidityActual) {
    const errors = [];
    
    if (tempMin < -50 || tempMin > 100) errors.push('Temp mínima fora do range (-50°C a 100°C)');
    if (tempMax < -50 || tempMax > 100) errors.push('Temp máxima fora do range (-50°C a 100°C)');
    if (tempActual < -50 || tempActual > 100) errors.push('Temp atual fora do range (-50°C a 100°C)');
    if (tempMin > tempMax) errors.push('Temp mínima > máxima');
    if (tempActual < tempMin || tempActual > tempMax) errors.push('Temp atual fora da faixa');
    
    if (humidityMin < 0 || humidityMin > 100) errors.push('Umid mínima fora do range (0% a 100%)');
    if (humidityMax < 0 || humidityMax > 100) errors.push('Umid máxima fora do range (0% a 100%)');
    if (humidityActual < 0 || humidityActual > 100) errors.push('Umid atual fora do range (0% a 100%)');
    if (humidityMin > humidityMax) errors.push('Umid mínima > máxima');
    if (humidityActual < humidityMin || humidityActual > humidityMax) errors.push('Umid atual fora da faixa');
    
    return errors;
}

// Validação de pressão
function validatePressureData(pressure, minPressure = 0) {
    const errors = [];
    
    if (pressure < 0) errors.push('Pressão não pode ser negativa');
    if (pressure > 10000) errors.push('Pressão acima do limite (10,000 Pa)');
    
    return errors;
}

// Validação de osmose
function validateOsmosisData(conductivity) {
    const errors = [];
    
    if (conductivity < 0) errors.push('Condutividade não pode ser negativa');
    if (conductivity > 100) errors.push('Condutividade acima do limite (100 µS/cm)');
    
    return errors;
}

// Validação de sala
function validateRoomData(name, code, tempMin, tempMax, humidityMin, humidityMax, pressureMin) {
    const errors = [];
    
    if (!name || name.length < 3) errors.push('Nome da sala muito curto');
    if (!code || code.length < 2) errors.push('Código da sala muito curto');
    if (tempMin < 0 || tempMin > 50) errors.push('Temp mínima inválida (0°C a 50°C)');
    if (tempMax < 0 || tempMax > 50) errors.push('Temp máxima inválida (0°C a 50°C)');
    if (tempMin > tempMax) errors.push('Temp mínima > máxima');
    if (humidityMin < 0 || humidityMin > 100) errors.push('Umid mínima inválida (0% a 100%)');
    if (humidityMax < 0 || humidityMax > 100) errors.push('Umid máxima inválida (0% a 100%)');
    if (humidityMin > humidityMax) errors.push('Umid mínima > máxima');
    if (pressureMin < 0) errors.push('Pressão mínima não pode ser negativa');
    
    return errors;
}

// Função para mostrar erros de validação
function showValidationErrors(errors, context = 'Validação') {
    if (errors.length > 0) {
        const errorMessage = `${context}:\n\n• ${errors.join('\n• ')}`;
        alert(errorMessage);
        return false;
    }
    return true;
}
        // Estado global da aplicação
        let currentUser = null;
        let rooms = [];
        let allUsers = [];
        let currentEditData = null;
        let traceabilityData = [];
        let osmosisDailyData = [];
        let filteredOsmosisData = [];

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ========== FUNÇÃO initializeApp() COMPLEMENTADA ==========
async function initializeApp() {
    console.log('=== INICIALIZANDO APLICAÇÃO ===');
    
    try {
        // 1. VERIFICAR CONEXÃO COM FIREBASE
        const app = firebase.app();
        console.log('Firebase carregado:', app.name);
        
        // 2. CONFIGURAR OBSERVADOR DE AUTENTICAÇÃO
        auth.onAuthStateChanged(async (user) => {
            console.log('Estado de autenticação:', user ? 'Usuário logado' : 'Usuário deslogado');
            
            if (user) {
                await handleUserLogin(user);
            } else {
                showLoginModal();
            }
        });
        initializeBackupMonitor();
setupBackupEventListeners();
        
        // 3. VERIFICAR SE HÁ USUÁRIO ADMINISTRADOR
        await checkAdminExists();
        
        // 4. CONFIGURAR EVENT LISTENERS
        setupEventListeners();
        console.log('=== CONFIGURANDO SISTEMA DE NOTIFICAÇÕES ===');
        setupOsmosisTabs();
        
        // 5. ATUALIZAR HORA E DATA
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // 6. PREENCHER FILTROS
        populateYearFilter();
        
        // 7. VERIFICAR NOTIFICAÇÕES PENDENTES
        setTimeout(() => {
            if (currentUser && currentUser.role === 'admin') {
                updateNotificationCount();
            }
        }, 2000);
        
        console.log('=== APLICAÇÃO INICIALIZADA ===');
        
    } catch (error) {
        console.error('Erro na inicialização:', error);
        alert('Erro ao inicializar o sistema. Verifique sua conexão.');
    }
}

// Função auxiliar para verificar se existe admin
async function checkAdminExists() {
    try {
        const adminsSnapshot = await db.collection('users')
            .where('role', '==', 'admin')
            .where('status', '==', 'active')
            .limit(1)
            .get();
        
        if (adminsSnapshot.empty) {
            console.warn('⚠️ Nenhum administrador encontrado no sistema');
            
            // Criar admin padrão se permitido
            const shouldCreateAdmin = confirm(
                'Nenhum administrador encontrado no sistema.\n\n' +
                'Deseja criar um administrador padrão?\n\n' +
                'Email: admin@cleanroom.com\n' +
                'Senha: admin123'
            );
            
            if (shouldCreateAdmin) {
                await createDefaultAdmin();
            }
        } else {
            console.log('Administrador encontrado no sistema');
        }
        
    } catch (error) {
        console.error('Erro ao verificar administradores:', error);
    }
}

// ========== FUNÇÃO: configureAutomaticBackupSchedule ==========
// OBJETIVO: Configurar agendamento automático de backup diário no Firestore
// LOCAL: Colar APÓS a função `checkAdminExists()` no início do arquivo JS
async function configureAutomaticBackupSchedule() {
    if (currentUser.role !== 'admin') {
        showError('Permissão Negada', 'Apenas administradores podem configurar backups.');
        return;
    }

    try {
        console.log('=== CONFIGURANDO AGENDAMENTO DE BACKUP AUTOMÁTICO ===');
        
        // Configuração do backup diário (exige plano Blaze)
        const API_KEY = firebaseConfig.apiKey;
        const projectId = firebaseConfig.projectId;
        
        // Usar a API do Google Cloud via fetch
        const response = await fetch(`https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/backupSchedules`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${await getAuthToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                retention: '604800s', // 7 dias de retenção
                dailyRecurrence: {}
            })
        });

        if (response.ok) {
            console.log('✅ Agendamento de backup automático configurado com sucesso!');
            await addTraceability('Configuração de Backup', 'Backup automático diário configurado');
            showSuccess('Sucesso', 'Backup automático configurado! Backups serão feitos diariamente com 7 dias de retenção.');
        } else {
            const error = await response.json();
            throw new Error(error.error?.message || 'Erro ao configurar backup');
        }
    } catch (error) {
        console.error('❌ Erro ao configurar backup automático:', error);
        showError('Erro de Configuração', 
            `Não foi possível configurar backup automático: ${error.message}. ` +
            `Verifique se está no plano Blaze e com permissões adequadas[citation:4].`
        );
    }
}

// ========== FUNÇÃO: createManualBackup ==========
// OBJETIVO: Criar backup manual e disponibilizar para download
// LOCAL: Colar APÓS a função `configureAutomaticBackupSchedule`
async function createManualBackup() {
    if (currentUser.role !== 'admin') {
        showError('Permissão Negada', 'Apenas administradores podem criar backups manuais.');
        return;
    }

    const confirm = await showConfirm(
        'Criar backup manual completo?\n\n' +
        'Esta operação exportará todos os dados do Firestore e gerará um arquivo JSON para download. ' +
        'Pode levar alguns minutos dependendo do tamanho dos dados.'
    );
    
    if (!confirm) return;

    const backupBtn = document.getElementById('create-backup-btn');
    const originalText = backupBtn.innerHTML;
    backupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando Backup...';
    backupBtn.disabled = true;

    try {
        console.log('=== INICIANDO BACKUP MANUAL ===');
        
        // 1. Coletar dados de todas as coleções
        const collections = [
            'temperature_readings',
            'pressure_readings', 
            'osmosis_daily',
            'osmosis_maintenance',
            'rooms',
            'users',
            'traceability',
            'notifications'
        ];

        const backupData = {
            metadata: {
                system: 'Clean DataLog',
                version: '2.0',
                backupDate: new Date().toISOString(),
                createdBy: currentUser.email,
                collectionsCount: collections.length
            },
            collections: {}
        };

        // 2. Exportar cada coleção
        for (const collection of collections) {
            console.log(`Exportando coleção: ${collection}`);
            const snapshot = await db.collection(collection).get();
            backupData.collections[collection] = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }

        // 3. Converter para JSON e criar arquivo
        const jsonData = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // 4. Criar link para download
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `cleanroom-backup-${timestamp}.json`;
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // 5. Registrar rastreabilidade
        await addTraceability(
            'Backup Manual Criado', 
            `Backup completo criado: ${filename} (${collections.length} coleções)`
        );

        console.log('✅ Backup manual criado com sucesso:', filename);
        showSuccess('Backup Concluído', 
            `Backup criado com sucesso!\n\n` +
            `Arquivo: ${filename}\n` +
            `Tamanho: ${(blob.size / 1024 / 1024).toFixed(2)} MB\n` +
            `Coleções: ${collections.length}\n\n` +
            `O arquivo foi baixado automaticamente. Armazene-o em local seguro[citation:2].`
        );

    } catch (error) {
        console.error('❌ Erro ao criar backup manual:', error);
        showError('Erro no Backup', 
            `Falha ao criar backup: ${error.message}\n\n` +
            `Verifique a conexão e tente novamente.`
        );
    } finally {
        backupBtn.innerHTML = originalText;
        backupBtn.disabled = false;
    }
}

// ========== FUNÇÃO: restoreFromBackup ==========
// OBJETIVO: Restaurar sistema a partir de arquivo de backup
// LOCAL: Colar APÓS a função `createManualBackup`
async function restoreFromBackup(file) {
    if (currentUser.role !== 'admin') {
        showError('Permissão Negada', 'Apenas administradores podem restaurar backups.');
        return;
    }

    const confirm = await showConfirm(
        '⚠️ RESTAURAÇÃO DE BACKUP ⚠️\n\n' +
        'Esta operação SUBSTITUIRÁ todos os dados atuais do sistema pelos dados do backup.\n\n' +
        'AVISOS:\n' +
        '• Todos os dados atuais serão perdidos\n' +
        '• O sistema ficará indisponível durante a restauração\n' +
        '• Esta operação não pode ser desfeita\n\n' +
        'Tem certeza absoluta que deseja continuar?'
    );
    
    if (!confirm) return;

    const restoreBtn = document.getElementById('restore-backup-btn');
    const originalText = restoreBtn.innerHTML;
    restoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restaurando...';
    restoreBtn.disabled = true;

    try {
        console.log('=== INICIANDO RESTAURAÇÃO DE BACKUP ===');
        
        // 1. Ler arquivo
        const text = await readFileAsText(file);
        const backupData = JSON.parse(text);
        
        // 2. Validar estrutura do backup
        if (!backupData.metadata || !backupData.collections) {
            throw new Error('Arquivo de backup inválido: estrutura incorreta');
        }
        
        // 3. Desabilitar interface
        showInfo('Restauração em Andamento', 
            'Iniciando restauração do sistema...\n\n' +
            'Não feche o navegador durante este processo.'
        );
        
        // 4. Restaurar cada coleção
        const collections = Object.keys(backupData.collections);
        let totalRestored = 0;
        
        for (const collection of collections) {
            const documents = backupData.collections[collection];
            console.log(`Restaurando coleção ${collection}: ${documents.length} documentos`);
            
            // Deletar documentos existentes
            const existingDocs = await db.collection(collection).get();
            const deleteBatch = db.batch();
            existingDocs.forEach(doc => {
                deleteBatch.delete(doc.ref);
            });
            await deleteBatch.commit();
            
            // Inserir documentos do backup
            const insertBatch = db.batch();
            let docCount = 0;
            
            for (const docData of documents) {
                const docRef = db.collection(collection).doc(docData.id || db.collection(collection).doc().id);
                const { id, ...data } = docData;
                insertBatch.set(docRef, data);
                docCount++;
                totalRestored++;
                
                // Commit em lotes de 500 para evitar limite do Firestore
                if (docCount >= 500) {
                    await insertBatch.commit();
                    docCount = 0;
                }
            }
            
            if (docCount > 0) {
                await insertBatch.commit();
            }
        }
        
        // 5. Registrar rastreabilidade
        await addTraceability(
            'Restauração de Sistema', 
            `Sistema restaurado a partir de backup: ${file.name}\n` +
            `Data do backup: ${backupData.metadata.backupDate}\n` +
            `Documentos restaurados: ${totalRestored}`
        );
        
        console.log(`✅ Restauração concluída: ${totalRestored} documentos restaurados`);
        showSuccess('Restauração Concluída', 
            `✅ Sistema restaurado com sucesso!\n\n` +
            `Estatísticas:\n` +
            `• Backup de: ${backupData.metadata.backupDate}\n` +
            `• Coleções: ${collections.length}\n` +
            `• Documentos: ${totalRestored}\n\n` +
            `O sistema será recarregado automaticamente.`
        );
        
        // 6. Recarregar sistema
        setTimeout(() => {
            location.reload();
        }, 3000);
        
    } catch (error) {
        console.error('❌ Erro na restauração:', error);
        showError('Erro na Restauração', 
            `Falha na restauração: ${error.message}\n\n` +
            `O sistema pode estar em estado inconsistente. ` +
            `Entre em contato com o suporte técnico.`
        );
    } finally {
        restoreBtn.innerHTML = originalText;
        restoreBtn.disabled = false;
    }
}

// Função auxiliar para ler arquivo
function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Erro ao ler arquivo'));
        reader.readAsText(file);
    });
}

// ========== FUNÇÃO: generateBackupReport ==========
// OBJETIVO: Gerar relatório detalhado de backup para conformidade
// LOCAL: Colar APÓS a função `restoreFromBackup`
async function generateBackupReport() {
    if (currentUser.role !== 'admin') {
        showError('Permissão Negada', 'Apenas administradores podem gerar relatórios.');
        return;
    }

    try {
        console.log('=== GERANDO RELATÓRIO DE BACKUP ===');
        
        // Coletar estatísticas
        const collections = [
            'temperature_readings',
            'pressure_readings',
            'osmosis_daily', 
            'osmosis_maintenance',
            'rooms',
            'users',
            'traceability',
            'notifications'
        ];
        
        const reportData = {
            title: 'Relatório de Backup e Conformidade - Clean DataLog',
            generatedAt: new Date().toISOString(),
            generatedBy: currentUser.email,
            systemInfo: {
                version: '2.0',
                totalCollections: collections.length,
                lastBackupDate: localStorage.getItem('lastBackupDate') || 'Nunca'
            },
            collectionStats: {},
            complianceChecklist: {
                backupFrequency: 'Diário (Configurado)',
                retentionPolicy: '7 dias (Conforme ANVISA)[citation:1]',
                encryption: 'Habilitada (Firestore)',
                accessControl: 'RBAC Implementado',
                auditLogs: 'Rastreabilidade Ativa'
            },
            recommendations: []
        };
        
        // Coletar estatísticas por coleção
        for (const collection of collections) {
            const snapshot = await db.collection(collection).get();
            const docs = snapshot.docs;
            
            reportData.collectionStats[collection] = {
                documentCount: docs.length,
                lastDocumentDate: docs.length > 0 ? 
                    (docs[0].data().createdAt?.toDate?.() || new Date()).toISOString() : 
                    'Nenhum'
            };
        }
        
        // Verificar conformidade
        const totalDocs = Object.values(reportData.collectionStats)
            .reduce((sum, stat) => sum + stat.documentCount, 0);
        
        if (totalDocs === 0) {
            reportData.recommendations.push('⚠️ Sistema sem dados - Verificar integridade');
        }
        
        // Gerar PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabeçalho
        doc.setFillColor(44, 62, 80);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text('RELATÓRIO DE CONFORMIDADE - BACKUP', 105, 15, { align: 'center' });
        doc.setFontSize(10);
        doc.text('Clean DataLog - Sistema de Monitoramento Hospitalar', 105, 22, { align: 'center' });
        
        // Informações do Relatório
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 40);
        doc.text(`Gerado por: ${currentUser.name} (${currentUser.email})`, 14, 47);
        
        // Estatísticas das Coleções
        doc.setFontSize(14);
        doc.text('1. ESTATÍSTICAS DO SISTEMA', 14, 60);
        doc.setFontSize(10);
        
        let yPos = 70;
        Object.entries(reportData.collectionStats).forEach(([collection, stats]) => {
            doc.text(`• ${collection}: ${stats.documentCount} documentos`, 20, yPos);
            yPos += 7;
            
            if (yPos > 280) {
                doc.addPage();
                yPos = 20;
            }
        });
        
        // Checklist de Conformidade
        doc.addPage();
        doc.setFontSize(14);
        doc.text('2. CHECKLIST DE CONFORMIDADE ANVISA', 14, 20);
        doc.setFontSize(10);
        
        yPos = 30;
        Object.entries(reportData.complianceChecklist).forEach(([item, status]) => {
            doc.text(`✓ ${item}: ${status}`, 20, yPos);
            yPos += 7;
        });
        
        // Recomendações
        if (reportData.recommendations.length > 0) {
            doc.setFontSize(14);
            doc.text('3. RECOMENDAÇÕES', 14, yPos + 10);
            doc.setFontSize(10);
            yPos += 20;
            
            reportData.recommendations.forEach(rec => {
                doc.text(`• ${rec}`, 20, yPos);
                yPos += 7;
            });
        }
        
        // Rodapé
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text('Documento confidencial - Uso interno', 14, 290);
            doc.text(`Página ${i} de ${totalPages}`, 190, 290, { align: 'right' });
        }
        
        // Salvar PDF
        const filename = `relatorio-conformidade-backup-${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(filename);
        
        await addTraceability('Relatório de Conformidade', 'Relatório de backup e conformidade gerado');
        showSuccess('Relatório Gerado', `Relatório de conformidade salvo como: ${filename}`);
        
    } catch (error) {
        console.error('❌ Erro ao gerar relatório:', error);
        showError('Erro no Relatório', 'Falha ao gerar relatório de conformidade');
    }
}

// ========== FUNÇÃO: initializeBackupMonitor ==========
// OBJETIVO: Inicializar monitoramento automático de integridade
// LOCAL: Colar APÓS a função `generateBackupReport`
function initializeBackupMonitor() {
    // Verificar integridade a cada 24 horas
    setInterval(async () => {
        if (currentUser && currentUser.role === 'admin') {
            await checkBackupIntegrity();
        }
    }, 24 * 60 * 60 * 1000); // 24 horas
    
    // Verificar imediatamente se é admin
    if (currentUser && currentUser.role === 'admin') {
        setTimeout(() => checkBackupIntegrity(), 5000);
    }
}

// ========== FUNÇÕES AUXILIARES PARA BACKUP ==========
// LOCAL: Colar APÓS a função `initializeBackupMonitor`

// Handler para restauração de backup
async function handleRestoreBackup() {
    const fileInput = document.getElementById('backup-file');
    if (!fileInput.files.length) {
        showError('Arquivo Não Selecionado', 'Por favor, selecione um arquivo de backup (.json)');
        return;
    }
    
    await restoreFromBackup(fileInput.files[0]);
}

// Atualizar status do backup na interface
async function updateBackupStatus() {
    if (!currentUser || currentUser.role !== 'admin') return;
    
    try {
        // Último backup
        const lastBackup = localStorage.getItem('lastBackupDate');
        document.getElementById('last-backup-date').innerHTML = lastBackup ? 
            `<span style="color: var(--success);"><i class="fas fa-check-circle"></i> ${new Date(lastBackup).toLocaleString('pt-BR')}</span>` :
            `<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Nunca</span>`;
        
        // Status de integridade
        const lastCheck = localStorage.getItem('lastIntegrityCheck');
        document.getElementById('integrity-status').innerHTML = lastCheck ?
            `<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Verificado em ${new Date(lastCheck).toLocaleString('pt-BR')}</span>` :
            `<span style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Pendente</span>`;
        
        // Total de dados
        const snapshot = await db.collection('temperature_readings').count().get();
        const totalDocs = snapshot.data().count;
        document.getElementById('total-data-size').innerHTML = 
            `<i class="fas fa-chart-bar"></i> ${totalDocs.toLocaleString('pt-BR')} registros`;
            
    } catch (error) {
        console.error('Erro ao atualizar status:', error);
    }
}

// Adicionar event listeners para backup
function setupBackupEventListeners() {
    // Botão de backup manual
    document.getElementById('create-backup-btn')?.addEventListener('click', createManualBackup);
    
    // Botão de restauração
    document.getElementById('restore-backup-btn')?.addEventListener('click', handleRestoreBackup);
    
    // Botão de configuração automática
    document.getElementById('setup-auto-backup')?.addEventListener('click', configureAutomaticBackupSchedule);
    
    // Atualizar status periodicamente
    setInterval(updateBackupStatus, 60000); // A cada minuto
    
    // Atualizar status inicial
    setTimeout(updateBackupStatus, 3000);
}

async function checkBackupIntegrity() {
    try {
        console.log('=== VERIFICANDO INTEGRIDADE DE BACKUP ===');
        
        // Verificar coleções críticas
        const criticalCollections = ['temperature_readings', 'pressure_readings', 'rooms'];
        let integrityIssues = [];
        
        for (const collection of criticalCollections) {
            const snapshot = await db.collection(collection)
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();
            
            if (snapshot.empty) {
                integrityIssues.push(`Coleção ${collection} está vazia`);
            } else {
                const lastDoc = snapshot.docs[0].data();
                const lastDate = lastDoc.createdAt?.toDate?.();
                
                if (lastDate) {
                    const daysSinceLast = (new Date() - lastDate) / (1000 * 60 * 60 * 24);
                    if (daysSinceLast > 2) {
                        integrityIssues.push(`Dados antigos em ${collection}: ${daysSinceLast.toFixed(1)} dias`);
                    }
                }
            }
        }
        
        // Verificar último backup
        const lastBackup = localStorage.getItem('lastBackupDate');
        if (!lastBackup || (new Date() - new Date(lastBackup)) > 3 * 24 * 60 * 60 * 1000) {
            integrityIssues.push('Backup automático pendente há mais de 3 dias');
        }
        
        // Notificar se houver problemas
        if (integrityIssues.length > 0) {
            console.warn('⚠️ Problemas de integridade detectados:', integrityIssues);
            
            await createNotification(
                'critical',
                '⚠️ Alerta de Integridade do Sistema',
                `Foram detectados problemas de integridade:\n\n• ${integrityIssues.join('\n• ')}`,
                'system_integrity_check',
                'system'
            );
            
            showWarning(
                'Verificação de Integridade',
                `Foram detectados ${integrityIssues.length} problema(s):\n\n` +
                integrityIssues.join('\n') +
                `\n\nRecomenda-se realizar backup manual imediato[citation:6].`
            );
        } else {
            console.log('✅ Integridade do sistema verificada - OK');
            // Registrar verificação bem-sucedida
            localStorage.setItem('lastIntegrityCheck', new Date().toISOString());
        }
        
    } catch (error) {
        console.error('❌ Erro na verificação de integridade:', error);
    }
}

// Função auxiliar para obter token de autenticação
async function getAuthToken() {
    return new Promise((resolve, reject) => {
        const unsubscribe = auth.onAuthStateChanged(user => {
            if (user) {
                user.getIdToken().then(token => {
                    unsubscribe();
                    resolve(token);
                }).catch(reject);
            } else {
                unsubscribe();
                reject(new Error('Usuário não autenticado'));
            }
        });
    });
}

// Função para criar admin padrão (apenas em desenvolvimento)
// Função para criar admin padrão
async function createDefaultAdmin() {
    const confirm = await showConfirm(
        'Nenhum administrador encontrado no sistema.\n\n' +
        'Deseja criar um administrador padrão?\n\n' +
        'Email: admin@cleanroom.com\n' +
        'Senha: Admin@1234\n\n' +
        'ALTERE A SENHA APÓS O PRIMEIRO LOGIN!'
    );
    
    if (!confirm) return;
    
    try {
        console.log('Criando admin padrão...');
        
        // Criar no Auth
        const userCredential = await auth.createUserWithEmailAndPassword(
            'admin@cleanroom.com', 
            'Admin@1234'
        );
        
        const adminUser = {
            uid: userCredential.user.uid,
            name: 'Administrador',
            email: 'admin@cleanroom.com',
            role: 'admin',
            accessAreas: ['temperature', 'pressure', 'osmosis', 'rooms', 'users', 'traceability', 'reports', 'backup'],
            receivesNotifications: true,
            status: 'active',
            createdAt: new Date(),
            createdBy: 'system',
            createdByName: 'Sistema',
            firstLogin: true
        };
        
        // Salvar no Firestore
        await db.collection('users').doc(adminUser.uid).set(adminUser);
        
        console.log('✅ Admin padrão criado com sucesso!');
        
        showSuccess('Admin Criado', 
            'Administrador padrão criado!\n\n' +
            'Email: admin@cleanroom.com\n' +
            'Senha: Admin@1234\n\n' +
            'FAÇA LOGIN E ALTERE A SENHA IMEDIATAMENTE!',
            {
                onOk: () => {
                    // Fazer logout e mostrar login
                    auth.signOut();
                    showLoginModal();
                }
            }
        );
        
    } catch (error) {
        console.error('Erro ao criar admin:', error);
        
        if (error.code === 'auth/email-already-in-use') {
            showInfo('Admin Existente', 
                'O administrador padrão já existe.\n\n' +
                'Email: admin@cleanroom.com\n' +
                'Tente fazer login com este email.'
            );
        } else {
            showError('Erro', `Não foi possível criar admin: ${error.message}`);
        }
    }
}
        function setupEventListeners() {
            // Login
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Notificações
            document.getElementById('notification-btn').addEventListener('click', showNotificationModal);

            // Fechar modal ao clicar fora
            document.getElementById('notification-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideNotificationModal();
                }
            });

            // Adicionar este código dentro da função setupEventListeners()
// Adicionar ao setupEventListeners()
document.getElementById('user-role').addEventListener('change', function() {
    const accessControlSection = document.getElementById('access-control-section');
    const notificationsSection = document.getElementById('notifications-section');
    const role = this.value;
    
    if (role === 'admin') {
        accessControlSection.style.display = 'none';
        notificationsSection.style.display = 'none';
    } else {
        accessControlSection.style.display = 'block';
        
        // Mostrar seção de notificações apenas para qualidade e manutenção
        if (role === 'qualidade' || role === 'manutencao') {
            notificationsSection.style.display = 'block';
        } else {
            notificationsSection.style.display = 'none';
        }
    }
});
            
            // Navegação
            const menuItems = document.querySelectorAll('.menu-item');
            const pages = document.querySelectorAll('.page-content');
            
            menuItems.forEach(item => {
    item.addEventListener('click', function() {
        const targetPage = this.getAttribute('data-page');
        
        // Verificar se usuário tem acesso à página
        if (!checkUserAccess(targetPage)) {
            showWarning('Acesso Negado', `Você não tem permissão para acessar ${getPageName(targetPage)}.`);
            return;
        }
                    
                    // Update active menu item
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target page
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === `${targetPage}-page`) {
                            page.classList.add('active');
                        }
                    });
                    
                    // Update page title
                    updatePageTitle(targetPage);

                    // Carregar dados específicos da página
                    if (targetPage === 'users') {
                        loadUsersList();
                    } else if (targetPage === 'rooms') {
                        loadRoomsList();
                    } else if (targetPage === 'traceability') {
                        loadTraceabilityLog();
                    } else if (targetPage === 'osmosis') {
                        loadOsmosisHistory();
                    }
                });
            });

            // Salvar dados
            document.getElementById('save-temp-btn').addEventListener('click', saveTemperatureData);
            document.getElementById('save-pressure-btn').addEventListener('click', savePressureData);
            document.getElementById('save-osmosis-daily-btn').addEventListener('click', saveOsmosisDaily);
            document.getElementById('save-osmosis-maintenance-btn').addEventListener('click', saveOsmosisMaintenance);
            document.getElementById('add-room-btn').addEventListener('click', addRoom);
            document.getElementById('add-user-btn').addEventListener('click', addUser);

            // Toggle anormalidade
            document.getElementById('anormalidade-sim').addEventListener('change', function() {
                document.getElementById('anormalidade-detalhes').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('anormalidade-nao').addEventListener('change', function() {
                document.getElementById('anormalidade-detalhes').style.display = this.checked ? 'none' : 'block';
            });

            // Exportar PDF
            document.getElementById('export-temp-pdf').addEventListener('click', () => exportToPDF('temperature'));
            document.getElementById('export-pressure-pdf').addEventListener('click', () => exportToPDF('pressure'));
            document.getElementById('export-osmosis-pdf').addEventListener('click', () => exportToPDF('osmosis'));
            document.getElementById('export-maintenance-pdf').addEventListener('click', () => exportToPDF('maintenance'));
            document.getElementById('export-rooms-pdf').addEventListener('click', () => exportToPDF('rooms'));
            document.getElementById('export-traceability-pdf').addEventListener('click', () => exportToPDF('traceability'));
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);

            // Filtros
            document.getElementById('filter-date').addEventListener('change', loadTraceabilityLog);
            document.getElementById('filter-user').addEventListener('change', loadTraceabilityLog);
            document.getElementById('filter-action').addEventListener('change', loadTraceabilityLog);
            
            // Filtro por mês para osmose
            document.getElementById('apply-month-filter').addEventListener('click', applyMonthFilter);

            // Edit Modal
            document.getElementById('cancel-edit-btn').addEventListener('click', hideEditModal);
            document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
        }

        function setupOsmosisTabs() {
            const tabs = document.querySelectorAll('#osmosis-page .tab');
            const tabContents = document.querySelectorAll('#osmosis-page .tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(`${targetTab}-tab`).classList.add('active');
                });
            });
        }

        // Preencher o filtro de anos
        function populateYearFilter() {
            const yearSelect = document.getElementById('filter-year');
            const currentYear = new Date().getFullYear();
            
            // Limpar opções existentes
            yearSelect.innerHTML = '';
            
            // Adicionar opções para os últimos 5 anos
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (i === 0) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // Aplicar filtro por mês
        function applyMonthFilter() {
            const selectedMonth = document.getElementById('filter-month').value;
            const selectedYear = document.getElementById('filter-year').value;
            
            if (selectedMonth === 'all') {
                filteredOsmosisData = [...osmosisDailyData];
            } else {
                filteredOsmosisData = osmosisDailyData.filter(item => {
                    const itemDate = item.createdAt ? 
                        new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt) : null;
                    
                    if (!itemDate) return false;
                    
                    const itemMonth = String(itemDate.getMonth() + 1).padStart(2, '0');
                    const itemYear = itemDate.getFullYear();
                    
                    return itemMonth === selectedMonth && itemYear.toString() === selectedYear;
                });
            }
            
            loadOsmosisDetailedCards();
        }

        async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errorDiv = document.getElementById('login-error');
    const loginBtn = document.getElementById('login-btn');

    try {
        // Mostrar loading
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
        loginBtn.disabled = true;
        errorDiv.style.display = 'none';

        console.log('Tentando login com:', email);
        
        // Verificar se auth está inicializado
        if (!auth) {
            throw new Error('Sistema de autenticação não disponível');
        }
        
        // Tentar login
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('✅ Login bem-sucedido no Auth:', userCredential.user.uid);
        
        // Processar usuário
        await handleUserLogin(userCredential.user);
        
    } catch (error) {
        console.error('❌ Erro no login:', error);
        
        let errorMessage = '';
        
        switch(error.code) {
            case 'auth/invalid-email':
                errorMessage = 'Email inválido';
                break;
            case 'auth/user-disabled':
                errorMessage = 'Usuário desativado';
                break;
            case 'auth/user-not-found':
                errorMessage = 'Usuário não encontrado';
                break;
            case 'auth/wrong-password':
                errorMessage = 'Senha incorreta';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'Muitas tentativas. Tente novamente mais tarde.';
                break;
            case 'auth/network-request-failed':
                errorMessage = 'Erro de conexão. Verifique sua internet.';
                break;
            default:
                errorMessage = `Erro: ${error.message}`;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
        
        // Scroll para o erro
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
    } finally {
        // Restaurar botão
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
        loginBtn.disabled = false;
    }
}

        // ========== FUNÇÃO handleUserLogin() MELHORADA ==========
async function handleUserLogin(user) {
    console.log('=== PROCESSANDO LOGIN DO USUÁRIO ===');
    console.log('UID:', user.uid);
    console.log('Email:', user.email);
    
    // Desabilitar botão de login
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.disabled = true;
    }
    
    try {
        // Verificar se db está disponível
        if (!db) {
            throw new Error('Banco de dados não disponível');
        }
        
        // 1. BUSCAR DADOS DO USUÁRIO NO FIRESTORE
        console.log('Buscando usuário no Firestore...');
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (userDoc.exists) {
            // Usuário encontrado no Firestore
            const userData = userDoc.data();
            console.log('Usuário encontrado:', userData);
            
            // Verificar se usuário está ativo
            if (userData.status !== 'active') {
                await auth.signOut();
                throw new Error('Usuário desativado. Contate o administrador.');
            }
            
            currentUser = {
                uid: user.uid,
                email: user.email,
                ...userData
            };
            
            console.log('✅ Usuário carregado:', currentUser.name, currentUser.role);
            
        } else {
            // 2. CRIAR USUÁRIO PADRÃO SE NÃO EXISTIR
            console.log('Usuário não encontrado no Firestore, criando registro...');
            
            currentUser = {
                uid: user.uid,
                email: user.email,
                name: user.email.split('@')[0],
                role: 'user', // Papel padrão
                accessAreas: [], // Sem acesso por padrão
                receivesNotifications: false,
                status: 'active',
                createdAt: new Date(),
                firstLogin: true
            };
            
            // Salvar no Firestore
            await db.collection('users').doc(user.uid).set(currentUser);
            console.log('✅ Novo usuário criado no Firestore');
        }
        
        // 3. ATUALIZAR INTERFACE
        updateUI();
        
        // 4. CARREGAR DADOS INICIAIS
        await loadInitialData();
        
        // 5. ESCONDER MODAL DE LOGIN
        hideLoginModal();
        
        // 6. REGISTRAR LOGIN NA RASTREABILIDADE
        await addTraceability('Login no sistema', `Usuário ${currentUser.name} fez login`);
        
        // 7. MENSAGEM DE BOAS-VINDAS
        if (currentUser.firstLogin) {
            const roleName = {
                'admin': 'Administrador',
                'qualidade': 'Qualidade', 
                'manutencao': 'Manutenção',
                'user': 'Usuário Normal'
            }[currentUser.role] || currentUser.role;
            
            showInfo('Bem-vindo!', 
                `Olá ${currentUser.name}!\n\n` +
                `Sua conta foi configurada como: ${roleName}\n\n` +
                `Para alterar suas permissões, contate um administrador.`);
            
            // Remover flag de primeiro login
            await db.collection('users').doc(user.uid).update({
                firstLogin: false
            });
        }
        
        console.log('=== LOGIN CONCLUÍDO COM SUCESSO ===');
        
    } catch (error) {
        console.error('❌ Erro no processo de login:', error);
        
        // Fazer logout em caso de erro
        try {
            await auth.signOut();
        } catch (logoutError) {
            console.error('Erro ao fazer logout:', logoutError);
        }
        
        currentUser = null;
        
        // Mensagem de erro amigável
        let errorMessage = 'Erro ao processar login: ';
        
        if (error.message.includes('Firestore')) {
            errorMessage = 'Erro ao conectar com o banco de dados. Verifique sua conexão.';
        } else if (error.message.includes('desativado')) {
            errorMessage = error.message;
        } else if (error.code === 'permission-denied') {
            errorMessage = 'Acesso negado. Contate o administrador.';
        } else {
            errorMessage += error.message;
        }
        
        showError('Erro no Login', errorMessage);
        
        // Mostrar modal de login novamente
        showLoginModal();
        
    } finally {
        // Reabilitar botão de login
        if (loginBtn) {
            loginBtn.disabled = false;
        }
    }
}

        function handleLogout() {
            auth.signOut();
            currentUser = null;
            showLoginModal();
        }

// Atualize a função updateUI para lidar com múltiplos perfis:
function updateUI() {
    if (!currentUser) {
        console.error('Tentativa de atualizar UI sem usuário!');
        return;
    }
    
    console.log('Atualizando UI para usuário:', currentUser.name, 'Role:', currentUser.role);
    
    // Atualizar informações do usuário
    document.getElementById('current-user').textContent = currentUser.name;
    
    // Mapear nomes dos roles
    const roleNames = {
        'admin': 'Administrador',
        'qualidade': 'Qualidade',
        'manutencao': 'Manutenção',
        'user': 'Usuário'
    };
    
    document.getElementById('user-role').textContent = roleNames[currentUser.role] || currentUser.role;
    
    // Adicionar classe específica baseada no role
    document.getElementById('user-role').className = `user-role ${currentUser.role === 'admin' ? 'admin' : ''}`;
    document.getElementById('last-login').textContent = new Date().toLocaleTimeString('pt-BR');
    
    // Mostrar/ocultar elementos baseado no role
    if (currentUser.role === 'admin' || currentUser.role === 'qualidade') {
        document.body.classList.add('user-admin');
        document.getElementById('notification-btn').style.display = 'inline-flex';
        updateNotificationCount();
    } else {
        document.body.classList.remove('user-admin');
        document.getElementById('notification-btn').style.display = 'none';
    }
    
    // Atualizar visibilidade do menu
    updateMenuVisibility();
    
    // Atualizar página ativa
    const activePage = document.querySelector('.page-content.active');
    if (activePage) {
        const pageId = activePage.id.replace('-page', '');
        updatePageTitle(pageId);
    }
    
    // Recarregar dados para mostrar botões corretos
    setTimeout(() => {
        loadTemperatureHistory();
        loadPressureHistory();
        loadOsmosisHistory();
    }, 500);
}

// Atualize a função checkUserAccess para incluir o perfil qualidade:
function checkUserAccess(page) {
    if (!currentUser) return false;
    
    // Admin tem acesso a tudo
    if (currentUser.role === 'admin') return true;
    
    // Qualidade tem acesso amplo
    if (currentUser.role === 'qualidade') {
        // Qualidade pode acessar tudo exceto gerenciamento de usuários
        return page !== 'users';
    }
    
    // Manutenção tem acesso específico
    if (currentUser.role === 'manutencao') {
        const manutencaoAccess = ['temperature', 'pressure', 'osmosis', 'rooms'];
        return manutencaoAccess.includes(page);
    }
    
    // Usuário normal: verificar áreas de acesso configuradas
    const pageToArea = {
        'temperature': 'temperature',
        'pressure': 'pressure', 
        'osmosis': 'osmosis',
        'rooms': 'rooms',
        'users': 'users',
        'traceability': 'traceability',
        'reports': 'reports',
        'backup': 'backup'
    };
    
    const requiredArea = pageToArea[page];
    if (!requiredArea) return true;
    
    return currentUser.accessAreas && 
           Array.isArray(currentUser.accessAreas) && 
           currentUser.accessAreas.includes(requiredArea);
}



        function updatePageTitle(page) {
            const titles = {
                'temperature': 'Monitoramento de Temperatura e Umidade',
                'pressure': 'Monitoramento de Pressão',
                'osmosis': 'Sistema de Osmose',
                'rooms': 'Gerenciamento de Salas',
                'users': 'Gerenciamento de Usuários',
                'traceability': 'Rastreabilidade do Sistema',
                'reports': 'Relatórios do Sistema'
            };
            document.querySelector('.page-title').textContent = titles[page] || 'Sistema de Monitoramento';
        }

       async function loadInitialData() {
    console.log('Carregando dados iniciais...');
    
    try {
        // 1. Carregar salas
        await loadRooms();
        
        // 2. Carregar históricos (apenas se tiver acesso)
        if (checkUserAccess('temperature')) {
            loadTemperatureHistory();
        }
        
        if (checkUserAccess('pressure')) {
            loadPressureHistory();
        }
        
        if (checkUserAccess('osmosis')) {
            loadOsmosisHistory();
            loadMaintenanceHistory();
        }
        
        // 3. Se for admin/qualidade, carregar outros dados
        if (currentUser.role === 'admin' || currentUser.role === 'qualidade') {
            loadTraceabilityLog();
        }
        
        console.log('✅ Dados iniciais carregados');
        
    } catch (error) {
        console.error('Erro ao carregar dados iniciais:', error);
        showWarning('Aviso', 'Alguns dados não puderam ser carregados. Recarregue a página.');
    }
}

        async function loadRooms() {
            try {
                const roomsSnapshot = await db.collection('rooms')
                    .where('status', '==', 'active')
                    .get();
                
                rooms = [];
                roomsSnapshot.forEach(doc => {
                    rooms.push({ id: doc.id, ...doc.data() });
                });
                
                updateRoomsSelect();
                
            } catch (error) {
                console.error('Erro ao carregar salas:', error);
                // Continua mesmo com erro para não bloquear a aplicação
            }
        }

        function updateRoomsSelect() {
            const roomSelect = document.getElementById('room-select');
            const pressureRoomSelect = document.getElementById('pressure-room');
            
            roomSelect.innerHTML = '';
            pressureRoomSelect.innerHTML = '';
            
            if (rooms.length === 0) {
                roomSelect.innerHTML = '<option value="">Nenhuma sala cadastrada</option>';
                pressureRoomSelect.innerHTML = '<option value="">Nenhuma sala cadastrada</option>';
                return;
            }
            
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = `${room.code} - ${room.name}`;
                
                roomSelect.appendChild(option.cloneNode(true));
                pressureRoomSelect.appendChild(option);
            });
        }

// ========== FUNÇÃO saveTemperatureData() COMPLETA ==========
// ========== FUNÇÃO saveTemperatureData() COMPLETA ==========
async function saveTemperatureData() {
    console.log('=== SALVANDO DADOS DE TEMPERATURA ===');
    
    // 1. VERIFICAÇÃO DE PERMISSÃO
    if (!currentUser) {
        showError('Acesso Negado', 'Usuário não autenticado. Por favor, faça login novamente.');
        return;
    }
    
    // 2. COLETAR DADOS DO FORMULÁRIO
    const roomId = document.getElementById('room-select').value;
    const room = rooms.find(r => r.id === roomId);
    
    if (!room) {
        showWarning('Sala Inválida', 'Por favor, selecione uma sala válida da lista.');
        return;
    }
    
    const tempMin = parseFloat(document.getElementById('temp-min').value);
    const tempMax = parseFloat(document.getElementById('temp-max').value);
    const tempActual = parseFloat(document.getElementById('temp-atual').value);
    const humidityMin = parseFloat(document.getElementById('umid-min').value);
    const humidityMax = parseFloat(document.getElementById('umid-max').value);
    const humidityActual = parseFloat(document.getElementById('umid-atual').value);
    
    // 3. VALIDAÇÕES DETALHADAS
    const errors = [];
    
    if (isNaN(tempMin) || tempMin < -50 || tempMin > 100) {
        errors.push('Temp mínima fora do range (-50°C a 100°C)');
    }
    
    if (isNaN(tempMax) || tempMax < -50 || tempMax > 100) {
        errors.push('Temp máxima fora do range (-50°C a 100°C)');
    }
    
    if (isNaN(tempActual) || tempActual < -50 || tempActual > 100) {
        errors.push('Temp atual fora do range (-50°C a 100°C)');
    }
    
    if (tempMin > tempMax) {
        errors.push('Temp mínima > máxima');
    }
    
    if (tempActual < tempMin || tempActual > tempMax) {
        errors.push('Temp atual fora da faixa');
    }
    
    if (isNaN(humidityMin) || humidityMin < 0 || humidityMin > 100) {
        errors.push('Umid mínima fora do range (0% a 100%)');
    }
    
    if (isNaN(humidityMax) || humidityMax < 0 || humidityMax > 100) {
        errors.push('Umid máxima fora do range (0% a 100%)');
    }
    
    if (isNaN(humidityActual) || humidityActual < 0 || humidityActual > 100) {
        errors.push('Umid atual fora do range (0% a 100%)');
    }
    
    if (humidityMin > humidityMax) {
        errors.push('Umid mínima > máxima');
    }
    
    if (humidityActual < humidityMin || humidityActual > humidityMax) {
        errors.push('Umid atual fora da faixa');
    }
    
    if (errors.length > 0) {
        const errorMessage = 'Erros de validação:\n\n• ' + errors.join('\n• ');
        showError('Erro de Validação', errorMessage);
        return;
    }
    
    // 4. PREPARAR DADOS
    const data = {
        roomId: roomId,
        roomName: `${room.code} - ${room.name}`,
        period: document.getElementById('periodo').value,
        tempMin: tempMin,
        tempMax: tempMax,
        tempActual: tempActual,
        humidityMin: humidityMin,
        humidityMax: humidityMax,
        humidityActual: humidityActual,
        notes: document.getElementById('temp-notes').value,
        status: calculateTemperatureStatus(
            tempActual,
            humidityActual,
            room.tempMin,
            room.tempMax,
            room.humidityMin,
            room.humidityMax
        ),
        userId: currentUser.uid,
        userName: currentUser.name,
        userRole: currentUser.role,
        createdAt: new Date(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    console.log('Dados validados:', data);
    
    // 5. DESABILITAR BOTÃO
    const saveButton = document.getElementById('save-temp-btn');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    saveButton.disabled = true;
    
    try {
        // 6. SALVAR NO FIRESTORE
        const docRef = await db.collection('temperature_readings').add(data);
        console.log('Dados salvos com ID:', docRef.id);
        
        // 7. REGISTRAR RASTREABILIDADE
        await addTraceability(
            'Registro de temperatura', 
            `${data.roomName} (${data.period}): Temp: ${data.tempActual}°C, Umid: ${data.humidityActual}%`
        );
        
        // 8. VERIFICAR SE PRECISA CRIAR NOTIFICAÇÃO (PARA QUALQUER USUÁRIO)
        if (data.status === 'alert' || data.status === 'critical') {
            console.log(`⚠️ Status ${data.status} detectado - criando notificação automática`);
            await checkAndCreateNotification(data, 'temperature_readings', docRef.id);
        }
        
        // 9. MENSAGEM DE SUCESSO
        showSuccess('Sucesso', 'Dados de temperatura registrados com sucesso!', {
            onOk: () => {
                clearTemperatureForm();
                loadTemperatureHistory();
            }
        });
        
    } catch (error) {
        console.error('Erro ao salvar temperatura:', error);
        
        let errorMessage = 'Erro ao salvar dados: ';
        if (error.code === 'permission-denied') {
            errorMessage = 'Permissão negada. Você não tem autorização para esta operação.';
        } else {
            errorMessage += error.message;
        }
        
        showError('Erro', errorMessage);
        
    } finally {
        // 10. RESTAURAR BOTÃO
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    }
}

// Função auxiliar para limpar formulário de temperatura
function clearTemperatureForm() {
    document.getElementById('temp-min').value = '';
    document.getElementById('temp-max').value = '';
    document.getElementById('temp-atual').value = '';
    document.getElementById('umid-min').value = '';
    document.getElementById('umid-max').value = '';
    document.getElementById('umid-atual').value = '';
    document.getElementById('temp-notes').value = '';
}

// Função auxiliar para calcular status de temperatura
function calculateTemperatureStatus(temperature, humidity, tempMin, tempMax, humidityMin, humidityMax) {
    if (!tempMin || !tempMax || !humidityMin || !humidityMax) {
        return 'normal'; // Fallback se não houver parâmetros definidos
    }

    const tempInRange = temperature >= tempMin && temperature <= tempMax;
    const humidityInRange = humidity >= humidityMin && humidity <= humidityMax;

    if (tempInRange && humidityInRange) {
        return 'normal';
    } else if ((temperature >= tempMin - 1 && temperature <= tempMax + 1) || 
               (humidity >= humidityMin - 5 && humidity <= humidityMax + 5)) {
        return 'alert';
    } else {
        return 'critical';
    }
}

// Função auxiliar para obter texto do status
function getStatusText(status) {
    const statusMap = {
        'normal': 'Normal',
        'alert': 'Alerta', 
        'critical': 'Crítico'
    };
    return statusMap[status] || status;
}
   async function savePressureData() {
    if (!currentUser) {
        showError('Acesso Negado', 'Usuário não autenticado. Por favor, faça login novamente.');
        return;
    }
    
    const roomId = document.getElementById('pressure-room').value;
    const room = rooms.find(r => r.id === roomId);
    
    if (!room) {
        showWarning('Sala Inválida', 'Por favor, selecione uma sala válida.');
        return;
    }

    const pressureValue = parseInt(document.getElementById('pressure-value').value);

    if (isNaN(pressureValue)) {
        showWarning('Dado Inválido', 'Por favor, preencha o campo de pressão com um valor numérico válido.');
        return;
    }

    const data = {
        roomId: roomId,
        roomName: `${room.code} - ${room.name}`,
        period: document.getElementById('pressure-periodo').value,
        pressure: pressureValue,
        immediateCorrection: document.getElementById('correcao-imediata').value,
        notes: document.getElementById('pressure-notes').value,
        status: calculatePressureStatus(pressureValue, room.pressureMin),
        userId: currentUser.uid,
        userName: currentUser.name,
        createdAt: new Date(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        const docRef = await db.collection('pressure_readings').add(data);
        
        await addTraceability(
            'Registro de pressão', 
            `${data.roomName}: ${data.pressure} Pa`
        );
        
        // Verificar se precisa criar notificação
        if (data.status === 'alert' || data.status === 'critical') {
            console.log(`⚠️ Status ${data.status} detectado - criando notificação automática`);
            await checkAndCreateNotification(data, 'pressure_readings', docRef.id);
        }
        
        showSuccess('Sucesso', 'Dados de pressão registrados com sucesso!', {
            onOk: () => {
                clearPressureForm();
                loadPressureHistory();
            }
        });
        
    } catch (error) {
        console.error('Erro ao salvar pressão:', error);
        showError('Erro', 'Erro ao salvar dados de pressão: ' + error.message);
    }
}

  async function saveOsmosisDaily() {
    if (!currentUser) {
        showError('Acesso Negado', 'Usuário não autenticado. Por favor, faça login novamente.');
        return;
    }

    const conductivity = parseFloat(document.getElementById('condutividade').value);

    if (isNaN(conductivity)) {
        showWarning('Dado Inválido', 'Por favor, preencha o campo de condutividade com um valor numérico válido.');
        return;
    }

    const data = {
        conductivity: conductivity,
        conductivityStatus: calculateConductivityStatus(conductivity),
        lastSanitization: document.getElementById('ultima-sanitizacao').value,
        nextSanitization: document.getElementById('proxima-sanitizacao').value,
        lastCleaning: document.getElementById('ultima-higienizacao').value,
        nextCleaning: document.getElementById('proxima-higienizacao').value,
        lastCollection: document.getElementById('ultima-coleta').value,
        nextCollection: document.getElementById('proxima-coleta').value,
        hasAbnormality: document.querySelector('input[name="anormalidade"]:checked').value === 'sim',
        abnormalityReason: document.getElementById('motivo-anormalidade').value,
        lastFilterChange: {
            fpp001: document.getElementById('ultima-fpp001').value,
            fca001: document.getElementById('ultima-fca001').value,
            drm001: document.getElementById('ultima-drm001').value,
            drm002: document.getElementById('ultima-drm002').value
        },
        nextFilterChange: {
            fpp001: document.getElementById('proxima-fpp001').value,
            fca001: document.getElementById('proxima-fca001').value,
            drm001: document.getElementById('proxima-drm001').value,
            drm002: document.getElementById('proxima-drm002').value
        },
        notes: document.getElementById('osmosis-daily-notes').value,
        userId: currentUser.uid,
        userName: currentUser.name,
        createdAt: new Date(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        const docRef = await db.collection('osmosis_daily').add(data);
        
        await addTraceability(
            'Controle diário de osmose', 
            `Condutividade: ${data.conductivity} µS/cm`
        );
        
        // Verificar se precisa criar notificação
        if (data.conductivityStatus === 'alert' || data.conductivityStatus === 'critical') {
            console.log(`⚠️ Status ${data.conductivityStatus} detectado - criando notificação automática`);
            await checkAndCreateNotification(data, 'osmosis_daily', docRef.id);
        }
        
        showSuccess('Sucesso', 'Controle diário do sistema de osmose registrado com sucesso!', {
            onOk: () => {
                clearOsmosisDailyForm();
                loadOsmosisHistory();
            }
        });
        
    } catch (error) {
        console.error('Erro ao salvar osmose diária:', error);
        showError('Erro', 'Erro ao salvar dados de osmose diária: ' + error.message);
    }
}

   async function saveOsmosisMaintenance() {
    if (!currentUser) {
        showError('Acesso Negado', 'Usuário não autenticado. Por favor, faça login novamente.');
        return;
    }
    
    const procedure = document.getElementById('procedimento').value;
    const maintenanceDate = document.getElementById('data-manutencao').value;

    if (!procedure || !maintenanceDate) {
        showWarning('Campos Obrigatórios', 'Por favor, preencha todos os campos obrigatórios.');
        return;
    }

    const data = {
        procedure: procedure,
        maintenanceDate: maintenanceDate,
        observations: document.getElementById('obs-manutencao').value,
        userId: currentUser.uid,
        userName: currentUser.name,
        createdAt: new Date(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        const docRef = await db.collection('osmosis_maintenance').add(data);
        
        await addTraceability(
            'Manutenção de osmose', 
            `Procedimento: ${data.procedure.substring(0, 50)}...`
        );
        
        showSuccess('Sucesso', 'Manutenção do sistema de osmose registrada com sucesso!', {
            onOk: () => {
                clearMaintenanceForm();
                loadMaintenanceHistory();
            }
        });
        
    } catch (error) {
        console.error('Erro ao salvar manutenção de osmose:', error);
        showError('Erro', 'Erro ao salvar dados de manutenção: ' + error.message);
    }
}

 async function addRoom() {
    if (currentUser.role !== 'admin') {
        showWarning('Permissão Insuficiente', 'Apenas administradores podem adicionar salas.');
        return;
    }

    const code = document.getElementById('room-code').value;
    const name = document.getElementById('room-name').value;
    const responsible = document.getElementById('room-responsible').value;
    const tempMin = parseFloat(document.getElementById('temp-min-room').value);
    const tempMax = parseFloat(document.getElementById('temp-max-room').value);
    const humidityMin = parseFloat(document.getElementById('umid-min-room').value);
    const humidityMax = parseFloat(document.getElementById('umid-max-room').value);
    const pressureMin = parseInt(document.getElementById('pressure-value-min').value);

    if (!code || !name || !responsible || isNaN(tempMin) || isNaN(tempMax) || 
        isNaN(humidityMin) || isNaN(humidityMax) || isNaN(pressureMin)) {
        showWarning('Campos Obrigatórios', 'Por favor, preencha todos os campos obrigatórios com valores válidos.');
        return;
    }

    const data = {
        code: code,
        name: name,
        type: document.getElementById('room-type').value,
        responsible: responsible,
        tempMin: tempMin,
        tempMax: tempMax,
        humidityMin: humidityMin,
        humidityMax: humidityMax,
        pressureMin: pressureMin,
        description: document.getElementById('room-description').value,
        status: 'active',
        createdAt: new Date(),
        createdBy: currentUser.uid,
        createdByName: currentUser.name
    };

    try {
        await db.collection('rooms').add(data);
        await addTraceability(
            'Adição de sala', 
            `${data.name} (${data.code}) adicionada`
        );
        
        showSuccess('Sucesso', 'Sala adicionada com sucesso!', {
            onOk: () => {
                clearRoomForm();
                loadRooms();
                loadRoomsList();
            }
        });
        
    } catch (error) {
        console.error('Erro ao adicionar sala:', error);
        showError('Erro', 'Erro ao adicionar sala: ' + error.message);
    }
}

        // ========== FUNÇÕES DE EDIÇÃO E EXCLUSÃO ==========

        async function editTemperatureReading(docId) {
    try {
        console.log(`Editando temperatura: ${docId}`);
        
        // Verificar se db está disponível
        if (!db) {
            showError('Sistema', 'Banco de dados não disponível.');
            return;
        }
        
        const doc = await db.collection('temperature_readings').doc(docId).get();
        
        if (!doc.exists) {
            showError('Registro', 'Registro não encontrado!');
            return;
        }

        const data = doc.data();
        currentEditData = { 
            collection: 'temperature_readings', 
            id: docId, 
            data: data 
        };

        const modalContent = `
            <div class="form-group">
                <label for="edit-temp-min">Temperatura Mínima (°C):</label>
                <input type="number" id="edit-temp-min" step="0.1" value="${data.tempMin || ''}">
            </div>
            <div class="form-group">
                <label for="edit-temp-max">Temperatura Máxima (°C):</label>
                <input type="number" id="edit-temp-max" step="0.1" value="${data.tempMax || ''}">
            </div>
            <div class="form-group">
                <label for="edit-temp-atual">Temperatura Atual (°C):</label>
                <input type="number" id="edit-temp-atual" step="0.1" value="${data.tempActual || ''}">
            </div>
            <div class="form-group">
                <label for="edit-umid-min">Umidade Mínima (%):</label>
                <input type="number" id="edit-umid-min" step="0.1" value="${data.humidityMin || ''}">
            </div>
            <div class="form-group">
                <label for="edit-umid-max">Umidade Máxima (%):</label>
                <input type="number" id="edit-umid-max" step="0.1" value="${data.humidityMax || ''}">
            </div>
            <div class="form-group">
                <label for="edit-umid-atual">Umidade Atual (%):</label>
                <input type="number" id="edit-umid-atual" step="0.1" value="${data.humidityActual || ''}">
            </div>
            <div class="form-group">
                <label for="edit-temp-notes">Observações:</label>
                <textarea id="edit-temp-notes" rows="3">${data.notes || ''}</textarea>
            </div>
        `;

        document.getElementById('edit-modal-title').textContent = 'Editar Leitura de Temperatura';
        document.getElementById('edit-modal-content').innerHTML = modalContent;
        showEditModal();

    } catch (error) {
        console.error('Erro ao carregar dados para edição:', error);
        showError('Erro', `Erro ao carregar dados: ${error.message}`);
    }
}

        async function editPressureReading(docId) {
            try {
                const doc = await db.collection('pressure_readings').doc(docId).get();
                if (!doc.exists) {
                    alert('Registro não encontrado!');
                    return;
                }

                const data = doc.data();
                currentEditData = { collection: 'pressure_readings', id: docId, data: data };

                const modalContent = `
                    <div class="form-group">
                        <label for="edit-pressure-value">Pressão (Pa):</label>
                        <input type="number" id="edit-pressure-value" step="1" value="${data.pressure || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-correcao-imediata">Correção Imediata:</label>
                        <textarea id="edit-correcao-imediata" rows="3">${data.immediateCorrection || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-pressure-notes">Observações:</label>
                        <textarea id="edit-pressure-notes" rows="3">${data.notes || ''}</textarea>
                    </div>
                `;

                document.getElementById('edit-modal-title').textContent = 'Editar Leitura de Pressão';
                document.getElementById('edit-modal-content').innerHTML = modalContent;
                showEditModal();

            } catch (error) {
                console.error('Erro ao carregar dados para edição:', error);
                alert('Erro ao carregar dados para edição');
            }
        }

        async function editRoom(docId) {
            try {
                const doc = await db.collection('rooms').doc(docId).get();
                if (!doc.exists) {
                    alert('Sala não encontrada!');
                    return;
                }

                const data = doc.data();
                currentEditData = { collection: 'rooms', id: docId, data: data };

                const modalContent = `
                    <div class="form-group">
                        <label for="edit-room-name">Nome da Sala:</label>
                        <input type="text" id="edit-room-name" value="${data.name || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-room-code">Código da Sala:</label>
                        <input type="text" id="edit-room-code" value="${data.code || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-room-type">Tipo de Sala:</label>
                        <select id="edit-room-type">
                            <option value="estoque" ${data.type === 'estoque' ? 'selected' : ''}>Estoque</option>
                            <option value="preparacao" ${data.type === 'preparacao' ? 'selected' : ''}>Preparação</option>
                            <option value="producao" ${data.type === 'producao' ? 'selected' : ''}>Produção</option>
                            <option value="embalagem" ${data.type === 'embalagem' ? 'selected' : ''}>Embalagem</option>
                            <option value="qualidade" ${data.type === 'qualidade' ? 'selected' : ''}>Controle de Qualidade</option>
                            <option value="outro" ${data.type === 'outro' ? 'selected' : ''}>Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-room-responsible">Responsável:</label>
                        <input type="text" id="edit-room-responsible" value="${data.responsible || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-min-room">Temperatura Mínima (°C):</label>
                        <input type="number" id="edit-temp-min-room" step="0.1" value="${data.tempMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-temp-max-room">Temperatura Máxima (°C):</label>
                        <input type="number" id="edit-temp-max-room" step="0.1" value="${data.tempMax || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-min-room">Umidade Mínima (%):</label>
                        <input type="number" id="edit-umid-min-room" step="0.1" value="${data.humidityMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-umid-max-room">Umidade Máxima (%):</label>
                        <input type="number" id="edit-umid-max-room" step="0.1" value="${data.humidityMax || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-pressure-value-min">Pressão Mínima (Pa):</label>
                        <input type="number" id="edit-pressure-value-min" value="${data.pressureMin || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-room-description">Descrição:</label>
                        <textarea id="edit-room-description" rows="3">${data.description || ''}</textarea>
                    </div>
                `;

                document.getElementById('edit-modal-title').textContent = 'Editar Sala';
                document.getElementById('edit-modal-content').innerHTML = modalContent;
                showEditModal();

            } catch (error) {
                console.error('Erro ao carregar dados para edição:', error);
                alert('Erro ao carregar dados para edição');
            }
        }

       async function saveEdit() {
    console.log('=== INICIANDO SAVE EDIT ===');
    
    if (!currentEditData) {
        console.error('Nenhum dado para editar!');
        showError('Erro', 'Nenhum dado selecionado para edição.');
        return;
    }
    
    // Verificar se Firebase está inicializado
    if (!db) {
        console.error('Firebase Firestore não inicializado!');
        showError('Erro do Sistema', 'Banco de dados não disponível. Recarregue a página.');
        return;
    }
    
    // Verificar se usuário está autenticado
    if (!currentUser || !currentUser.uid) {
        console.error('Usuário não autenticado!');
        showError('Sessão Expirada', 'Faça login novamente.');
        hideEditModal();
        showLoginModal();
        return;
    }
    
    try {
        let updateData = {};
        const collection = currentEditData.collection;
        const docId = currentEditData.id;
        const originalData = currentEditData.data;
        
        console.log(`Editando: ${collection}/${docId}`);
        
        switch(collection) {
            case 'temperature_readings':
                const tempMin = parseFloat(document.getElementById('edit-temp-min').value);
                const tempMax = parseFloat(document.getElementById('edit-temp-max').value);
                const tempActual = parseFloat(document.getElementById('edit-temp-atual').value);
                const humidityMin = parseFloat(document.getElementById('edit-umid-min').value);
                const humidityMax = parseFloat(document.getElementById('edit-umid-max').value);
                const humidityActual = parseFloat(document.getElementById('edit-umid-atual').value);
                
                if (isNaN(tempMin) || isNaN(tempMax) || isNaN(tempActual) || 
                    isNaN(humidityMin) || isNaN(humidityMax) || isNaN(humidityActual)) {
                    throw new Error('Todos os campos devem ser números válidos');
                }
                
                updateData = {
                    tempMin: tempMin,
                    tempMax: tempMax,
                    tempActual: tempActual,
                    humidityMin: humidityMin,
                    humidityMax: humidityMax,
                    humidityActual: humidityActual,
                    notes: document.getElementById('edit-temp-notes').value || '',
                    status: calculateTemperatureStatus(
                        tempActual,
                        humidityActual,
                        originalData.tempMin,
                        originalData.tempMax,
                        originalData.humidityMin,
                        originalData.humidityMax
                    ),
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid,
                    updatedByName: currentUser.name
                };
                break;
                
            case 'pressure_readings':
                const pressure = parseInt(document.getElementById('edit-pressure-value').value);
                
                if (isNaN(pressure)) {
                    throw new Error('Pressão deve ser um número válido');
                }
                
                updateData = {
                    pressure: pressure,
                    immediateCorrection: document.getElementById('edit-correcao-imediata').value || '',
                    notes: document.getElementById('edit-pressure-notes').value || '',
                    status: calculatePressureStatus(pressure, originalData.pressureMin),
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid,
                    updatedByName: currentUser.name
                };
                break;
                
            case 'rooms':
                const roomName = document.getElementById('edit-room-name').value.trim();
                const roomCode = document.getElementById('edit-room-code').value.trim();
                
                if (!roomName || !roomCode) {
                    throw new Error('Nome e código da sala são obrigatórios');
                }
                
                updateData = {
                    name: roomName,
                    code: roomCode,
                    type: document.getElementById('edit-room-type').value,
                    responsible: document.getElementById('edit-room-responsible').value || '',
                    tempMin: parseFloat(document.getElementById('edit-temp-min-room').value) || 18.0,
                    tempMax: parseFloat(document.getElementById('edit-temp-max-room').value) || 26.0,
                    humidityMin: parseFloat(document.getElementById('edit-umid-min-room').value) || 40.0,
                    humidityMax: parseFloat(document.getElementById('edit-umid-max-room').value) || 60.0,
                    pressureMin: parseInt(document.getElementById('edit-pressure-value-min').value) || 5,
                    description: document.getElementById('edit-room-description').value || '',
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid,
                    updatedByName: currentUser.name
                };
                break;
                
            case 'users':
                const editUserName = document.getElementById('edit-user-name').value.trim();
                const editUserRole = document.getElementById('edit-user-role').value;
                const editUserStatus = document.getElementById('edit-user-status').value;
                
                if (!editUserName) {
                    throw new Error('Nome do usuário é obrigatório');
                }
                
                // Dados básicos do usuário
                updateData = {
                    name: editUserName,
                    role: editUserRole, // AGORA VAI MUDAR CORRETAMENTE O ROLE
                    status: editUserStatus,
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid,
                    updatedByName: currentUser.name
                };
                
                // Adicionar áreas de acesso se não for admin
                if (editUserRole !== 'admin') {
                    const editCheckboxes = document.querySelectorAll('#edit-access-control-section input[type="checkbox"]:checked');
                    const editAccessAreas = Array.from(editCheckboxes).map(cb => cb.value);
                    updateData.accessAreas = editAccessAreas;
                    
                    // Verificar se usuário recebe notificações (apenas para admin/qualidade/manutenção)
                    const receivesNotifications = document.getElementById('edit-receives-notifications')?.checked || false;
                    if (['admin', 'qualidade', 'manutencao'].includes(editUserRole)) {
                        updateData.receivesNotifications = receivesNotifications;
                    }
                } else {
                    // Admin tem acesso a tudo
                    updateData.accessAreas = ['temperature', 'pressure', 'osmosis', 'rooms', 'traceability', 'reports', 'backup', 'users'];
                    updateData.receivesNotifications = true; // Admin sempre recebe notificações
                }
                break;
                
            default:
                throw new Error(`Coleção não suportada: ${collection}`);
        }
        
        console.log('Dados para atualizar:', updateData);
        
        // Desabilitar botão durante o salvamento
        const saveButton = document.getElementById('save-edit-btn');
        const originalButtonText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        saveButton.disabled = true;
        
        // Salvar no Firestore
        const docRef = db.collection(collection).doc(docId);
        await docRef.update(updateData);
        
        console.log('✅ Edição salva com sucesso!');
        
        // Registrar rastreabilidade
        await addTraceability(
            `Edição de ${collection.replace('_', ' ')}`,
            `Registro ${docId} atualizado`
        );
        
        // Mostrar sucesso
        showSuccess('Sucesso', 'Registro atualizado com sucesso!', {
            onOk: () => {
                hideEditModal();
                
                // Recarregar dados da página atual
                switch(collection) {
                    case 'temperature_readings':
                        loadTemperatureHistory();
                        break;
                    case 'pressure_readings':
                        loadPressureHistory();
                        break;
                    case 'rooms':
                        loadRoomsList();
                        loadRooms();
                        break;
                    case 'users':
                        loadUsersList(); // Recarregar lista de usuários
                        if (currentUser.uid === docId) {
                            // Se usuário editou a si mesmo, recarregar dados
                            handleUserLogin({ uid: docId, email: originalData.email });
                        }
                        break;
                    case 'osmosis_daily':
                        loadOsmosisHistory();
                        break;
                    case 'osmosis_maintenance':
                        loadMaintenanceHistory();
                        break;
                }
            }
        });
        
    } catch (error) {
        console.error('❌ Erro ao salvar edição:', error);
        
        let errorMessage = 'Erro ao salvar alterações: ';
        
        if (error.code === 'permission-denied') {
            errorMessage = 'Permissão negada. Você não tem autorização para esta operação.';
        } else if (error.code === 'not-found') {
            errorMessage = 'Registro não encontrado no banco de dados.';
        } else if (error.code === 'failed-precondition') {
            errorMessage = 'Registro foi modificado por outro usuário. Recarregue os dados.';
        } else {
            errorMessage += error.message;
        }
        
        showError('Erro', errorMessage);
        
        // Restaurar botão
        const saveButton = document.getElementById('save-edit-btn');
        saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar';
        saveButton.disabled = false;
    }
}

   async function deleteRecord(collection, docId, confirmationMessage) {
    // Usar modal de confirmação
    const confirm = await showConfirm(confirmationMessage || 'Tem certeza que deseja excluir este registro?\n\nEsta ação não pode ser desfeita.');
    
    if (!confirm) {
        showInfo('Cancelado', 'A exclusão foi cancelada.');
        return;
    }

    try {
        await db.collection(collection).doc(docId).delete();
        
        await addTraceability(
            `Exclusão de ${collection.replace('_', ' ')}`, 
            `Registro ${docId} excluído`
        );

        showSuccess('Sucesso', 'Registro excluído com sucesso!', {
            onOk: () => {
                // Recarregar dados
                switch(collection) {
                    case 'temperature_readings':
                        loadTemperatureHistory();
                        break;
                    case 'pressure_readings':
                        loadPressureHistory();
                        break;
                    case 'rooms':
                        loadRoomsList();
                        loadRooms();
                        break;
                    case 'osmosis_daily':
                        loadOsmosisHistory();
                        break;
                    case 'osmosis_maintenance':
                        loadMaintenanceHistory();
                        break;
                }
            }
        });

    } catch (error) {
        console.error('Erro ao excluir registro:', error);
        showError('Erro', 'Erro ao excluir registro: ' + error.message);
    }
}

        // ========== GERENCIAMENTO DE USUÁRIOS ==========

        // ========== FUNÇÃO addUser() CORRIGIDA ==========
async function addUser() {
    if (currentUser.role !== 'admin') {
        showWarning('Permissão Insuficiente', 'Apenas administradores podem adicionar usuários.');
        return;
    }

    const name = document.getElementById('user-name').value.trim();
    const email = document.getElementById('user-email').value.trim();
    const password = document.getElementById('user-password').value;
    const role = document.getElementById('user-role').value;

    console.log('Dados do formulário:', { name, email, password: '***', role });

    if (!name || !email || !password) {
        showWarning('Campos Obrigatórios', 'Por favor, preencha todos os campos obrigatórios.');
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showWarning('Email Inválido', 'Por favor, insira um email válido.');
        return;
    }

    if (password.length < 6) {
        showWarning('Senha Fraca', 'A senha deve ter pelo menos 6 caracteres.');
        return;
    }

    const userRole = role || 'user';
    
    const confirmMessage = `Criar novo usuário?\n\nNome: ${name}\nEmail: ${email}\nTipo: ${userRole === 'admin' ? 'Administrador' : userRole === 'qualidade' ? 'Qualidade' : userRole === 'manutencao' ? 'Manutenção' : 'Usuário Normal'}`;
    
    const confirm = await showConfirm(confirmMessage);
    
    if (!confirm) {
        showInfo('Cancelado', 'A criação do usuário foi cancelada.');
        return;
    }

    const addButton = document.getElementById('add-user-btn');
    const originalText = addButton.innerHTML;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando usuário...';
    addButton.disabled = true;

    try {
        const existingUser = await checkUserExists(email);
        if (existingUser) {
            throw new Error('Este email já está cadastrado no sistema.');
        }

        const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE';
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${API_KEY}`;
        
        console.log('Criando usuário no Firebase Auth...');

        const authResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password,
                returnSecureToken: true
            })
        });

        const authData = await authResponse.json();
        console.log('Resposta do Firebase Auth:', authData);

        if (!authResponse.ok) {
            if (authData.error?.message === 'EMAIL_EXISTS') {
                console.log('Usuário já existe no Auth, tentando recuperar...');
                await handleExistingAuthUser(email, name, userRole);
            } else {
                const errorMessage = getFirebaseAuthErrorMessage(authData.error?.message);
                throw new Error(errorMessage);
            }
        } else {
            const userId = authData.localId;
            console.log('Usuário criado no Auth com ID:', userId);
            
            // Determinar áreas de acesso baseado no role
            let accessAreas = [];
            let receivesNotifications = false;
            
            if (userRole === 'admin') {
                accessAreas = ['temperature', 'pressure', 'osmosis', 'rooms', 'traceability', 'reports', 'backup', 'users'];
                receivesNotifications = true;
            } else {
                // Para não-admins, coletar áreas selecionadas
                const checkboxes = document.querySelectorAll('input[name="access-areas"]:checked');
                accessAreas = Array.from(checkboxes).map(cb => cb.value);
                
                // Verificar se recebe notificações (apenas para qualidade/manutenção)
                const notificationsCheckbox = document.getElementById('receives-notifications');
                if (['qualidade', 'manutencao'].includes(userRole) && notificationsCheckbox) {
                    receivesNotifications = notificationsCheckbox.checked;
                }
            }
            
            // Salvar no Firestore com áreas de acesso e notificações
            await saveUserToFirestore(userId, name, email, userRole, accessAreas, receivesNotifications);
        }

        await addTraceability(
            'Criação de usuário', 
            `Usuário ${name} (${email}) criado como ${userRole}`
        );
        
        alert(`✅ Usuário "${name}" criado com sucesso!\n\nEmail: ${email}`);
        clearUserForm();
        
        await loadUsersList();
        
    } catch (error) {
        console.error('Erro ao criar usuário:', error);
        alert('❌ Erro ao criar usuário: ' + error.message);
    } finally {
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    }
}


// FUNÇÃO PRINCIPAL: Criar usuário via REST API do Firebase
async function createUserWithRestAPI(email, password, name, role) {
    // Obter a API KEY do seu projeto Firebase
    const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE'; // Sua chave já está no firebaseConfig
    
    // URL da API do Firebase Auth
    const url = `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${API_KEY}`;
    
    try {
        // 1. Criar o usuário no Firebase Authentication
        const authResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password,
                returnSecureToken: true
            })
        });

        const authData = await authResponse.json();

        if (!authResponse.ok) {
            // Tratar erros específicos do Firebase Auth
            const errorMessage = getFirebaseAuthErrorMessage(authData.error?.message);
            return { success: false, error: errorMessage };
        }

        const userId = authData.localId;

        // 2. Salvar dados adicionais no Firestore
        const userData = {
            name: name,
            email: email,
            role: role,
            createdAt: new Date(),
            status: 'active',
            createdBy: currentUser.uid,
            createdByName: currentUser.name,
            uid: userId // Garantir que o UID está salvo
        };

        await db.collection('users').doc(userId).set(userData);

        return { success: true, userId: userId };

    } catch (error) {
        console.error('Erro na REST API:', error);
        return { success: false, error: error.message };
    }
}

// Função para traduzir mensagens de erro do Firebase
function getFirebaseAuthErrorMessage(errorCode) {
    const errorMessages = {
        'EMAIL_EXISTS': 'Este email já está em uso por outro usuário.',
        'OPERATION_NOT_ALLOWED': 'A criação de usuários não está habilitada.',
        'TOO_MANY_ATTEMPTS_TRY_LATER': 'Muitas tentativas. Tente novamente mais tarde.',
        'INVALID_EMAIL': 'O endereço de email é inválido.',
        'WEAK_PASSWORD': 'A senha é muito fraca. Use pelo menos 6 caracteres.',
        'MISSING_PASSWORD': 'A senha é obrigatória.',
        'EMAIL_NOT_FOUND': 'Email não encontrado.',
        'INVALID_PASSWORD': 'Senha incorreta.',
        'USER_DISABLED': 'Esta conta foi desativada.'
    };

    // Extrair o código do erro (ex: "EMAIL_EXISTS" de "auth/email-exists")
    let code = errorCode;
    if (errorCode && errorCode.includes('/')) {
        code = errorCode.split('/')[1].toUpperCase().replace(/-/g, '_');
    }

    return errorMessages[code] || `Erro: ${errorCode || 'Erro desconhecido'}`;
}

// Função auxiliar para verificar se um usuário já existe
async function checkUserExists(email) {
    try {
        // Verificar no Firestore
        const userSnapshot = await db.collection('users')
            .where('email', '==', email)
            .limit(1)
            .get();
        
        return !userSnapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar usuário:', error);
        return false;
    }
}

// Versão alternativa caso a REST API tenha problemas
async function createUserAlternative(email, password, name, role) {
    try {
        // Esta é uma abordagem de fallback que pede a senha do admin
        // mas só é usada se a REST API falhar
        
        const adminPassword = prompt(
            'Para maior segurança, digite sua senha de administrador para confirmar a criação do usuário:'
        );

        if (!adminPassword) {
            throw new Error('Operação cancelada pelo usuário.');
        }

        // Verificar se a senha do admin está correta
        const adminEmail = currentUser.email;
        
        // Tentar fazer login para validar a senha
        const tempAuth = firebase.auth();
        await tempAuth.signInWithEmailAndPassword(adminEmail, adminPassword);
        
        // Se chegou aqui, a senha está correta
        // Agora criar o usuário
        const userCredential = await tempAuth.createUserWithEmailAndPassword(email, password);
        const newUser = userCredential.user;

        // Salvar dados no Firestore
        const userData = {
            name: name,
            email: email,
            role: role,
            createdAt: new Date(),
            status: 'active',
            createdBy: currentUser.uid,
            createdByName: currentUser.name
        };

        await db.collection('users').doc(newUser.uid).set(userData);

        // Fazer logout do usuário criado e refazer login como admin
        await tempAuth.signOut();
        await auth.signInWithEmailAndPassword(adminEmail, adminPassword);

        return { success: true, userId: newUser.uid };

    } catch (error) {
        return { success: false, error: error.message };
    }
}

// Função principal atualizada com fallback
async function addUser() {
    if (currentUser.role !== 'admin') {
        alert('Apenas administradores podem adicionar usuários.');
        return;
    }

    const name = document.getElementById('user-name').value.trim();
    const email = document.getElementById('user-email').value.trim();
    const password = document.getElementById('user-password').value;
    const role = document.getElementById('user-role').value;

    console.log('Dados do formulário:', { name, email, password: '***', role });

    if (!name || !email || !password) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }

    // Validar formato do email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Por favor, insira um email válido.');
        return;
    }

    // Validar senha
    if (password.length < 6) {
        alert('A senha deve ter pelo menos 6 caracteres.');
        return;
    }

    // Garantir que role tem um valor válido
    const userRole = role || 'user';
    console.log('Role definido como:', userRole);

    // Desabilitar botão durante o processo
    const addButton = document.getElementById('add-user-btn');
    const originalText = addButton.innerHTML;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando usuário...';
    addButton.disabled = true;

    try {
        // SOLUÇÃO CORRIGIDA: Verificar se usuário já existe no Firestore
        const existingUser = await checkUserExists(email);
        if (existingUser) {
            throw new Error('Este email já está cadastrado no sistema.');
        }

        const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE';
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${API_KEY}`;
        
        console.log('Criando usuário no Firebase Auth...');

        // 1. Criar usuário no Firebase Authentication
        const authResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password,
                returnSecureToken: true
            })
        });

        const authData = await authResponse.json();
        console.log('Resposta do Firebase Auth:', authData);

        if (!authResponse.ok) {
            // Se o usuário já existe no Auth mas não no Firestore, vamos recuperar
            if (authData.error?.message === 'EMAIL_EXISTS') {
                console.log('Usuário já existe no Auth, tentando recuperar...');
                await handleExistingAuthUser(email, name, userRole);
            } else {
                const errorMessage = getFirebaseAuthErrorMessage(authData.error?.message);
                throw new Error(errorMessage);
            }
        } else {
            // Usuário criado com sucesso no Auth
            const userId = authData.localId;
            console.log('Usuário criado no Auth com ID:', userId);
            await saveUserToFirestore(userId, name, email, userRole);
        }

        await addTraceability(
            'Criação de usuário', 
            `Usuário ${name} (${email}) criado como ${userRole}`
        );
        
        // CORREÇÃO COMPLETA: Mensagem de sucesso sem nenhuma referência à senha
        alert(`✅ Usuário criado com sucesso!\n\n• Nome: ${name}\n• Email: ${email}`);
        clearUserForm();
        
        // Recarregar lista de usuários
        await loadUsersList();
        
    } catch (error) {
        console.error('Erro ao criar usuário:', error);
        alert('❌ Erro ao criar usuário: ' + error.message);
    } finally {
        // Restaurar botão
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    }
}

// CORREÇÃO COMPLETA: Função para lidar com usuário existente sem expor senhas
async function handleExistingAuthUser(email, name, role) {
    console.log('Tentando recuperar usuário existente no Auth...');
    
    // Pedir senha com modal de confirmação
    const confirm = await showConfirm(`O usuário ${email} já existe na autenticação.\n\nPara vincular esta conta ao sistema, digite a senha do usuário:`);
    
    if (!confirm) {
        showInfo('Cancelado', 'Operação cancelada. É necessária a senha para recuperar o usuário.');
        return;
    }

    try {
        const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE';
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${API_KEY}`;
        
        // Pedir senha (simplificado - em produção use um modal com campo de senha)
        const userPassword = prompt('Digite a senha do usuário:');
        
        if (!userPassword) {
            showWarning('Cancelado', 'É necessária a senha para recuperar o usuário.');
            return;
        }

        // Tentar fazer login para obter o UID
        const loginResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: userPassword,
                returnSecureToken: true
            })
        });

        const loginData = await loginResponse.json();
        
        if (!loginResponse.ok) {
            showError('Erro', 'Senha incorreta ou erro ao acessar a conta existente.');
            return;
        }

        const userId = loginData.localId;
        console.log('UID do usuário existente:', userId);

        // Agora salvar no Firestore
        await saveUserToFirestore(userId, name, email, role);
        
        showSuccess('Sucesso', `Usuário "${name}" vinculado com sucesso!\n\nEmail: ${email}`);

    } catch (error) {
        console.error('Erro ao recuperar usuário existente:', error);
        showError('Erro', `Não foi possível recuperar o usuário existente: ${error.message}`);
    }
}
// Função para salvar usuário no Firestore (CORRIGIDA)
async function saveUserToFirestore(userId, name, email, role, accessAreas = [], receivesNotifications = false) {
    console.log('Salvando usuário no Firestore:', { 
        userId, name, email, role, accessAreas, receivesNotifications 
    });
    
    const userData = {
        name: name || '',
        email: email || '',
        role: role || 'user',
        accessAreas: accessAreas || [],
        receivesNotifications: role === 'admin' ? true : receivesNotifications,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'active',
        createdBy: currentUser.uid,
        createdByName: currentUser.name,
        uid: userId
    };

    console.log('Dados a serem salvos:', userData);

    // Verificar se não há campos undefined
    Object.keys(userData).forEach(key => {
        if (userData[key] === undefined) {
            console.warn(`Campo ${key} está undefined, convertendo para string vazia`);
            userData[key] = '';
        }
    });

    // Salvar no Firestore
    await db.collection('users').doc(userId).set(userData);
    
    // Verificar se foi salvo
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) {
        throw new Error('Falha ao salvar usuário no Firestore');
    }

    console.log('Usuário salvo com sucesso no Firestore:', userDoc.data());
}

// Função para verificar se usuário existe (ATUALIZADA)
async function checkUserExists(email) {
    try {
        const userSnapshot = await db.collection('users')
            .where('email', '==', email)
            .limit(1)
            .get();
        
        return !userSnapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar usuário:', error);
        return false;
    }
}

// Função para traduzir mensagens de erro do Firebase
function getFirebaseAuthErrorMessage(errorCode) {
    const errorMessages = {
        'EMAIL_EXISTS': 'Este email já está em uso por outro usuário.',
        'OPERATION_NOT_ALLOWED': 'A criação de usuários não está habilitada.',
        'TOO_MANY_ATTEMPTS_TRY_LATER': 'Muitas tentativas. Tente novamente mais tarde.',
        'INVALID_EMAIL': 'O endereço de email é inválido.',
        'WEAK_PASSWORD': 'A senha é muito fraca. Use pelo menos 6 caracteres.',
        'MISSING_PASSWORD': 'A senha é obrigatória.'
    };

    let code = errorCode;
    if (errorCode && errorCode.includes('/')) {
        code = errorCode.split('/')[1].toUpperCase().replace(/-/g, '_');
    }

    return errorMessages[code] || `Erro: ${errorCode || 'Erro desconhecido'}`;
}

// Função para limpar formulário
function clearUserForm() {
    document.getElementById('user-name').value = '';
    document.getElementById('user-email').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = 'user';
}

// Colocar APÓS a função clearUserForm()
function getSelectedAccessAreas() {
    const checkboxes = document.querySelectorAll('input[name="access-areas"]:checked');
    const selectedAreas = [];
    
    checkboxes.forEach(checkbox => {
        selectedAreas.push(checkbox.value);
    });
    
    return selectedAreas;
}

// Colocar APÓS a função getSelectedAccessAreas()
function checkUserAccess(page) {
    if (!currentUser) return false;
    
    console.log(`Verificando acesso à página: ${page} para usuário:`, currentUser.role);
    
    // Admin tem acesso a tudo
    if (currentUser.role === 'admin') return true;
    
    // Mapear páginas para áreas necessárias
    const pageToArea = {
        'temperature': 'temperature',
        'pressure': 'pressure', 
        'osmosis': 'osmosis',
        'rooms': 'rooms',
        'users': 'users',
        'traceability': 'traceability',
        'reports': 'reports',
        'backup': 'backup'
    };
    
    const requiredArea = pageToArea[page];
    
    // Se página não requer área específica, permite acesso
    if (!requiredArea) return true;
    
    // Verificar se usuário tem acesso à área
    const hasAccess = currentUser.accessAreas && 
                     Array.isArray(currentUser.accessAreas) && 
                     currentUser.accessAreas.includes(requiredArea);
    
    console.log(`Acesso à ${page} (área ${requiredArea}): ${hasAccess ? 'PERMITIDO' : 'NEGADO'}`);
    
    return hasAccess;
}

// Colocar APÓS a função checkUserAccess()
function getPageName(page) {
    const pageNames = {
        'temperature': 'Temperatura & Umidade',
        'pressure': 'Pressão',
        'osmosis': 'Sistema de Osmose',
        'rooms': 'Gerenciar Salas',
        'users': 'Gerenciar Usuários',
        'traceability': 'Rastreabilidade',
        'reports': 'Relatórios',
        'backup': 'Backup & Restauração'
    };
    return pageNames[page] || page;
}

// Também atualize a mensagem na função handleExistingAuthUser:
async function handleExistingAuthUser(email, name, role) {
    console.log('Tentando recuperar usuário existente no Auth...');
    
    try {
        // Tentar obter o UID do usuário existente
        const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE';
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${API_KEY}`;
        
        // Primeiro, precisamos da senha (vamos pedir ao admin)
        const userPassword = prompt(
            `O usuário ${email} já existe na autenticação, mas não foi encontrado no sistema.\n\nPara recuperar esta conta, digite a senha do usuário:`
        );

        if (!userPassword) {
            throw new Error('Operação cancelada. É necessária a senha para recuperar o usuário.');
        }

        // Tentar fazer login para obter o UID
        const loginResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: userPassword,
                returnSecureToken: true
            })
        });

        const loginData = await loginResponse.json();
        
        if (!loginResponse.ok) {
            throw new Error('Senha incorreta ou erro ao acessar a conta existente.');
        }

        const userId = loginData.localId;
        console.log('UID do usuário existente:', userId);

        // Agora salvar no Firestore
        await saveUserToFirestore(userId, name, email, role);
        
        // CORREÇÃO: Mensagem sem mostrar dados sensíveis
        alert(`✅ Usuário recuperado com sucesso!\n\nNome: ${name}\nEmail: ${email}\n\nA conta foi vinculada ao sistema.`);

    } catch (error) {
        console.error('Erro ao recuperar usuário existente:', error);
        throw new Error(`Não foi possível recuperar o usuário existente: ${error.message}`);
    }
}

// Função para traduzir mensagens de erro do Firebase
function getFirebaseAuthErrorMessage(errorCode) {
    const errorMessages = {
        'EMAIL_EXISTS': 'Este email já está em uso por outro usuário.',
        'OPERATION_NOT_ALLOWED': 'A criação de usuários não está habilitada.',
        'TOO_MANY_ATTEMPTS_TRY_LATER': 'Muitas tentativas. Tente novamente mais tarde.',
        'INVALID_EMAIL': 'O endereço de email é inválido.',
        'WEAK_PASSWORD': 'A senha é muito fraca. Use pelo menos 6 caracteres.',
        'MISSING_PASSWORD': 'A senha é obrigatória.'
    };

    let code = errorCode;
    if (errorCode && errorCode.includes('/')) {
        code = errorCode.split('/')[1].toUpperCase().replace(/-/g, '_');
    }

    return errorMessages[code] || `Erro: ${errorCode || 'Erro desconhecido'}`;
}

// Função para limpar formulário
function clearUserForm() {
    document.getElementById('user-name').value = '';
    document.getElementById('user-email').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = 'user';
}

// Atualizar a função loadUsersList para garantir que está funcionando
async function loadUsersList() {
    try {
        console.log('Carregando lista de usuários...');
        const snapshot = await db.collection('users')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tbody = document.getElementById('users-list');
        const cardsContainer = document.getElementById('users-list-cards');
        tbody.innerHTML = '';
        cardsContainer.innerHTML = '';
        
        console.log('Total de usuários encontrados:', snapshot.size);
        
        if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usuário cadastrado</td></tr>';
            cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum usuário cadastrado</div></div>';
            return;
        }
        
        allUsers = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            console.log('Usuário carregado:', data);
            allUsers.push({ id: doc.id, ...data });
            const row = createUserRow(data, doc.id);
            tbody.appendChild(row);
            
            const card = createUserCard(data, doc.id);
            cardsContainer.appendChild(card);
        });
        
        console.log('Lista de usuários carregada com sucesso!');
        
    } catch (error) {
        console.error('Erro ao carregar lista de usuários:', error);
        document.getElementById('users-list').innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar dados</td></tr>';
        document.getElementById('users-list-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
    }
}

// Função para criar linha da tabela de usuários (ATUALIZADA)
function createUserRow(data, userId) {
    const row = document.createElement('tr');
    const createdAt = data.createdAt ? 
        new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString('pt-BR') : '-';
    
    // Mapear tipos de usuário para nomes legíveis
    const roleNames = {
        'admin': 'Administrador',
        'qualidade': 'Qualidade',
        'manutencao': 'Manutenção',
        'user': 'Usuário Normal'
    };
    
    // Ícone de notificações
    const notificationsIcon = data.receivesNotifications !== false ? 
        '<i class="fas fa-bell text-success" title="Recebe notificações"></i>' : 
        '<i class="fas fa-bell-slash text-muted" title="Não recebe notificações"></i>';
    
    row.innerHTML = `
        <td>${data.name || '-'}</td>
        <td>${data.email || '-'}</td>
        <td>
            ${roleNames[data.role] || data.role}
            ${data.receivesNotifications !== false ? ' ' + notificationsIcon : ''}
        </td>
        <td>${createdAt}</td>
        <td><span class="status ${data.status === 'active' ? 'status-normal' : 'status-critical'}">${data.status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
        <td>
            <button class="btn btn-warning btn-sm" onclick="editUser('${userId}')">
                <i class="fas fa-edit"></i>
            </button>
            
            ${data.status === 'active' ? 
                `<button class="btn btn-secondary btn-sm" onclick="deactivateUser('${userId}')">
                    <i class="fas fa-user-slash"></i>
                </button>` :
                `<button class="btn btn-success btn-sm" onclick="activateUser('${userId}')">
                    <i class="fas fa-user-check"></i>
                </button>`
            }
        </td>
    `;
    return row;
}

// Função para criar card de usuário (ATUALIZADA)
async function addUser() {
    if (currentUser.role !== 'admin') {
        alert('Apenas administradores podem adicionar usuários.');
        return;
    }

    const name = document.getElementById('user-name').value.trim();
    const email = document.getElementById('user-email').value.trim();
    const password = document.getElementById('user-password').value;
    const role = document.getElementById('user-role').value;

    console.log('Dados do formulário:', { name, email, password, role });

    if (!name || !email || !password) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }

    // Validar formato do email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Por favor, insira um email válido.');
        return;
    }

    // Validar senha
    if (password.length < 6) {
        alert('A senha deve ter pelo menos 6 caracteres.');
        return;
    }

    // Garantir que role tem um valor válido
    const userRole = role || 'user';
    console.log('Role definido como:', userRole);

    // Desabilitar botão durante o processo
    const addButton = document.getElementById('add-user-btn');
    const originalText = addButton.innerHTML;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando usuário...';
    addButton.disabled = true;

    try {
        // SOLUÇÃO CORRIGIDA: Verificar se usuário já existe no Firestore
        const existingUser = await checkUserExists(email);
        if (existingUser) {
            throw new Error('Este email já está cadastrado no sistema.');
        }

        const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE';
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${API_KEY}`;
        
        console.log('Criando usuário no Firebase Auth...');

        // 1. Criar usuário no Firebase Authentication
        const authResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password,
                returnSecureToken: true
            })
        });

        const authData = await authResponse.json();
        console.log('Resposta do Firebase Auth:', authData);

        if (!authResponse.ok) {
            // Se o usuário já existe no Auth mas não no Firestore, vamos recuperar
            if (authData.error?.message === 'EMAIL_EXISTS') {
                console.log('Usuário já existe no Auth, tentando recuperar...');
                await handleExistingAuthUser(email, name, userRole);
            } else {
                const errorMessage = getFirebaseAuthErrorMessage(authData.error?.message);
                throw new Error(errorMessage);
            }
        } else {
            // Usuário criado com sucesso no Auth
            const userId = authData.localId;
            console.log('Usuário criado no Auth com ID:', userId);
            await saveUserToFirestore(userId, name, email, userRole);
        }

        await addTraceability(
            'Criação de usuário', 
            `Usuário ${name} (${email}) criado como ${userRole}`
        );
        
        alert(`✅ Usuário "${name}" criado com sucesso!\n\nEmail: ${email}`);
        clearUserForm();
        
        // Recarregar lista de usuários
        await loadUsersList();
        
    } catch (error) {
        console.error('Erro ao criar usuário:', error);
        alert('❌ Erro ao criar usuário: ' + error.message);
    } finally {
        // Restaurar botão
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    }
}

// Função para salvar usuário no Firestore (CORRIGIDA)
// Atualizar a função saveUserToFirestore para incluir áreas de acesso
async function saveUserToFirestore(userId, name, email, role) {
    console.log('Salvando usuário no Firestore:', { userId, name, email, role });
    
    // Obter áreas de acesso selecionadas (apenas para não-admins)
    let accessAreas = [];
    if (role !== 'admin') {
        accessAreas = getSelectedAccessAreas();
    } else {
        // Administradores têm acesso a todas as áreas
        accessAreas = ['temperature', 'pressure', 'osmosis', 'rooms', 'users', 'traceability', 'reports', 'backup'];
    }
    
    // Dados do usuário
    const userData = {
        name: name || '',
        email: email || '',
        role: role || 'user',
        accessAreas: accessAreas, // NOVO CAMPO: áreas de acesso
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'active',
        createdBy: currentUser.uid,
        createdByName: currentUser.name,
        uid: userId
    };
    
    console.log('Dados a serem salvos:', userData);
    
    // Verificar se não há campos undefined
    Object.keys(userData).forEach(key => {
        if (userData[key] === undefined) {
            console.warn(`Campo ${key} está undefined, convertendo para string vazia`);
            userData[key] = '';
        }
    });
    
    // Salvar no Firestore
    await db.collection('users').doc(userId).set(userData);
    
    // Verificar se foi salvo
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) {
        throw new Error('Falha ao salvar usuário no Firestore');
    }
    
    console.log('Usuário salvo com sucesso no Firestore:', userDoc.data());
}

// Função para lidar com usuário que já existe no Auth mas não no Firestore
async function handleExistingAuthUser(email, name, role) {
    console.log('Tentando recuperar usuário existente no Auth...');
    
    try {
        // Tentar obter o UID do usuário existente
        const API_KEY = 'AIzaSyBQVm5-PrEojIObPC5t2H0ErHM4H2lTOWE';
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${API_KEY}`;
        
        // Primeiro, precisamos da senha (vamos pedir ao admin)
        const userPassword = prompt(
            `O usuário ${email} já existe na autenticação, mas não foi encontrado no sistema.\n\nPara recuperar esta conta, digite a senha do usuário:`
        );

        if (!userPassword) {
            throw new Error('Operação cancelada. É necessária a senha para recuperar o usuário.');
        }

        // Tentar fazer login para obter o UID
        const loginResponse = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: userPassword,
                returnSecureToken: true
            })
        });

        const loginData = await loginResponse.json();
        
        if (!loginResponse.ok) {
            throw new Error('Senha incorreta ou erro ao acessar a conta existente.');
        }

        const userId = loginData.localId;
        console.log('UID do usuário existente:', userId);

        // Agora salvar no Firestore
        await saveUserToFirestore(userId, name, email, role);
        
        alert(`✅ Usuário existente recuperado com sucesso!\n\nEmail: ${email}\nA conta foi vinculada ao sistema.`);

    } catch (error) {
        console.error('Erro ao recuperar usuário existente:', error);
        throw new Error(`Não foi possível recuperar o usuário existente: ${error.message}`);
    }
}

// Função para verificar se usuário existe (ATUALIZADA)
async function checkUserExists(email) {
    try {
        const userSnapshot = await db.collection('users')
            .where('email', '==', email)
            .limit(1)
            .get();
        
        return !userSnapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar usuário:', error);
        return false;
    }
}

// Função para traduzir mensagens de erro do Firebase
function getFirebaseAuthErrorMessage(errorCode) {
    const errorMessages = {
        'EMAIL_EXISTS': 'Este email já está em uso por outro usuário.',
        'OPERATION_NOT_ALLOWED': 'A criação de usuários não está habilitada.',
        'TOO_MANY_ATTEMPTS_TRY_LATER': 'Muitas tentativas. Tente novamente mais tarde.',
        'INVALID_EMAIL': 'O endereço de email é inválido.',
        'WEAK_PASSWORD': 'A senha é muito fraca. Use pelo menos 6 caracteres.',
        'MISSING_PASSWORD': 'A senha é obrigatória.'
    };

    let code = errorCode;
    if (errorCode && errorCode.includes('/')) {
        code = errorCode.split('/')[1].toUpperCase().replace(/-/g, '_');
    }

    return errorMessages[code] || `Erro: ${errorCode || 'Erro desconhecido'}`;
}

function clearUserForm() {
    document.getElementById('user-name').value = '';
    document.getElementById('user-email').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = 'user';
    
    // Limpar checkboxes de áreas de acesso
    const checkboxes = document.querySelectorAll('input[name="access-areas"]');
    checkboxes.forEach(cb => cb.checked = false);
    
    // Limpar checkbox de notificações
    const notificationsCheckbox = document.getElementById('receives-notifications');
    if (notificationsCheckbox) {
        notificationsCheckbox.checked = false;
    }
    
    // Ocultar seção de controle de acesso
    document.getElementById('access-control-section').style.display = 'none';
}

// Substitua a função original pela versão robusta
// document.getElementById('add-user-btn').addEventListener('click', addUserRobust);

// Função auxiliar para criar token customizado (se necessário)
async function createCustomToken(email) {
    // Esta é uma simplificação - em produção você precisaria de uma Cloud Function
    return btoa(JSON.stringify({ email: email, timestamp: Date.now() }));
}

        async function loadUsersList() {
            try {
                const snapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const tbody = document.getElementById('users-list');
                const cardsContainer = document.getElementById('users-list-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usuário cadastrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum usuário cadastrado</div></div>';
                    return;
                }
                
                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allUsers.push({ id: doc.id, ...data });
                    const row = createUserRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createUserCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar lista de usuários:', error);
                document.getElementById('users-list').innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('users-list-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        function createUserRow(data, userId) {
            const row = document.createElement('tr');
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${data.name || '-'}</td>
                <td>${data.email || '-'}</td>
                <td>${data.role === 'admin' ? 'Administrador' : 'Usuário Normal'}</td>
                <td>${createdAt}</td>
                <td><span class="status ${data.status === 'active' ? 'status-normal' : 'status-critical'}">${data.status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editUser('${userId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    
                    ${data.status === 'active' ? 
                        `<button class="btn btn-secondary btn-sm" onclick="deactivateUser('${userId}')">
                            <i class="fas fa-user-slash"></i>
                        </button>` :
                        `<button class="btn btn-success btn-sm" onclick="activateUser('${userId}')">
                            <i class="fas fa-user-check"></i>
                        </button>`
                    }
                </td>
            `;
            return row;
        }

        function createUserCard(data, userId) {
    const card = document.createElement('div');
    card.className = 'mobile-card';
    const createdAt = data.createdAt ? 
        new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString('pt-BR') : '-';
    
    // Mapear tipos de usuário
    const roleNames = {
        'admin': 'Administrador',
        'qualidade': 'Qualidade',
        'manutencao': 'Manutenção',
        'user': 'Usuário Normal'
    };
    
    // Formatar áreas de acesso
    let accessAreasText = 'Todas as áreas';
    if (data.role !== 'admin' && data.accessAreas && data.accessAreas.length > 0) {
        const areaNames = {
            'temperature': 'Temperatura',
            'pressure': 'Pressão',
            'osmosis': 'Osmose',
            'rooms': 'Salas',
            'users': 'Usuários',
            'traceability': 'Rastreabilidade',
            'reports': 'Relatórios',
            'backup': 'Backup'
        };
        accessAreasText = data.accessAreas.map(area => areaNames[area] || area).join(', ');
    }
    
    card.innerHTML = `
        <div class="mobile-card-header">
            <div>
                <div class="mobile-card-title">${data.name || '-'}</div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Email:</span>
                    <span class="mobile-card-value">${data.email || '-'}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Tipo:</span>
                    <span class="mobile-card-value">${roleNames[data.role] || data.role}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Criado em:</span>
                    <span class="mobile-card-value">${createdAt}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Áreas de Acesso:</span>
                    <span class="mobile-card-value" style="font-size: 12px;">${accessAreasText}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Status:</span>
                    <span class="mobile-card-value"><span class="status ${data.status === 'active' ? 'status-normal' : 'status-critical'}">${data.status === 'active' ? 'Ativo' : 'Inativo'}</span></span>
                </div>
            </div>
        </div>
        <div class="mobile-card-actions">
            <button class="btn btn-warning btn-sm" onclick="editUser('${userId}')">
                <i class="fas fa-edit"></i> Editar
            </button>
            ${data.status === 'active' ? 
                `<button class="btn btn-secondary btn-sm" onclick="deactivateUser('${userId}')">
                    <i class="fas fa-user-slash"></i> Desativar
                </button>` :
                `<button class="btn btn-success btn-sm" onclick="activateUser('${userId}')">
                    <i class="fas fa-user-check"></i> Ativar
                </button>`
            }
        </div>
    `;
    return card;
}

       // Atualizar a função editUser para permitir editar áreas de acesso
async function editUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    // Dados do usuário
    const roleNames = {
        'admin': 'Administrador',
        'qualidade': 'Qualidade',
        'manutencao': 'Manutenção',
        'user': 'Usuário Normal'
    };

    // HTML do modal de edição
    const modalContent = `
        <div class="form-group">
            <label for="edit-user-name">Nome:</label>
            <input type="text" id="edit-user-name" value="${user.name || ''}">
        </div>
        
        <div class="form-group">
            <label for="edit-user-email">Email:</label>
            <input type="email" id="edit-user-email" value="${user.email || ''}" readonly>
        </div>
        
        <div class="form-group">
            <label for="edit-user-role">Tipo de Usuário:</label>
            <select id="edit-user-role">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuário Normal</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                <option value="qualidade" ${user.role === 'qualidade' ? 'selected' : ''}>Qualidade</option>
                <option value="manutencao" ${user.role === 'manutencao' ? 'selected' : ''}>Manutenção</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="edit-user-status">Status:</label>
            <select id="edit-user-status">
                <option value="active" ${user.status === 'active' ? 'selected' : ''}>Ativo</option>
                <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inativo</option>
            </select>
        </div>
        
        <div class="form-section" id="edit-access-control-section" style="${user.role === 'admin' ? 'display: none;' : ''}">
            <div class="section-title">Controle de Acesso por Áreas</div>
            <p style="margin-bottom: 10px; color: var(--gray); font-size: 13px;">
                Selecione as áreas que este usuário poderá acessar:
            </p>
            
            <div class="form-row">
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-temperature" value="temperature" ${user.accessAreas && user.accessAreas.includes('temperature') ? 'checked' : ''}>
                    <label for="edit-access-temperature">Temperatura & Umidade</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-pressure" value="pressure" ${user.accessAreas && user.accessAreas.includes('pressure') ? 'checked' : ''}>
                    <label for="edit-access-pressure">Pressão</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-osmosis" value="osmosis" ${user.accessAreas && user.accessAreas.includes('osmosis') ? 'checked' : ''}>
                    <label for="edit-access-osmosis">Sistema de Osmose</label>
                </div>
            </div>
            
            <div class="form-row">
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-rooms" value="rooms" ${user.accessAreas && user.accessAreas.includes('rooms') ? 'checked' : ''}>
                    <label for="edit-access-rooms">Gerenciar Salas</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-traceability" value="traceability" ${user.accessAreas && user.accessAreas.includes('traceability') ? 'checked' : ''}>
                    <label for="edit-access-traceability">Rastreabilidade</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-reports" value="reports" ${user.accessAreas && user.accessAreas.includes('reports') ? 'checked' : ''}>
                    <label for="edit-access-reports">Relatórios</label>
                </div>
            </div>
            
            <div class="form-row">
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-access-backup" value="backup" ${user.accessAreas && user.accessAreas.includes('backup') ? 'checked' : ''}>
                    <label for="edit-access-backup">Backup & Restauração</label>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <div class="checkbox-group">
                    <input type="checkbox" id="edit-receives-notifications" ${user.receivesNotifications !== false ? 'checked' : ''}>
                    <label for="edit-receives-notifications">Receber notificações do sistema</label>
                </div>
                <small style="color: var(--gray);">(Apenas para admin/qualidade/manutenção)</small>
            </div>
        </div>
    `;

    currentEditData = { 
        collection: 'users', 
        id: userId, 
        data: user 
    };

    document.getElementById('edit-modal-title').textContent = 'Editar Usuário';
    document.getElementById('edit-modal-content').innerHTML = modalContent;
    showEditModal();
    
    // Adicionar listener para mostrar/ocultar controle de acesso
    document.getElementById('edit-user-role').addEventListener('change', function() {
        const accessControlSection = document.getElementById('edit-access-control-section');
        if (this.value === 'admin') {
            accessControlSection.style.display = 'none';
        } else {
            accessControlSection.style.display = 'block';
        }
    });
}


 async function deactivateUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    const confirm = await showConfirm(`Desativar o usuário ${user.name} (${user.email})?\n\nO usuário não poderá mais acessar o sistema.`);
    
    if (!confirm) return;

    try {
        await db.collection('users').doc(userId).update({
            status: 'inactive'
        });

        await addTraceability(
            'Desativação de usuário', 
            `Usuário ${user.name} (${user.email}) desativado`
        );

        showSuccess('Sucesso', 'Usuário desativado com sucesso!', {
            onOk: () => loadUsersList()
        });
    } catch (error) {
        console.error('Erro ao desativar usuário:', error);
        showError('Erro', 'Erro ao desativar usuário');
    }
}
 async function activateUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    const confirm = await showConfirm(`Ativar o usuário ${user.name} (${user.email})?\n\nO usuário poderá acessar o sistema novamente.`);
    
    if (!confirm) return;

    try {
        await db.collection('users').doc(userId).update({
            status: 'active'
        });

        await addTraceability(
            'Ativação de usuário', 
            `Usuário ${user.name} (${user.email}) ativado`
        );

        showSuccess('Sucesso', 'Usuário ativado com sucesso!', {
            onOk: () => loadUsersList()
        });
    } catch (error) {
        console.error('Erro ao ativar usuário:', error);
        showError('Erro', 'Erro ao ativar usuário');
    }
}

        function clearUserForm() {
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = 'user';
        }

        // ========== FUNÇÕES PARA CARREGAR DADOS ==========

        async function loadTemperatureHistory() {
            try {
                const snapshot = await db.collection('temperature_readings')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('temp-history');
                const cardsContainer = document.getElementById('temp-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createTemperatureRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createTemperatureCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico de temperatura:', error);
                document.getElementById('temp-history').innerHTML = '<tr><td colspan="12" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('temp-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadPressureHistory() {
            try {
                const snapshot = await db.collection('pressure_readings')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('pressure-history');
                const cardsContainer = document.getElementById('pressure-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createPressureRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createPressureCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico de pressão:', error);
                document.getElementById('pressure-history').innerHTML = '<tr><td colspan="8" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('pressure-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadOsmosisHistory() {
            try {
                const snapshot = await db.collection('osmosis_daily')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('osmosis-history');
                const cardsContainer = document.getElementById('osmosis-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                osmosisDailyData = [];
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    osmosisDailyData.push(data);
                    const row = createOsmosisRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createOsmosisCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
                // Inicializar dados filtrados com todos os dados
                filteredOsmosisData = [...osmosisDailyData];
                
                // Carregar cards detalhados
                loadOsmosisDetailedCards();
                
            } catch (error) {
                console.error('Erro ao carregar histórico de osmose:', error);
                document.getElementById('osmosis-history').innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('osmosis-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        function loadOsmosisDetailedCards() {
            const container = document.getElementById('osmosis-detailed-cards');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (filteredOsmosisData.length === 0) {
                container.innerHTML = '<div class="card"><div class="card-body text-center">Nenhum registro de controle diário encontrado</div></div>';
                return;
            }
            
            filteredOsmosisData.forEach(data => {
                const card = createOsmosisDetailedCard(data);
                container.appendChild(card);
            });
        }

        function createOsmosisDetailedCard(data) {
            const card = document.createElement('div');
            card.className = 'osmosis-card';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            const statusClass = `status-${data.conductivityStatus || 'normal'}`;
            
            card.innerHTML = `
                <div class="osmosis-card-header">
                    <div>
                        <div class="osmosis-card-title">Controle Diário de Osmose</div>
                        <div class="osmosis-card-field">
                            <span class="osmosis-card-label">Data/Hora:</span>
                            <span class="osmosis-card-value">${createdAt}</span>
                        </div>
                        <div class="osmosis-card-field">
                            <span class="osmosis-card-label">Operador:</span>
                            <span class="osmosis-card-value">${data.userName || '-'}</span>
                        </div>
                        <div class="osmosis-card-field">
                            <span class="osmosis-card-label">Status:</span>
                            <span class="osmosis-card-value"><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Condutividade:</span>
                        <span class="osmosis-card-value">${data.conductivity || '-'} µS/cm</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Sanitização/Downtime</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Última:</span>
                        <span class="osmosis-card-value">${data.lastSanitization || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Próxima:</span>
                        <span class="osmosis-card-value">${data.nextSanitization || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Higienização</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Última:</span>
                        <span class="osmosis-card-value">${data.lastCleaning || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Próxima:</span>
                        <span class="osmosis-card-value">${data.nextCleaning || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Coleta para Análise</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Última:</span>
                        <span class="osmosis-card-value">${data.lastCollection || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Próxima:</span>
                        <span class="osmosis-card-value">${data.nextCollection || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Anormalidade</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Apresenta:</span>
                        <span class="osmosis-card-value">${data.hasAbnormality ? 'Sim' : 'Não'}</span>
                    </div>
                    ${data.hasAbnormality ? `
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">Motivo:</span>
                        <span class="osmosis-card-value">${data.abnormalityReason || '-'}</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Troca de Filtros - Última</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FPP-001:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.fpp001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FCA-001:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.fca001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-001:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.drm001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-002:</span>
                        <span class="osmosis-card-value">${data.lastFilterChange?.drm002 || '-'}</span>
                    </div>
                </div>
                
                <div class="osmosis-card-section">
                    <div class="section-title">Troca de Filtros - Próxima</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FPP-001:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.fpp001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">FCA-001:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.fca001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-001:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.drm001 || '-'}</span>
                    </div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-label">DRM-002:</span>
                        <span class="osmosis-card-value">${data.nextFilterChange?.drm002 || '-'}</span>
                    </div>
                </div>
                
                ${data.notes ? `
                <div class="osmosis-card-section">
                    <div class="section-title">Observações</div>
                    <div class="osmosis-card-field">
                        <span class="osmosis-card-value" style="text-align: left;">${data.notes}</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="osmosis-card-actions">
                    <button class="btn btn-primary btn-sm" onclick="exportOsmosisCardToPDF('${data.id}')">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
            `;
            
            return card;
        }

        async function loadMaintenanceHistory() {
            try {
                const snapshot = await db.collection('osmosis_maintenance')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('maintenance-history');
                const cardsContainer = document.getElementById('maintenance-history-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createMaintenanceRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createMaintenanceCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico de manutenções:', error);
                document.getElementById('maintenance-history').innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('maintenance-history-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadRoomsList() {
            try {
                const snapshot = await db.collection('rooms')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const tbody = document.getElementById('rooms-list');
                const cardsContainer = document.getElementById('rooms-list-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhuma sala cadastrada</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhuma sala cadastrada</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createRoomRow(data, doc.id);
                    tbody.appendChild(row);
                    
                    const card = createRoomCard(data, doc.id);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar lista de salas:', error);
                document.getElementById('rooms-list').innerHTML = '<tr><td colspan="9" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('rooms-list-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        async function loadTraceabilityLog() {
            try {
                let query = db.collection('traceability').orderBy('timestamp', 'desc');
                
                // Aplicar filtros
                const filterDate = document.getElementById('filter-date').value;
                const filterUser = document.getElementById('filter-user').value;
                const filterAction = document.getElementById('filter-action').value;
                
                if (filterDate) {
                    const startDate = new Date(filterDate);
                    const endDate = new Date(filterDate);
                    endDate.setDate(endDate.getDate() + 1);
                    
                    query = query.where('createdAt', '>=', startDate)
                                .where('createdAt', '<', endDate);
                }
                
                if (filterUser && filterUser !== 'all') {
                    query = query.where('userId', '==', filterUser);
                }
                
                if (filterAction && filterAction !== 'all') {
                    // Filtro por tipo de ação (implementação básica)
                    // Em uma implementação real, você teria um campo específico para tipo
                }
                
                const snapshot = await query.limit(100).get();
                
                const tbody = document.getElementById('traceability-log');
                const cardsContainer = document.getElementById('traceability-log-cards');
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                
                traceabilityData = [];
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                    cardsContainer.innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Nenhum registro encontrado</div></div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    traceabilityData.push(data);
                    const row = createTraceabilityRow(data);
                    tbody.appendChild(row);
                    
                    const card = createTraceabilityCard(data);
                    cardsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar log de rastreabilidade:', error);
                document.getElementById('traceability-log').innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados</td></tr>';
                document.getElementById('traceability-log-cards').innerHTML = '<div class="mobile-card"><div class="mobile-card-title">Erro ao carregar dados</div></div>';
            }
        }

        // ========== FUNÇÕES PARA CRIAR LINHAS DE TABELA ==========

        function createTemperatureRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.roomName || '-'}</td>
                <td>${data.period || '-'}</td>
                <td>${data.tempMin || '-'}°C</td>
                <td>${data.tempMax || '-'}°C</td>
                <td>${data.tempActual || '-'}°C</td>
                <td>${data.humidityMin || '-'}%</td>
                <td>${data.humidityMax || '-'}%</td>
                <td>${data.humidityActual || '-'}%</td>
                <td><span class="status ${statusClass}">${getStatusText(data.status)}</span></td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editTemperatureReading('${docId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('temperature_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de temperatura?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Atualize a função createTemperatureCard:
function createTemperatureCard(data, docId) {
    const card = document.createElement('div');
    card.className = 'mobile-card';
    const statusClass = `status-${data.status || 'normal'}`;
    const createdAt = data.createdAt ? 
        new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
    
    const canEdit = canUserEdit();
    
    card.innerHTML = `
        <div class="mobile-card-header">
            <div>
                <div class="mobile-card-title">${data.roomName || '-'} - ${data.period || '-'}</div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Data/Hora:</span>
                    <span class="mobile-card-value">${createdAt}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Temperatura:</span>
                    <span class="mobile-card-value">${data.tempActual || '-'}°C (${data.tempMin || '-'} - ${data.tempMax || '-'})</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Umidade:</span>
                    <span class="mobile-card-value">${data.humidityActual || '-'}% (${data.humidityMin || '-'} - ${data.humidityMax || '-'})</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Status:</span>
                    <span class="mobile-card-value"><span class="status ${statusClass}">${getStatusText(data.status)}</span></span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Operador:</span>
                    <span class="mobile-card-value">${data.userName || '-'}</span>
                </div>
            </div>
        </div>
        ${canEdit ? `
        <div class="mobile-card-actions">
            <button class="btn btn-primary btn-sm" onclick="editTemperatureReading('${docId}')">
                <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteRecord('temperature_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de temperatura?')">
                <i class="fas fa-trash"></i> Excluir
            </button>
        </div>
        ` : ''}
    `;
    return card;
}

        function createPressureRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.roomName || '-'}</td>
                <td>${data.period || '-'}</td>
                <td>${data.pressure || '-'} Pa</td>
                <td>${data.immediateCorrection || '-'}</td>
                <td><span class="status ${statusClass}">${getStatusText(data.status)}</span></td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editPressureReading('${docId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('pressure_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de pressão?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createPressureCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = `status-${data.status || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.roomName || '-'} - ${data.period || '-'}</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Pressão:</span>
                            <span class="mobile-card-value">${data.pressure || '-'} Pa</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Correção:</span>
                            <span class="mobile-card-value">${data.immediateCorrection || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${getStatusText(data.status)}</span></span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm" onclick="editPressureReading('${docId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('pressure_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de pressão?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createOsmosisRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = `status-${data.conductivityStatus || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.conductivity || '-'} µS/cm</td>
                <td><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></td>
                <td>${data.hasAbnormality ? 'Sim' : 'Não'}</td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_daily', '${docId}', 'Tem certeza que deseja excluir este registro de osmose?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createOsmosisCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = `status-${data.conductivityStatus || 'normal'}`;
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">Controle de Osmose</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Condutividade:</span>
                            <span class="mobile-card-value">${data.conductivity || '-'} µS/cm</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Anormalidade:</span>
                            <span class="mobile-card-value">${data.hasAbnormality ? 'Sim' : 'Não'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_daily', '${docId}', 'Tem certeza que deseja excluir este registro de osmose?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createMaintenanceRow(data, docId) {
            const row = document.createElement('tr');
            const maintenanceDate = data.maintenanceDate ? 
                new Date(data.maintenanceDate).toLocaleDateString('pt-BR') : '-';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${maintenanceDate}</td>
                <td>${data.procedure || '-'}</td>
                <td>${data.observations || '-'}</td>
                <td>${data.userName || '-'}</td>
                <td class="admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_maintenance', '${docId}', 'Tem certeza que deseja excluir este registro de manutenção?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createMaintenanceCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const maintenanceDate = data.maintenanceDate ? 
                new Date(data.maintenanceDate).toLocaleDateString('pt-BR') : '-';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">Manutenção de Osmose</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data da Manutenção:</span>
                            <span class="mobile-card-value">${maintenanceDate}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Procedimento:</span>
                            <span class="mobile-card-value">${data.procedure || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Observações:</span>
                            <span class="mobile-card-value">${data.observations || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Operador:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions admin-only">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_maintenance', '${docId}', 'Tem certeza que deseja excluir este registro de manutenção?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createRoomRow(data, docId) {
            const row = document.createElement('tr');
            const statusClass = data.status === 'active' ? 'status-normal' : 'status-critical';
            const statusText = data.status === 'active' ? 'Ativa' : 'Inativa';
            
            row.innerHTML = `
                <td>${data.code || '-'}</td>
                <td>${data.name || '-'}</td>
                <td>${formatRoomType(data.type)}</td>
                <td>${data.responsible || '-'}</td>
                <td>${data.tempMin || '-'}°C - ${data.tempMax || '-'}°C</td>
                <td>${data.humidityMin || '-'}% - ${data.humidityMax || '-'}%</td>
                <td>${data.pressureMin || '-'} Pa</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editRoom('${docId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('rooms', '${docId}', 'Tem certeza que deseja excluir esta sala?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function createRoomCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const statusClass = data.status === 'active' ? 'status-normal' : 'status-critical';
            const statusText = data.status === 'active' ? 'Ativa' : 'Inativa';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.name || '-'} (${data.code || '-'})</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Tipo:</span>
                            <span class="mobile-card-value">${formatRoomType(data.type)}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Responsável:</span>
                            <span class="mobile-card-value">${data.responsible || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Temperatura:</span>
                            <span class="mobile-card-value">${data.tempMin || '-'}°C - ${data.tempMax || '-'}°C</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Umidade:</span>
                            <span class="mobile-card-value">${data.humidityMin || '-'}% - ${data.humidityMax || '-'}%</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Pressão Mínima:</span>
                            <span class="mobile-card-value">${data.pressureMin || '-'} Pa</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Status:</span>
                            <span class="mobile-card-value"><span class="status ${statusClass}">${statusText}</span></span>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-actions">
                    <button class="btn btn-primary btn-sm" onclick="editRoom('${docId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('rooms', '${docId}', 'Tem certeza que deseja excluir esta sala?')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        function createTraceabilityRow(data) {
            const row = document.createElement('tr');
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            row.innerHTML = `
                <td>${createdAt}</td>
                <td>${data.userName || '-'}</td>
                <td>${data.action || '-'}</td>
                <td>${data.details || '-'}</td>
                <td>${data.userIp || '-'}</td>
            `;
            return row;
        }

        function createTraceabilityCard(data) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            const createdAt = data.createdAt ? 
                new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">${data.action || '-'}</div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Data/Hora:</span>
                            <span class="mobile-card-value">${createdAt}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Usuário:</span>
                            <span class="mobile-card-value">${data.userName || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Detalhes:</span>
                            <span class="mobile-card-value">${data.details || '-'}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">IP:</span>
                            <span class="mobile-card-value">${data.userIp || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // ========== FUNÇÕES AUXILIARES ==========

        function calculateTemperatureStatus(temperature, humidity, tempMin, tempMax, humidityMin, humidityMax) {
            if (!tempMin || !tempMax || !humidityMin || !humidityMax) {
                return 'normal'; // Fallback se não houver parâmetros definidos
            }

            const tempInRange = temperature >= tempMin && temperature <= tempMax;
            const humidityInRange = humidity >= humidityMin && humidity <= humidityMax;

            if (tempInRange && humidityInRange) {
                return 'normal';
            } else if ((temperature >= tempMin - 1 && temperature <= tempMax + 1) || 
                       (humidity >= humidityMin - 5 && humidity <= humidityMax + 5)) {
                return 'alert';
            } else {
                return 'critical';
            }
        }

        function calculatePressureStatus(pressure, minPressure) {
            if (!minPressure) return 'normal'; // Fallback

            if (pressure >= minPressure) {
                return 'normal';
            } else if (pressure >= minPressure - 2) {
                return 'alert';
            } else {
                return 'critical';
            }
        }

        function calculateConductivityStatus(conductivity) {
            if (conductivity === undefined || conductivity === null) return 'normal';
            
            if (conductivity < 1.0) {
                return 'normal';
            } else if (conductivity >= 1.0 && conductivity <= 1.2) {
                return 'alert';
            } else {
                return 'critical';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'normal': 'Normal',
                'alert': 'Alerta', 
                'critical': 'Crítico'
            };
            return statusMap[status] || status;
        }

        function formatRoomType(type) {
            const types = {
                'estoque': 'Estoque',
                'preparacao': 'Preparação',
                'producao': 'Produção',
                'embalagem': 'Embalagem',
                'qualidade': 'Controle de Qualidade',
                'outro': 'Outro'
            };
            return types[type] || type;
        }

        // Função auxiliar para adicionar rastreabilidade
        async function addTraceability(action, details) {
            try {
                await db.collection('traceability').add({
                    action: action,
                    details: details,
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    userIp: await getUserIP(),
                    createdAt: new Date(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                // Recarregar o log de rastreabilidade
                if (currentUser.role === 'admin') {
                    loadTraceabilityLog();
                }
            } catch (error) {
                console.error('Erro ao registrar rastreabilidade:', error);
            }
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'IP não disponível';
            }
        }

        function getAuthErrorMessage(errorCode) {
            console.log('Código de erro:', errorCode);
            
            const messages = {
                'auth/invalid-email': 'Email inválido',
                'auth/user-disabled': 'Usuário desativado',
                'auth/user-not-found': 'Usuário não encontrado',
                'auth/wrong-password': 'Senha incorreta',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
                'auth/internal-error': 'Erro interno do servidor'
            };
            
            return messages[errorCode] || `Erro desconhecido: ${errorCode}`;
        }

        // Funções para limpar formulários
   function clearTemperatureForm() {
    document.getElementById('temp-min').value = '';
    document.getElementById('temp-max').value = '';
    document.getElementById('temp-atual').value = '';
    document.getElementById('umid-min').value = '';
    document.getElementById('umid-max').value = '';
    document.getElementById('umid-atual').value = '';
    document.getElementById('temp-notes').value = '';
}

function clearPressureForm() {
    document.getElementById('pressure-value').value = '';
    document.getElementById('correcao-imediata').value = '';
    document.getElementById('pressure-notes').value = '';
}

function clearOsmosisDailyForm() {
    document.getElementById('condutividade').value = '';
    document.getElementById('ultima-sanitizacao').value = '';
    document.getElementById('proxima-sanitizacao').value = '';
    document.getElementById('ultima-higienizacao').value = '';
    document.getElementById('proxima-higienizacao').value = '';
    document.getElementById('ultima-coleta').value = '';
    document.getElementById('proxima-coleta').value = '';
    document.getElementById('anormalidade-nao').checked = true;
    document.getElementById('anormalidade-detalhes').style.display = 'none';
    document.getElementById('motivo-anormalidade').value = '';
    document.getElementById('ultima-fpp001').value = '';
    document.getElementById('ultima-fca001').value = '';
    document.getElementById('ultima-drm001').value = '';
    document.getElementById('ultima-drm002').value = '';
    document.getElementById('proxima-fpp001').value = '';
    document.getElementById('proxima-fca001').value = '';
    document.getElementById('proxima-drm001').value = '';
    document.getElementById('proxima-drm002').value = '';
    document.getElementById('osmosis-daily-notes').value = '';
}

function clearMaintenanceForm() {
    document.getElementById('procedimento').value = '';
    document.getElementById('data-manutencao').value = '';
    document.getElementById('obs-manutencao').value = '';
}

function clearRoomForm() {
    document.getElementById('room-name').value = '';
    document.getElementById('room-code').value = '';
    document.getElementById('room-type').value = 'estoque';
    document.getElementById('room-responsible').value = '';
    document.getElementById('temp-min-room').value = '18.0';
    document.getElementById('temp-max-room').value = '26.0';
    document.getElementById('umid-min-room').value = '40.0';
    document.getElementById('umid-max-room').value = '60.0';
    document.getElementById('pressure-value-min').value = '5';
    document.getElementById('room-description').value = '';
}

function clearUserForm() {
    document.getElementById('user-name').value = '';
    document.getElementById('user-email').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = 'user';
}

        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }

        function showEditModal() {
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function hideEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditData = null;
        }

        // Atualizar hora atual
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                `Data: ${now.toLocaleDateString('pt-BR')} Hora: ${now.toLocaleTimeString('pt-BR')}`;
        }

        // ========== FUNÇÕES DE EXPORTAÇÃO PDF ==========

        async function exportTraceabilityToPDF() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text('Relatório Completo de Rastreabilidade', 14, 15);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 14, 22);
            doc.text(`Gerado por: ${currentUser.name}`, 14, 28);
            
            // Informações do filtro
            const filterDate = document.getElementById('filter-date').value;
            const filterUser = document.getElementById('filter-user').value;
            const filterAction = document.getElementById('filter-action').value;
            
            let filterInfo = 'Filtros aplicados: ';
            if (filterDate) filterInfo += `Data: ${filterDate} `;
            if (filterUser && filterUser !== 'all') filterInfo += `Usuário: ${filterUser} `;
            if (filterAction && filterAction !== 'all') filterInfo += `Ação: ${filterAction} `;
            if (filterInfo === 'Filtros aplicados: ') filterInfo = 'Todos os registros (sem filtros)';
            
            doc.text(filterInfo, 14, 35);
            
            try {
                const headers = [['Data/Hora', 'Usuário', 'Ação', 'Detalhes', 'IP']];
                const data = [];
                
                // Usar dados já carregados ou carregar todos se necessário
                let recordsToExport = traceabilityData;
                
                if (recordsToExport.length === 0) {
                    // Carregar todos os registros se não houver filtro
                    const snapshot = await db.collection('traceability')
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    recordsToExport = [];
                    snapshot.forEach(doc => {
                        recordsToExport.push({ id: doc.id, ...doc.data() });
                    });
                }
                
                recordsToExport.forEach(item => {
                    const date = item.createdAt ? 
                        new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                    data.push([
                        date,
                        item.userName || '-',
                        item.action || '-',
                        item.details || '-',
                        item.userIp || '-'
                    ]);
                });
                
                // Generate table
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: 45,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] }
                });
                
                // Save the PDF
                doc.save(`relatorio_rastreabilidade_completo_${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                console.error('Erro ao gerar PDF de rastreabilidade:', error);
                alert('Erro ao gerar relatório PDF de rastreabilidade');
            }
        }

        function exportOsmosisCardToPDF(cardId) {
    if (currentUser.role !== 'admin') {
        alert('Apenas administradores podem exportar relatórios em PDF.');
        return;
    }
    
    const data = osmosisDailyData.find(item => item.id === cardId);
    if (!data) {
        alert('Dados não encontrados para exportação.');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configurações da página
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 14;
    let yPosition = margin;
    
    // Função para formatar data no formato dd-mm-aaaa
    const formatDate = (dateString) => {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}-${month}-${year}`;
        } catch (error) {
            return '-';
        }
    };
    
    // Função para formatar data/hora completa
    const formatDateTime = (dateValue) => {
        if (!dateValue) return '-';
        try {
            const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
            if (isNaN(date.getTime())) return '-';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        } catch (error) {
            return '-';
        }
    };
    
    // HEADER APENAS NA PRIMEIRA PÁGINA
    doc.setFillColor(44, 62, 80); // Cor primária
    doc.rect(0, 0, pageWidth, 30, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('RELATÓRIO DE CONTROLE DIÁRIO', pageWidth / 2, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Sistema de Osmose Reversa', pageWidth / 2, 22, { align: 'center' });
    
    // Informações do registro
    doc.setTextColor(0, 0, 0);
    yPosition = 40;
    
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, yPosition, pageWidth - margin * 2, 20, 'F');
    
    doc.setFontSize(10);
    doc.text(`Data do Registro: ${formatDateTime(data.createdAt)}`, margin + 5, yPosition + 8);
    doc.text(`Operador: ${data.userName || '-'}`, margin + 5, yPosition + 15);
    
    // Status com cor
    const statusColor = data.conductivityStatus === 'normal' ? [39, 174, 96] : 
                      data.conductivityStatus === 'alert' ? [243, 156, 18] : [231, 76, 60];
    
    doc.setFillColor(...statusColor);
    doc.rect(pageWidth - margin - 40, yPosition + 5, 40, 12, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.text(getStatusText(data.conductivityStatus).toUpperCase(), pageWidth - margin - 20, yPosition + 12, { align: 'center' });
    
    yPosition += 30;
    
    // Função auxiliar para verificar se precisa de nova página
    const checkPageBreak = (requiredSpace) => {
        if (yPosition + requiredSpace > pageHeight - 20) {
            doc.addPage();
            yPosition = margin;
            // NÃO ADICIONA HEADER NAS PÁGINAS SEGUINTES
        }
    };
    
    // Seção de Condutividade
    checkPageBreak(20);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('1. CONDUTIVIDADE DA ÁGUA PURIFICADA', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    doc.setFontSize(10);
    doc.text(`Resultado: ${data.conductivity || '-'} µS/cm`, margin + 5, yPosition);
    doc.text(`Limite: 1.3 µS/cm`, margin + 5, yPosition + 5);
    yPosition += 15;
    
    // Linha divisória
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 10;
    
    // Seção de Sanitização
    checkPageBreak(25);
    doc.setFont(undefined, 'bold');
    doc.text('2. SANITIZAÇÃO DO SISTEMA', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    doc.text(`Última sanitização: ${formatDate(data.lastSanitization)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`Próxima sanitização: ${formatDate(data.nextSanitization)}`, margin + 5, yPosition);
    yPosition += 15;
    
    // Linha divisória
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 10;
    
    // Seção de Higienização
    checkPageBreak(25);
    doc.setFont(undefined, 'bold');
    doc.text('3. HIGIENIZAÇÃO', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    doc.text(`Última higienização: ${formatDate(data.lastCleaning)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`Próxima higienização: ${formatDate(data.nextCleaning)}`, margin + 5, yPosition);
    yPosition += 15;
    
    // Linha divisória
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 10;
    
    // Seção de Coleta
    checkPageBreak(25);
    doc.setFont(undefined, 'bold');
    doc.text('4. COLETA DE ÁGUA PARA ANÁLISE', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    doc.text(`Última coleta: ${formatDate(data.lastCollection)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`Próxima coleta: ${formatDate(data.nextCollection)}`, margin + 5, yPosition);
    yPosition += 15;
    
    // Linha divisória
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 10;
    
    // Seção de Anormalidade
    checkPageBreak(30);
    doc.setFont(undefined, 'bold');
    doc.text('5. ANORMALIDADE NO FUNCIONAMENTO', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    doc.text(`Apresenta anormalidade: ${data.hasAbnormality ? 'Sim' : 'Não'}`, margin + 5, yPosition);
    yPosition += 5;
    
    if (data.hasAbnormality && data.abnormalityReason) {
        const abnormalityLines = doc.splitTextToSize(`Motivo: ${data.abnormalityReason}`, pageWidth - margin * 2 - 10);
        doc.text(abnormalityLines, margin + 5, yPosition);
        yPosition += abnormalityLines.length * 5 + 5;
    } else {
        yPosition += 5;
    }
    
    // Linha divisória
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 10;
    
    // Seção de Troca de Filtros - Última
    checkPageBreak(40);
    doc.setFont(undefined, 'bold');
    doc.text('6. TROCA DE FILTROS - ÚLTIMA', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    const lastFilters = data.lastFilterChange || {};
    doc.text(`FPP-001: ${formatDate(lastFilters.fpp001)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`FCA-001: ${formatDate(lastFilters.fca001)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`DRM-001: ${formatDate(lastFilters.drm001)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`DRM-002: ${formatDate(lastFilters.drm002)}`, margin + 5, yPosition);
    yPosition += 15;
    
    // Linha divisória
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 10;
    
    // Seção de Troca de Filtros - Próxima
    checkPageBreak(40);
    doc.setFont(undefined, 'bold');
    doc.text('7. TROCA DE FILTROS - PRÓXIMA', margin, yPosition);
    yPosition += 8;
    
    doc.setFont(undefined, 'normal');
    const nextFilters = data.nextFilterChange || {};
    doc.text(`FPP-001: ${formatDate(nextFilters.fpp001)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`FCA-001: ${formatDate(nextFilters.fca001)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`DRM-001: ${formatDate(nextFilters.drm001)}`, margin + 5, yPosition);
    yPosition += 5;
    doc.text(`DRM-002: ${formatDate(nextFilters.drm002)}`, margin + 5, yPosition);
    yPosition += 15;
    
    // Observações
    if (data.notes) {
        checkPageBreak(30);
        // Linha divisória
        doc.line(margin, yPosition, pageWidth - margin, yPosition);
        yPosition += 10;
        
        doc.setFont(undefined, 'bold');
        doc.text('8. OBSERVAÇÕES', margin, yPosition);
        yPosition += 8;
        
        doc.setFont(undefined, 'normal');
        const splitNotes = doc.splitTextToSize(data.notes, pageWidth - margin * 2 - 10);
        doc.text(splitNotes, margin + 5, yPosition);
        yPosition += splitNotes.length * 5 + 10;
    }
    
    // Footer em todas as páginas
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        const footerY = pageHeight - 10;
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Relatório gerado em: ${formatDateTime(new Date())}`, margin, footerY);
        doc.text(`Clean DataLog - Sistema de Monitoramento`, pageWidth / 2, footerY, { align: 'center' });
        doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin - 20, footerY, { align: 'right' });
    }
    
    // Voltar para a primeira página
    doc.setPage(1);
    
    // Save the PDF
    doc.save(`controle_osmose_${formatDate(data.createdAt).replace(/-/g, '')}.pdf`);
}

        async function exportAllOsmosisCardsToPDF() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            if (filteredOsmosisData.length === 0) {
                alert('Nenhum registro de controle diário encontrado para exportação.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            for (let i = 0; i < filteredOsmosisData.length; i++) {
                const data = filteredOsmosisData[i];
                
                // Adicionar nova página para cada card (exceto a primeira)
                if (i > 0) {
                    doc.addPage();
                }
                
                // Configurações da página
                const pageWidth = doc.internal.pageSize.width;
                const margin = 14;
                let yPosition = margin;
                
                // Header com estilo melhorado
                doc.setFillColor(44, 62, 80); // Cor primária
                doc.rect(0, 0, pageWidth, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('RELATÓRIO DE CONTROLE DIÁRIO', pageWidth / 2, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.text('Sistema de Osmose Reversa', pageWidth / 2, 22, { align: 'center' });
                
                // Informações do registro
                doc.setTextColor(0, 0, 0);
                yPosition = 40;
                
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, pageWidth - margin * 2, 20, 'F');
                
                doc.setFontSize(10);
                doc.text(`Data do Registro: ${new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR')}`, margin + 5, yPosition + 8);
                doc.text(`Operador: ${data.userName || '-'}`, margin + 5, yPosition + 15);
                
                // Status com cor
                const statusColor = data.conductivityStatus === 'normal' ? [39, 174, 96] : 
                                  data.conductivityStatus === 'alert' ? [243, 156, 18] : [231, 76, 60];
                
                doc.setFillColor(...statusColor);
                doc.rect(pageWidth - margin - 40, yPosition + 5, 40, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text(getStatusText(data.conductivityStatus).toUpperCase(), pageWidth - margin - 20, yPosition + 12, { align: 'center' });
                
                yPosition += 30;
                
                // Seção de Condutividade
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('1. CONDUTIVIDADE DA ÁGUA PURIFICADA', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Resultado: ${data.conductivity || '-'} µS/cm`, margin + 5, yPosition);
                yPosition += 15;
                
                // Linha divisória
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Seção de Sanitização
                doc.setFont(undefined, 'bold');
                doc.text('2. SANITIZAÇÃO DO SISTEMA', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Última sanitização: ${data.lastSanitization || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Próxima sanitização: ${data.nextSanitization || '-'}`, margin + 5, yPosition);
                yPosition += 15;
                
                // Linha divisória
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Seção de Higienização
                doc.setFont(undefined, 'bold');
                doc.text('3. HIGIENIZAÇÃO', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Última higienização: ${data.lastCleaning || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Próxima higienização: ${data.nextCleaning || '-'}`, margin + 5, yPosition);
                yPosition += 15;
                
                // Linha divisória
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Seção de Coleta
                doc.setFont(undefined, 'bold');
                doc.text('4. COLETA DE ÁGUA PARA ANÁLISE', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Última coleta: ${data.lastCollection || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Próxima coleta: ${data.nextCollection || '-'}`, margin + 5, yPosition);
                yPosition += 15;
                
                // Linha divisória
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Seção de Anormalidade
                doc.setFont(undefined, 'bold');
                doc.text('5. ANORMALIDADE NO FUNCIONAMENTO', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Apresenta anormalidade: ${data.hasAbnormality ? 'Sim' : 'Não'}`, margin + 5, yPosition);
                yPosition += 5;
                
                if (data.hasAbnormality && data.abnormalityReason) {
                    doc.text(`Motivo: ${data.abnormalityReason}`, margin + 5, yPosition);
                    yPosition += 10;
                } else {
                    yPosition += 5;
                }
                
                // Linha divisória
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Seção de Troca de Filtros - Última
                doc.setFont(undefined, 'bold');
                doc.text('6. TROCA DE FILTROS - ÚLTIMA', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                const lastFilters = data.lastFilterChange || {};
                doc.text(`FPP-001: ${lastFilters.fpp001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`FCA-001: ${lastFilters.fca001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-001: ${lastFilters.drm001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-002: ${lastFilters.drm002 || '-'}`, margin + 5, yPosition);
                yPosition += 15;
                
                // Linha divisória
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Seção de Troca de Filtros - Próxima
                doc.setFont(undefined, 'bold');
                doc.text('7. TROCA DE FILTROS - PRÓXIMA', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                const nextFilters = data.nextFilterChange || {};
                doc.text(`FPP-001: ${nextFilters.fpp001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`FCA-001: ${nextFilters.fca001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-001: ${nextFilters.drm001 || '-'}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`DRM-002: ${nextFilters.drm002 || '-'}`, margin + 5, yPosition);
                yPosition += 15;
                
                // Observações
                if (data.notes) {
                    // Linha divisória
                    doc.line(margin, yPosition, pageWidth - margin, yPosition);
                    yPosition += 10;
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('8. OBSERVAÇÕES', margin, yPosition);
                    yPosition += 8;
                    
                    doc.setFont(undefined, 'normal');
                    const splitNotes = doc.splitTextToSize(data.notes, pageWidth - margin * 2);
                    doc.text(splitNotes, margin + 5, yPosition);
                }
                
                // Footer
                const footerY = doc.internal.pageSize.height - 10;
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Relatório gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, footerY);
                doc.text(`Clean DataLog - Sistema de Monitoramento`, pageWidth / 2, footerY, { align: 'center' });
                doc.text(`Página ${i + 1} de ${filteredOsmosisData.length}`, pageWidth - margin - 20, footerY, { align: 'right' });
            }
            
            // Save the PDF
            doc.save(`controles_osmose_completo_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // Funções de exportação PDF existentes
        async function exportToPDF(type) {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem exportar relatórios em PDF.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text(`Relatório de ${getReportTitle(type)}`, 14, 15);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, 22);
            doc.text(`Gerado por: ${currentUser.name}`, 14, 28);
            
            try {
                let headers = [];
                let data = [];
                
                switch(type) {
                    case 'temperature':
                        headers = [['Data/Hora', 'Sala', 'Período', 'Temp. Mín', 'Temp. Máx', 'Temp. Atual', 'Umid. Mín', 'Umid. Máx', 'Umid. Atual', 'Status']];
                        const tempSnapshot = await db.collection('temperature_readings')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        tempSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                item.roomName || '-',
                                item.period || '-',
                                `${item.tempMin || '-'}°C`,
                                `${item.tempMax || '-'}°C`,
                                `${item.tempActual || '-'}°C`,
                                `${item.humidityMin || '-'}%`,
                                `${item.humidityMax || '-'}%`,
                                `${item.humidityActual || '-'}%`,
                                getStatusText(item.status)
                            ]);
                        });
                        break;
                        
                    case 'pressure':
                        headers = [['Data/Hora', 'Sala', 'Período', 'Pressão (Pa)', 'Correção', 'Status']];
                        const pressureSnapshot = await db.collection('pressure_readings')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        pressureSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                item.roomName || '-',
                                item.period || '-',
                                item.pressure || '-',
                                item.immediateCorrection || '-',
                                getStatusText(item.status)
                            ]);
                        });
                        break;
                        
                    case 'osmosis':
                        headers = [['Data/Hora', 'Condutividade (µS/cm)', 'Status', 'Anormalidade', 'Operador']];
                        const osmosisSnapshot = await db.collection('osmosis_daily')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        osmosisSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                `${item.conductivity || '-'} µS/cm`,
                                getStatusText(item.conductivityStatus),
                                item.hasAbnormality ? 'Sim' : 'Não',
                                item.userName || '-'
                            ]);
                        });
                        break;

                    case 'maintenance':
                        headers = [['Data', 'Procedimento', 'Observações', 'Operador']];
                        const maintenanceSnapshot = await db.collection('osmosis_maintenance')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        maintenanceSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.maintenanceDate ? 
                                new Date(item.maintenanceDate).toLocaleDateString('pt-BR') : '-';
                            data.push([
                                date,
                                item.procedure || '-',
                                item.observations || '-',
                                item.userName || '-'
                            ]);
                        });
                        break;
                        
                    case 'rooms':
                        headers = [['Código', 'Nome', 'Tipo', 'Responsável', 'Temp. Min-Max', 'Umid. Min-Max', 'Pressão Mínima', 'Status']];
                        const roomsSnapshot = await db.collection('rooms').get();
                        
                        roomsSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            data.push([
                                item.code || '-',
                                item.name || '-',
                                formatRoomType(item.type),
                                item.responsible || '-',
                                `${item.tempMin || '-'}°C - ${item.tempMax || '-'}°C`,
                                `${item.humidityMin || '-'}% - ${item.humidityMax || '-'}%`,
                                `${item.pressureMin || '-'} Pa`,
                                item.status === 'active' ? 'Ativa' : 'Inativa'
                            ]);
                        });
                        break;

                    case 'users':
                        headers = [['Nome', 'Email', 'Tipo', 'Data de Criação', 'Status']];
                        const usersSnapshot = await db.collection('users').get();
                        
                        usersSnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleDateString('pt-BR') : '-';
                            data.push([
                                item.name || '-',
                                item.email || '-',
                                item.role === 'admin' ? 'Administrador' : 'Usuário Normal',
                                date,
                                item.status === 'active' ? 'Ativo' : 'Inativo'
                            ]);
                        });
                        break;

                    case 'traceability':
                        headers = [['Data/Hora', 'Usuário', 'Ação', 'Detalhes', 'IP']];
                        const traceabilitySnapshot = await db.collection('traceability')
                            .orderBy('timestamp', 'desc')
                            .limit(100)
                            .get();
                        
                        traceabilitySnapshot.forEach(docItem => {
                            const item = docItem.data();
                            const date = item.createdAt ? 
                                new Date(item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt).toLocaleString('pt-BR') : '-';
                            data.push([
                                date,
                                item.userName || '-',
                                item.action || '-',
                                item.details || '-',
                                item.userIp || '-'
                            ]);
                        });
                        break;
                }
                
                // Generate table
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: 35,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] }
                });
                
                // Save the PDF
                doc.save(`relatorio_${type}_${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar relatório PDF');
            }
        }

        function generateReport() {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem gerar relatórios personalizados.');
                return;
            }
            
            const reportType = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const format = document.getElementById('report-format').value;
            
            if (format === 'pdf') {
                exportToPDF(reportType);
            } else {
                alert('Relatório CSV gerado com sucesso! (Funcionalidade de demonstração)');
            }
        }

        function getReportTitle(type) {
            const titles = {
                'temperature': 'Temperatura e Umidade',
                'pressure': 'Pressão',
                'osmosis': 'Sistema de Osmose',
                'rooms': 'Salas',
                'users': 'Usuários',
                'traceability': 'Rastreabilidade',
                'maintenance': 'Manutenções de Osmose'
            };
            return titles[type] || type;
        }

        // Criar usuário admin automaticamente se não existir
        async function createAdminUserIfNotExists() {
            try {
                const usersSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .limit(1)
                    .get();

                if (usersSnapshot.empty) {
                    // Tentar criar admin
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword('admin@labmonitor.com', '123456');
                        const adminData = {
                            name: 'Administrador',
                            email: 'admin@labmonitor.com',
                            role: 'admin',
                            createdAt: new Date(),
                            status: 'active'
                        };
                        await db.collection('users').doc(userCredential.user.uid).set(adminData);
                        console.log('Usuário admin criado automaticamente');
                    } catch (error) {
                        console.log('Admin já existe ou erro ao criar:', error);
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar admin:', error);
            }
        }

        // Executar na inicialização
        createAdminUserIfNotExists();

        // ========== SISTEMA DE NOTIFICAÇÕES ==========

// ========== FUNÇÃO createNotification() SEGURA ==========
// ========== FUNÇÃO createNotification() FINAL ==========
async function createNotification(type, title, message, recordId, recordType) {
    console.log(`=== CRIANDO NOTIFICAÇÃO (${type}) ===`);
    
    // VERIFICAÇÕES CRÍTICAS
if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'qualidade')) {
    console.error('Apenas administradores e equipe de qualidade podem criar notificações do sistema');
    return;
}
    
    // VALIDAR DADOS
    if (!type || !title || !message) {
        console.error('Dados incompletos para criar notificação');
        return;
    }
    
    if (!['alert', 'critical', 'info'].includes(type)) {
        console.error('Tipo de notificação inválido:', type);
        return;
    }
    
    try {
        // BUSCAR TODOS OS ADMIN/QUALIDADE ATIVOS
        const adminsSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .get();
        
        console.log(`Total de usuários ativos: ${adminsSnapshot.size}`);
        
        const targetUsers = [];
        adminsSnapshot.forEach(doc => {
            const user = doc.data();
            if (user.role === 'admin' || user.role === 'qualidade') {
                targetUsers.push({
                    id: doc.id,
                    ...user
                });
            }
        });
        
        console.log(`Usuários alvo (admin/qualidade): ${targetUsers.length}`);
        
        if (targetUsers.length === 0) {
            console.log('Nenhum administrador/qualidade encontrado para notificar');
            return;
        }
        
        // CRIAR NOTIFICAÇÕES EM BATCH
        const batch = db.batch();
        const now = new Date();
        
        for (const user of targetUsers) {
            // Verificar se já existe notificação não lida
            const existingNotification = await checkExistingNotification(recordId, user.id);
            
            if (!existingNotification) {
                const notificationRef = db.collection('notifications').doc();
                
                const notificationData = {
                    type: type,
                    title: title,
                    message: message,
                    recordId: recordId || null,
                    recordType: recordType || null,
                    userId: user.id,
                    userName: user.name || 'Usuário',
                    read: false,
                    systemGenerated: true, // IMPORTANTE: flag para regras do Firebase
                    createdAt: now,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log(`Criando notificação para: ${user.email}`);
                batch.set(notificationRef, notificationData);
            } else {
                console.log(`Notificação já existe para ${user.email}`);
            }
        }
        
        // EXECUTAR BATCH
        await batch.commit();
        console.log('✅ Notificações criadas com sucesso!');
        
        // ATUALIZAR CONTADOR PARA O USUÁRIO ATUAL
        updateNotificationCount();
        
    } catch (error) {
        console.error('❌ Erro ao criar notificações:', error);
        
        // Mensagem de erro detalhada
        if (error.code === 'permission-denied') {
            console.error('Permissão negada. Verifique as regras do Firebase.');
        }
    }
}

// Função auxiliar para verificar notificação existente
async function checkExistingNotification(recordId, userId) {
    if (!recordId) return false;
    
    try {
        const snapshot = await db.collection('notifications')
            .where('recordId', '==', recordId)
            .where('userId', '==', userId)
            .where('read', '==', false)
            .limit(1)
            .get();
        
        return !snapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar notificação existente:', error);
        return false;
    }
}

// Função auxiliar para verificar notificação existente
async function checkIfNotificationExists(recordId, userId) {
    try {
        const snapshot = await db.collection('notifications')
            .where('recordId', '==', recordId)
            .where('userId', '==', userId)
            .where('read', '==', false)
            .limit(1)
            .get();
        
        return !snapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar notificação:', error);
        return false; // Em caso de erro, permitir criação
    }
}

async function checkNotificationExistsForUser(recordId, userId) {
    try {
        const snapshot = await db.collection('notifications')
            .where('recordId', '==', recordId)
            .where('userId', '==', userId)
            .where('read', '==', false)
            .limit(1)
            .get();
        
        return !snapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar notificação para usuário:', error);
        return false;
    }
}

// ========== FUNÇÃO checkAndCreateNotification() ATUALIZADA ==========
// ========== FUNÇÃO checkAndCreateNotification() ATUALIZADA ==========
async function checkAndCreateNotification(data, recordType, recordId) {
    console.log(`=== VERIFICANDO NOTIFICAÇÃO PARA ${recordType.toUpperCase()} ===`);
    console.log(`Usuário que fez apontamento: ${currentUser?.name} (${currentUser?.role})`);
    
    // 1. VERIFICAR SE PRECISA DE NOTIFICAÇÃO (QUALQUER USUÁRIO)
    let needsNotification = false;
    let alertType = '';
    
    switch(recordType) {
        case 'temperature_readings':
            console.log(`Status temperatura: ${data.status}`);
            if (data.status === 'alert' || data.status === 'critical') {
                needsNotification = true;
                alertType = data.status;
                console.log(`⚠️ Temperatura ${alertType} detectada!`);
            }
            break;
            
        case 'pressure_readings':
            console.log(`Status pressão: ${data.status}`);
            if (data.status === 'alert' || data.status === 'critical') {
                needsNotification = true;
                alertType = data.status;
                console.log(`⚠️ Pressão ${alertType} detectada!`);
            }
            break;
            
        case 'osmosis_daily':
            console.log(`Status osmose: ${data.conductivityStatus}`);
            if (data.conductivityStatus === 'alert' || data.conductivityStatus === 'critical') {
                needsNotification = true;
                alertType = data.conductivityStatus;
                console.log(`⚠️ Osmose ${alertType} detectada!`);
            }
            break;
    }
    
    // 2. CRIAR NOTIFICAÇÃO SE NECESSÁRIO (PARA QUALQUER USUÁRIO)
    if (needsNotification && alertType) {
        console.log(`✅ CRIANDO NOTIFICAÇÃO ${alertType.toUpperCase()} PARA ADMIN/QUALIDADE`);
        console.log(`Registro: ${recordType} - ID: ${recordId}`);
        
        // NÃO VERIFICAR PERMISSÕES AQUI - QUALQUER USUÁRIO PODE DISPARAR NOTIFICAÇÃO
        await createNotificationForAdmins(data, recordType, recordId, alertType);
        
        // Registrar rastreabilidade
        await addTraceability(
            'Notificação automática criada',
            `${recordType.replace('_', ' ')} com status ${alertType} criou notificação para admin/qualidade`
        );
        
    } else {
        console.log('✅ Status normal, sem notificação necessária');
    }
}

// ========== FUNÇÃO updateNotificationCount() CORRIGIDA ==========
// ========== FUNÇÃO updateNotificationCount() ATUALIZADA ==========
async function updateNotificationCount() {
    console.log('=== ATUALIZANDO CONTADOR DE NOTIFICAÇÕES ===');
    
    // Verificar se usuário está autenticado
    if (!currentUser) {
        console.log('Usuário não autenticado');
        return;
    }
    
    const countElement = document.getElementById('notification-count');
    const notificationBtn = document.getElementById('notification-btn');
    
    try {
        console.log('Buscando notificações não lidas para:', currentUser.uid);
        
        // BUSCAR APENAS NOTIFICAÇÕES NÃO LIDAS DO USUÁRIO ATUAL
        const unreadQuery = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .where('read', '==', false)
            .get();
        
        const unreadCount = unreadQuery.size;
        console.log('Notificações não lidas encontradas:', unreadCount);
        
        // MOSTRAR BOTÃO DE NOTIFICAÇÕES APENAS SE USUÁRIO TEM PERMISSÃO
        // (admin/qualidade veem, outros não)
        if (currentUser.role === 'admin' || currentUser.role === 'qualidade') {
            notificationBtn.style.display = 'inline-flex';
            
            if (unreadCount > 0) {
                countElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
                countElement.style.display = 'flex';
                countElement.style.animation = 'pulse 2s infinite';
                notificationBtn.style.border = '2px solid #e74c3c';
            } else {
                countElement.style.display = 'none';
                notificationBtn.style.border = 'none';
            }
        } else {
            // Usuários comuns não veem o botão de notificações
            notificationBtn.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Erro ao atualizar contador:', error);
        countElement.style.display = 'none';
    }
}

// ========== FUNÇÃO loadNotifications() CORRIGIDA ==========
// ========== FUNÇÃO loadNotifications() CORRIGIDA ==========
async function loadNotifications() {
    console.log('=== CARREGANDO NOTIFICAÇÕES ===');
    
    // Verificar se usuário está autenticado
    if (!currentUser) {
        console.log('Usuário não autenticado');
        document.getElementById('notification-list').innerHTML = `
            <div class="empty-notifications">
                <i class="fas fa-ban"></i>
                <p>Faça login para ver notificações</p>
            </div>
        `;
        return;
    }
    
    // PERMITIR ACESSO A QUALQUER USUÁRIO, MAS MOSTRAR APENAS SUAS NOTIFICAÇÕES
    try {
        console.log('Buscando notificações para usuário:', currentUser.uid);
        
        // BUSCAR NOTIFICAÇÕES DO USUÁRIO ATUAL (admin/qualidade veem suas próprias)
        const notificationsSnapshot = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        console.log('Notificações encontradas:', notificationsSnapshot.size);
        
        const notificationList = document.getElementById('notification-list');
        notificationList.innerHTML = '';
        
        if (notificationsSnapshot.empty) {
            notificationList.innerHTML = `
                <div class="empty-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <p>Nenhuma notificação encontrada</p>
                    <small style="color: #999;">Novas notificações aparecerão aqui</small>
                </div>
            `;
            return;
        }
        
        // PERCORRER NOTIFICAÇÕES
        notificationsSnapshot.forEach(doc => {
            const notification = { id: doc.id, ...doc.data() };
            
            // Criar elemento de notificação
            const notificationElement = createNotificationElement(notification);
            notificationList.appendChild(notificationElement);
        });
        
        // ATUALIZAR CONTADOR NO BOTÃO
        updateNotificationCount();
        
    } catch (error) {
        console.error('Erro ao carregar notificações:', error);
        
        const notificationList = document.getElementById('notification-list');
        notificationList.innerHTML = `
            <div class="empty-notifications" style="color: #e74c3c;">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erro ao carregar notificações</p>
                <p style="font-size: 12px;">${error.message}</p>
                <button class="btn btn-sm btn-primary" onclick="loadNotifications()" style="margin-top: 10px;">
                    <i class="fas fa-redo"></i> Tentar novamente
                </button>
            </div>
        `;
    }
}

// Função para recarregar notificações
function refreshNotifications() {
    console.log('Recarregando notificações...');
    loadNotifications();
}

// ========== FUNÇÃO createNotificationElement() CORRIGIDA ==========
function createNotificationElement(notification) {
    console.log('Criando elemento para notificação:', notification.id);
    
    const div = document.createElement('div');
    div.className = `notification-item ${notification.read ? '' : 'unread'}`;
    div.dataset.notificationId = notification.id;
    
    // FORMATAR DATA
    let dateString = 'Data desconhecida';
    try {
        if (notification.createdAt) {
            const date = notification.createdAt.toDate ? 
                        notification.createdAt.toDate() : 
                        new Date(notification.createdAt);
            
            if (!isNaN(date.getTime())) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 60) {
                    dateString = `${diffMins} min atrás`;
                } else if (diffHours < 24) {
                    dateString = `${diffHours} h atrás`;
                } else if (diffDays < 7) {
                    dateString = `${diffDays} dia(s) atrás`;
                } else {
                    dateString = date.toLocaleDateString('pt-BR');
                }
            }
        }
    } catch (error) {
        console.error('Erro ao formatar data:', error);
    }
    
    // DETERMINAR COR E ÍCONE PELO TIPO
    let typeClass = 'notification-info';
    let typeIcon = 'fa-info-circle';
    let typeText = 'INFO';
    
    switch(notification.type) {
        case 'critical':
            typeClass = 'notification-critical';
            typeIcon = 'fa-exclamation-circle';
            typeText = 'CRÍTICO';
            break;
        case 'alert':
            typeClass = 'notification-alert';
            typeIcon = 'fa-exclamation-triangle';
            typeText = 'ALERTA';
            break;
        default:
            typeClass = 'notification-info';
            typeIcon = 'fa-info-circle';
            typeText = 'INFO';
    }
    
    // ADICIONAR CLASSE DE TIPO
    div.classList.add(typeClass.replace('notification-', ''));
    
    // CONSTRUIR HTML
    div.innerHTML = `
        <div class="notification-header">
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <span class="notification-type ${notification.type}">
                        <i class="fas ${typeIcon}" style="margin-right: 5px;"></i>
                        ${typeText}
                    </span>
                    <span class="notification-title">${notification.title || 'Sem título'}</span>
                </div>
                <div class="notification-time">
                    <i class="far fa-clock"></i> ${dateString}
                </div>
            </div>
            ${!notification.read ? `
            <button class="btn-mark-read" onclick="markSingleAsRead('${notification.id}', event)" 
                    style="background: none; border: none; color: #3498db; cursor: pointer; padding: 5px;" 
                    title="Marcar como lida">
                <i class="fas fa-check"></i>
            </button>
            ` : ''}
        </div>
        
        <div class="notification-message">
            ${notification.message || 'Sem mensagem'}
        </div>
        
        <div style="font-size: 11px; color: var(--gray); margin-top: 8px;">
            <i class="fas fa-database"></i> Tipo: ${formatRecordType(notification.recordType || 'desconhecido')}
            ${notification.recordId ? ` • ID: ${notification.recordId.substring(0, 8)}...` : ''}
        </div>
        
        ${notification.recordId ? `
        <div class="notification-actions">
            <button class="btn btn-sm btn-primary" onclick="navigateToNotification('${notification.id}')" style="padding: 4px 8px; font-size: 11px;">
                <i class="fas fa-external-link-alt"></i> Ver registro
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteNotification('${notification.id}')" style="padding: 4px 8px; font-size: 11px;">
                <i class="fas fa-trash"></i> Excluir
            </button>
        </div>
        ` : ''}
    `;
    
    // ADICIONAR EVENTO DE CLIQUE PARA MARCAR COMO LIDA
    if (!notification.read) {
        div.addEventListener('click', function(e) {
            // Não marcar como lida se clicar em botões específicos
            if (!e.target.closest('button')) {
                markSingleAsRead(notification.id);
            }
        });
    }
    
    return div;
}

// Função para formatar tipo de registro
function formatRecordType(type) {
    const types = {
        'temperature_readings': '🌡️ Temperatura',
        'pressure_readings': '📊 Pressão',
        'osmosis_daily': '💧 Osmose',
        'rooms': '🏢 Sala',
        'users': '👤 Usuário',
        'desconhecido': '📝 Geral'
    };
    return types[type] || type;
}

async function markAsRead(notificationId) {
    try {
        await db.collection('notifications').doc(notificationId).update({
            read: true,
            readAt: new Date()
        });
        
        // Recarregar notificações
        loadNotifications();
        
    } catch (error) {
        console.error('Erro ao marcar notificação como lida:', error);
    }
}

// ========== FUNÇÕES AUXILIARES PARA NOTIFICAÇÕES ==========

// Marcar uma notificação como lida
async function markSingleAsRead(notificationId, event = null) {
    if (event) {
        event.stopPropagation();
    }
    
    console.log('Marcando notificação como lida:', notificationId);
    
    try {
        await db.collection('notifications').doc(notificationId).update({
            read: true,
            readAt: new Date()
        });
        
        // Atualizar visualmente o item
        const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationElement) {
            notificationElement.classList.remove('unread');
            notificationElement.classList.add('read');
            
            // Remover botão de marcar como lida
            const markReadBtn = notificationElement.querySelector('.btn-mark-read');
            if (markReadBtn) {
                markReadBtn.remove();
            }
        }
        
        // Atualizar contador
        updateNotificationCount();
        
        // Atualizar título do modal
        setTimeout(() => {
            const unreadElements = document.querySelectorAll('.notification-item.unread');
            const titleElement = document.querySelector('#notification-modal .edit-modal-title');
            if (titleElement) {
                const unreadCount = unreadElements.length;
                titleElement.innerHTML = `
                    <i class="fas fa-bell"></i> Notificações do Sistema
                    ${unreadCount > 0 ? `<span style="color: #e74c3c; font-size: 14px; margin-left: 10px;">(${unreadCount} não lidas)</span>` : ''}
                    ${unreadCount > 0 ? `<button class="btn btn-sm btn-primary" onclick="markAllAsRead()" style="float: right; margin-left: 10px;">
                        <i class="fas fa-check-double"></i> Marcar todas
                    </button>` : ''}
                    <button class="btn btn-sm btn-secondary" onclick="refreshNotifications()" style="float: right;">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                `;
            }
        }, 100);
        
    } catch (error) {
        console.error('Erro ao marcar notificação como lida:', error);
        alert('Erro ao marcar notificação como lida');
    }
}

// Marcar todas como lidas
async function markAllAsRead() {
    if (!currentUser) return;
    
    const confirm = await showConfirm('Marcar todas as notificações como lidas?');
    
    if (!confirm) return;

    try {
        console.log('Marcando todas as notificações como lidas para:', currentUser.uid);
        
        // Buscar todas as não lidas
        const unreadNotifications = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .where('read', '==', false)
            .get();
        
        if (unreadNotifications.empty) {
            showInfo('Informação', 'Nenhuma notificação não lida encontrada.');
            return;
        }
        
        // Atualizar em batch
        const batch = db.batch();
        unreadNotifications.forEach(doc => {
            batch.update(doc.ref, {
                read: true,
                readAt: new Date()
            });
        });
        
        await batch.commit();
        console.log(`${unreadNotifications.size} notificações marcadas como lidas`);
        
        // Recarregar notificações
        loadNotifications();
        
        // Atualizar contador
        updateNotificationCount();
        
        showSuccess('Sucesso', `${unreadNotifications.size} notificações marcadas como lidas.`);
        
    } catch (error) {
        console.error('Erro ao marcar todas como lidas:', error);
        showError('Erro', 'Erro ao marcar notificações como lidas: ' + error.message);
    }
}

// Deletar uma notificação
async function deleteNotification(notificationId) {
    if (!confirm('Excluir esta notificação permanentemente?')) {
        return;
    }
    
    try {
        await db.collection('notifications').doc(notificationId).delete();
        console.log('Notificação excluída:', notificationId);
        
        // Remover elemento da lista
        const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationElement) {
            notificationElement.style.animation = 'fadeOut 0.3s';
            setTimeout(() => {
                notificationElement.remove();
                
                // Verificar se a lista ficou vazia
                const notificationList = document.getElementById('notification-list');
                if (notificationList.children.length === 0) {
                    notificationList.innerHTML = `
                        <div class="empty-notifications">
                            <i class="fas fa-bell-slash"></i>
                            <p>Nenhuma notificação encontrada</p>
                        </div>
                    `;
                }
            }, 300);
        }
        
        // Atualizar contador
        updateNotificationCount();
        
    } catch (error) {
        console.error('Erro ao excluir notificação:', error);
        alert('Erro ao excluir notificação');
    }
}

// Navegar para o registro relacionado
async function navigateToNotification(notificationId) {
    try {
        // Buscar dados da notificação
        const notificationDoc = await db.collection('notifications').doc(notificationId).get();
        
        if (!notificationDoc.exists) {
            alert('Notificação não encontrada.');
            return;
        }
        
        const notification = notificationDoc.data();
        
        // Fechar modal
        hideNotificationModal();
        
        // Navegar baseado no tipo de registro
        if (notification.recordType && notification.recordId) {
            switch(notification.recordType) {
                case 'temperature_readings':
                    // Ir para temperatura
                    document.querySelector('.menu-item[data-page="temperature"]').click();
                    
                    // Destacar registro específico (implementação futura)
                    highlightRecord('temperature', notification.recordId);
                    break;
                    
                case 'pressure_readings':
                    // Ir para pressão
                    document.querySelector('.menu-item[data-page="pressure"]').click();
                    highlightRecord('pressure', notification.recordId);
                    break;
                    
                case 'osmosis_daily':
                    // Ir para osmose
                    document.querySelector('.menu-item[data-page="osmosis"]').click();
                    highlightRecord('osmosis', notification.recordId);
                    break;
                    
                default:
                    alert('Navegação para este tipo de registro não implementada.');
            }
        } else {
            alert('Esta notificação não está vinculada a um registro específico.');
        }
        
        // Marcar como lida após navegar
        await markSingleAsRead(notificationId);
        
    } catch (error) {
        console.error('Erro ao navegar para notificação:', error);
        alert('Erro ao processar navegação');
    }
}

// Destacar registro (implementação básica)
function highlightRecord(collection, recordId) {
    console.log(`Destacando registro ${recordId} da coleção ${collection}`);
    
    // Implementação básica - você pode expandir isso
    alert(`Registro ${recordId.substring(0, 8)}... será destacado na lista.`);
    
    // Aqui você pode implementar lógica para:
    // 1. Rolar até o registro na tabela
    // 2. Adicionar classe de destaque
    // 3. Focar no elemento
}

function navigateToRecord(recordType, recordId) {
    // Fechar modal de notificações
    hideNotificationModal();
    
    // Navegar para a página correta
    switch(recordType) {
        case 'temperature':
            // Ir para página de temperatura
            document.querySelector('.menu-item[data-page="temperature"]').click();
            break;
        case 'pressure':
            // Ir para página de pressão
            document.querySelector('.menu-item[data-page="pressure"]').click();
            break;
        case 'osmosis':
            // Ir para página de osmose
            document.querySelector('.menu-item[data-page="osmosis"]').click();
            break;
    }
    
    // Aqui você pode adicionar lógica para destacar o registro específico
    // Isso depende da sua implementação de UI
    console.log(`Navegar para ${recordType} com ID: ${recordId}`);
}

function formatRecordType(type) {
    const types = {
        'temperature': 'Temperatura/Umidade',
        'pressure': 'Pressão',
        'osmosis': 'Sistema de Osmose'
    };
    return types[type] || type;
}

// ========== FUNÇÃO showNotificationModal() CORRIGIDA ==========
function showNotificationModal() {
    console.log('=== ABRINDO MODAL DE NOTIFICAÇÕES ===');
    
    if (!currentUser) {
        showWarning('Acesso Negado', 'Por favor, faça login para ver notificações.');
        return;
    }
    
    if (currentUser.role !== 'admin' && currentUser.role !== 'qualidade') {
        showWarning('Permissão Insuficiente', 'Apenas administradores e equipe de qualidade podem acessar notificações.');
        return;
    }
    
    // Mostrar modal
    const modal = document.getElementById('notification-modal');
    modal.style.display = 'flex';
    
    // Carregar notificações
    setTimeout(() => {
        loadNotifications();
    }, 100);
}

function hideNotificationModal() {
    const modal = document.getElementById('notification-modal');
    modal.style.display = 'none';
    
    // Remover animação
    modal.querySelector('.edit-modal-content').style.animation = '';
    
    console.log('Modal de notificações fechado');
}

function hideNotificationModal() {
    document.getElementById('notification-modal').style.display = 'none';
}

async function checkNotificationExists(recordId, userId) {
    try {
        const snapshot = await db.collection('notifications')
            .where('recordId', '==', recordId)
            .where('userId', '==', userId)
            .limit(1)
            .get();
        
        return !snapshot.empty;
    } catch (error) {
        console.error('Erro ao verificar notificação:', error);
        return false;
    }
}

async function debugNotifications() {
    if (!currentUser || currentUser.role !== 'admin') return;
    
    try {
        console.log("=== DEBUG NOTIFICAÇÕES ===");
        console.log("Usuário atual:", currentUser.uid, currentUser.email);
        
        // Verificar todas as notificações
        const allNotifications = await db.collection('notifications').get();
        console.log("Total de notificações no sistema:", allNotifications.size);
        
        allNotifications.forEach(doc => {
            const notif = doc.data();
            console.log(`Notificação ${doc.id}:`, {
                userId: notif.userId,
                title: notif.title,
                read: notif.read,
                type: notif.type,
                userName: notif.userName
            });
        });
        
        // Verificar notificações do usuário atual
        const userNotifications = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .get();
        
        console.log(`Notificações do usuário atual (${currentUser.uid}):`, userNotifications.size);
        
        userNotifications.forEach(doc => {
            const notif = doc.data();
            console.log(`- ${doc.id}: ${notif.title} (lida: ${notif.read})`);
        });
        
    } catch (error) {
        console.error("Erro no debug:", error);
    }
}

// Adicionar botão de debug (apenas para desenvolvimento)
function addDebugButton() {
    if (currentUser && currentUser.role === 'admin') {
        const debugBtn = document.createElement('button');
        debugBtn.className = 'btn btn-sm btn-warning';
        debugBtn.innerHTML = '<i class="fas fa-bug"></i>';
        debugBtn.style.marginLeft = '10px';
        debugBtn.style.fontSize = '12px';
        debugBtn.style.padding = '5px 8px';
        debugBtn.title = 'Debug Notificações';
        debugBtn.onclick = debugNotifications;
        
        document.querySelector('.user-info').appendChild(debugBtn);
    }
}

async function cleanupOldNotifications() {
    if (!currentUser || currentUser.role !== 'admin') return;
    
    try {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const oldNotifications = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .where('createdAt', '<', thirtyDaysAgo)
            .get();
        
        const batch = db.batch();
        oldNotifications.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        console.log(`Removidas ${oldNotifications.size} notificações antigas.`);
        
    } catch (error) {
        console.error('Erro ao limpar notificações antigas:', error);
    }
}

// Executar limpeza uma vez por dia
setInterval(cleanupOldNotifications, 24 * 60 * 60 * 1000);

// ========== FUNÇÃO DE DEBUG PARA NOTIFICAÇÕES ==========
// ========== FUNÇÃO DE DEBUG PARA NOTIFICAÇÕES (SEM ENVIO DE TESTE) ==========
async function debugNotificationsSystem() {
    console.log('=== DEBUG DO SISTEMA DE NOTIFICAÇÕES ===');
    
    if (!currentUser) {
        showError('Erro', 'Usuário não autenticado');
        return;
    }
    
    try {
        // 1. VERIFICAR NOTIFICAÇÕES NO BANCO
        const allNotifications = await db.collection('notifications').get();
        
        // 2. VERIFICAR NOTIFICAÇÕES DO USUÁRIO ATUAL
        const userNotifications = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .get();
        
        // 3. VERIFICAR NÃO LIDAS
        const unreadNotifications = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .where('read', '==', false)
            .get();
        
        showInfo('Debug do Sistema', 
            `📊 Informações do usuário:\n• UID: ${currentUser.uid}\n• Email: ${currentUser.email}\n• Role: ${currentUser.role}\n\n📈 Resultados:\n• Total no sistema: ${allNotifications.size}\n• Suas notificações: ${userNotifications.size}\n• Não lidas: ${unreadNotifications.size}\n\n✅ Debug completo!`,
            {
                onOk: () => {
                    updateNotificationCount();
                    loadNotifications();
                }
            }
        );
        
    } catch (error) {
        console.error('Erro no debug:', error);
        showError('Erro no Debug', `❌ ERRO\n\nMensagem: ${error.message}\nCódigo: ${error.code || 'N/A'}`);
    }
}


// ========== FUNÇÃO PARA NOTIFICAR ADMIN/QUALIDADE SOBRE APONTAMENTOS CRÍTICOS ==========
async function notifyAdminsAboutCriticalReading(data, recordType, recordId) {
    console.log(`Notificando sobre leitura crítica em ${recordType}`);
    
    // Determinar tipo e mensagem
    let type = '';
    let title = '';
    let message = '';
    
    switch(recordType) {
        case 'temperature_readings':
            type = data.status;
            title = `🌡️ Alerta de Temperatura/Umidade`;
            message = `Sala: ${data.roomName}\n`;
            message += `Status: ${getStatusText(data.status)}\n`;
            message += `Temperatura: ${data.tempActual}°C (Faixa: ${data.tempMin}-${data.tempMax}°C)\n`;
            message += `Umidade: ${data.humidityActual}% (Faixa: ${data.humidityMin}-${data.humidityMax}%)\n`;
            message += `Operador: ${data.userName || 'Desconhecido'}`;
            break;
            
        case 'pressure_readings':
            type = data.status;
            title = `📊 Alerta de Pressão`;
            message = `Sala: ${data.roomName}\n`;
            message += `Status: ${getStatusText(data.status)}\n`;
            message += `Pressão: ${data.pressure} Pa\n`;
            message += `Operador: ${data.userName || 'Desconhecido'}`;
            if (data.immediateCorrection) {
                message += `\nCorreção: ${data.immediateCorrection}`;
            }
            break;
            
        case 'osmosis_daily':
            type = data.conductivityStatus;
            title = `💧 Alerta de Osmose`;
            message = `Status: ${getStatusText(data.conductivityStatus)}\n`;
            message += `Condutividade: ${data.conductivity} µS/cm\n`;
            message += `Limite: 1.3 µS/cm\n`;
            message += `Operador: ${data.userName || 'Desconhecido'}`;
            break;
    }
    
    // Buscar todos os administradores e equipe de qualidade
    try {
        const adminsSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .where('role', 'in', ['admin', 'qualidade'])
            .get();
        
        if (adminsSnapshot.empty) {
            console.log('Nenhum admin/qualidade encontrado para notificar');
            return;
        }
        
        const batch = db.batch();
        const now = new Date();
        
        adminsSnapshot.forEach(doc => {
            const user = doc.data();
            const notificationRef = db.collection('notifications').doc();
            
            const notificationData = {
                type: type,
                title: title,
                message: message,
                recordId: recordId,
                recordType: recordType,
                userId: doc.id,
                userName: user.name || 'Usuário',
                read: false,
                systemGenerated: true,
                createdByUserId: currentUser ? currentUser.uid : 'system',
                createdByUserName: currentUser ? currentUser.name : 'Sistema',
                createdAt: now,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            batch.set(notificationRef, notificationData);
        });
        
        await batch.commit();
        console.log(`✅ ${adminsSnapshot.size} notificação(ões) criada(s) para admin/qualidade`);
        
    } catch (error) {
        console.error('Erro ao notificar admin/qualidade:', error);
    }
}

// ========== FUNÇÃO PARA CRIAR NOTIFICAÇÕES DO SISTEMA ==========
async function createSystemNotificationForAdmins(data, recordType, recordId, alertType) {
    console.log(`=== CRIANDO NOTIFICAÇÃO DO SISTEMA PARA ADMINS ===`);
    
    // Validação básica
    if (!recordType || !recordId || !alertType) {
        console.error('Dados incompletos para criar notificação do sistema');
        return;
    }
    
    // Determinar título e mensagem baseado no tipo de registro
    let title = '';
    let message = '';
    const userName = data.userName || currentUser?.name || 'Usuário';
    
    switch(recordType) {
        case 'temperature_readings':
            title = `🌡️ ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Temperatura/Umidade`;
            message = `Sala: ${data.roomName}\n`;
            message += `Status: ${getStatusText(alertType)}\n`;
            message += `Temperatura: ${data.tempActual}°C (Faixa: ${data.tempMin}-${data.tempMax}°C)\n`;
            message += `Umidade: ${data.humidityActual}% (Faixa: ${data.humidityMin}-${data.humidityMax}%)\n`;
            message += `Registrado por: ${userName}`;
            break;
            
        case 'pressure_readings':
            title = `📊 ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Pressão`;
            message = `Sala: ${data.roomName}\n`;
            message += `Status: ${getStatusText(alertType)}\n`;
            message += `Pressão: ${data.pressure} Pa\n`;
            message += `Registrado por: ${userName}`;
            if (data.immediateCorrection) {
                message += `\nCorreção: ${data.immediateCorrection}`;
            }
            break;
            
        case 'osmosis_daily':
            title = `💧 ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Sistema de Osmose`;
            message = `Status: ${getStatusText(alertType)}\n`;
            message += `Condutividade: ${data.conductivity} µS/cm\n`;
            message += `Limite: 1.3 µS/cm\n`;
            message += `Registrado por: ${userName}`;
            break;
            
        default:
            title = `⚠️ ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'} no Sistema`;
            message = `Tipo: ${recordType}\n`;
            message += `Status: ${getStatusText(alertType)}\n`;
            message += `Registrado por: ${userName}`;
    }
    
    try {
        // BUSCAR TODOS OS ADMIN/QUALIDADE ATIVOS
        const adminsSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .get();
        
        console.log(`Total de usuários ativos: ${adminsSnapshot.size}`);
        
        const targetUsers = [];
        adminsSnapshot.forEach(doc => {
            const user = doc.data();
            // APENAS admin e qualidade recebem notificações
            if (user.role === 'admin' || user.role === 'qualidade') {
                targetUsers.push({
                    id: doc.id,
                    name: user.name || 'Usuário',
                    email: user.email,
                    role: user.role
                });
            }
        });
        
        console.log(`Usuários alvo (admin/qualidade): ${targetUsers.length}`);
        
        if (targetUsers.length === 0) {
            console.log('Nenhum administrador/qualidade encontrado para notificar');
            return;
        }
        
        // IMPORTANTE: Para criar notificações, precisamos estar autenticados como admin/qualidade
        // Mas o usuário atual pode ser um usuário comum
        // Vamos usar uma abordagem diferente
        
        // Criar notificações em batch
        const batch = db.batch();
        const now = new Date();
        
        for (const user of targetUsers) {
            const notificationRef = db.collection('notifications').doc();
            
            const notificationData = {
                type: alertType,
                title: title,
                message: message,
                recordId: recordId,
                recordType: recordType,
                userId: user.id, // Usuário que vai RECEBER a notificação
                userName: user.name,
                read: false,
                systemGenerated: true,
                triggeredByUserId: currentUser?.uid || 'system', // Quem DISPAROU a notificação
                triggeredByUserName: userName,
                triggeredByUserRole: currentUser?.role || 'user',
                createdAt: now,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            console.log(`Criando notificação para: ${user.email} (${user.role})`);
            batch.set(notificationRef, notificationData);
        }
        
        // EXECUTAR BATCH - IMPORTANTE: Isso requer que o usuário atual TENHA permissão
        // Pelas regras, apenas admin/qualidade podem criar notificações
        // Então precisamos de uma solução alternativa
        
        // Tentar executar o batch
        try {
            await batch.commit();
            console.log(`✅ ${targetUsers.length} notificação(ões) criada(s) com sucesso!`);
            
            // ATUALIZAR CONTADOR PARA USUÁRIOS ADMIN/QUALIDADE
            // Se o usuário atual for admin/qualidade, atualize seu contador
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'qualidade')) {
    updateNotificationCount();
    setInterval(updateNotificationCount, 30000); // Atualizar a cada 30 segundos
}
            
        } catch (batchError) {
            console.error('Erro no batch commit:', batchError);
            
            // Se falhar por permissão, tentar criar uma notificação alternativa
            await createAlternativeNotification(title, message, recordType, recordId, alertType);
        }
        
    } catch (error) {
        console.error('❌ Erro ao criar notificações do sistema:', error);
        
        // Tentar método alternativo
        await createAlternativeNotification(title, message, recordType, recordId, alertType);
    }
}

// ========== FUNÇÃO SIMPLIFICADA PARA CRIAR NOTIFICAÇÕES ==========
// ========== FUNÇÃO createNotificationForAdmins() - PARA QUALQUER USUÁRIO ==========
// ========== FUNÇÃO createNotificationForAdmins() SIMPLIFICADA ==========
// Atualizar para incluir os novos perfis
async function createNotificationForAdmins(data, recordType, recordId, alertType) {
    console.log(`=== CRIANDO NOTIFICAÇÃO PARA USUÁRIOS COM PERMISSÃO ===`);
    
    // Validação básica
    if (!recordType || !recordId || !alertType) {
        console.error('Dados incompletos para criar notificação');
        return;
    }
    
    // Determinar título e mensagem
    let title = '';
    let message = '';
    const userName = data.userName || currentUser?.name || 'Usuário Desconhecido';
    const userRole = currentUser?.role || 'usuário';
    
    const now = new Date();
    const dataFormatada = now.toLocaleDateString('pt-BR');
    const horaFormatada = now.toLocaleTimeString('pt-BR');
    
    switch(recordType) {
        case 'temperature_readings':
            title = `🌡️ ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Temperatura/Umidade`;
            message = `Sala: ${data.roomName || 'Não informada'}\n`;
            message += `Temperatura: ${data.tempActual}°C (Faixa: ${data.tempMin}-${data.tempMax}°C)\n`;
            message += `Umidade: ${data.humidityActual}% (Faixa: ${data.humidityMin}-${data.humidityMax}%)\n`;
            message += `Registrado por: ${userName} (${userRole})\n`;
            message += `Data: ${dataFormatada} ${horaFormatada}`;
            break;
            
        case 'pressure_readings':
            title = `📊 ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Pressão`;
            message = `Sala: ${data.roomName || 'Não informada'}\n`;
            message += `Pressão: ${data.pressure} Pa\n`;
            message += `Registrado por: ${userName} (${userRole})\n`;
            message += `Data: ${dataFormatada} ${horaFormatada}`;
            if (data.immediateCorrection) {
                message += `\nCorreção: ${data.immediateCorrection}`;
            }
            break;
            
        case 'osmosis_daily':
            title = `💧 ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Sistema de Osmose`;
            message = `Condutividade: ${data.conductivity} µS/cm (Limite: 1.3 µS/cm)\n`;
            message += `Registrado por: ${userName} (${userRole})\n`;
            message += `Data: ${dataFormatada} ${horaFormatada}`;
            if (data.hasAbnormality) {
                message += `\nAnormalidade: Sim\n`;
                if (data.abnormalityReason) {
                    message += `Motivo: ${data.abnormalityReason}`;
                }
            }
            break;
    }
    
    console.log(`📨 Criando notificação: ${title}`);
    
    try {
        // BUSCAR APENAS USUÁRIOS QUE RECEBEM NOTIFICAÇÕES
        const usersSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .where('receivesNotifications', '==', true)
            .get();
        
        const targetUsers = [];
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            // Apenas admin, qualidade e manutenção que optaram por receber notificações
            if ((user.role === 'admin' || user.role === 'qualidade' || user.role === 'manutencao') && 
                user.receivesNotifications !== false) {
                targetUsers.push({
                    id: doc.id,
                    name: user.name || 'Usuário',
                    email: user.email,
                    role: user.role
                });
            }
        });
        
        console.log(`🎯 Usuários que recebem notificações: ${targetUsers.length}`);
        
        if (targetUsers.length === 0) {
            console.log('❌ Nenhum usuário configurado para receber notificações');
            return;
        }
        
        // CRIAR NOTIFICAÇÕES
        let successCount = 0;
        
        for (const user of targetUsers) {
            try {
                const notificationData = {
                    type: alertType,
                    title: title,
                    message: message,
                    recordId: recordId,
                    recordType: recordType,
                    userId: user.id,
                    userName: user.name,
                    read: false,
                    systemGenerated: true,
                    triggeredByUserId: currentUser?.uid || 'system',
                    triggeredByName: userName,
                    createdAt: now,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('notifications').add(notificationData);
                successCount++;
                console.log(`✅ Notificação criada para: ${user.email} (${user.role})`);
                
            } catch (userError) {
                console.error(`❌ Erro para ${user.email}:`, userError.message);
            }
        }
        
        console.log(`📊 Resultado: ${successCount}/${targetUsers.length} notificações criadas`);
        
        // ATUALIZAR CONTADOR DE NOTIFICAÇÕES
        if (currentUser && currentUser.receivesNotifications !== false) {
            setTimeout(updateNotificationCount, 1000);
        }
        
    } catch (error) {
        console.error('❌ Erro geral ao criar notificações:', error);
    }
}

// ========== FUNÇÃO PARA CRIAR NOTIFICAÇÕES DO SISTEMA ==========
async function createSystemNotification(data, recordType, recordId, alertType) {
    console.log(`Criando notificação do sistema para ${recordType}...`);
    
    try {
        // Determinar título e mensagem
        let title = '';
        let message = '';
        const userName = data.userName || currentUser?.name || 'Usuário';
        const userRole = currentUser?.role || 'user';
        
        if (recordType === 'temperature_readings') {
            title = `🌡️ ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Temperatura`;
            message = `Sala: ${data.roomName}\n`;
            message += `Temperatura: ${data.tempActual}°C (Faixa: ${data.tempMin}-${data.tempMax}°C)\n`;
            message += `Umidade: ${data.humidityActual}% (Faixa: ${data.humidityMin}-${data.humidityMax}%)`;
        } else if (recordType === 'pressure_readings') {
            title = `📊 ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Pressão`;
            message = `Sala: ${data.roomName}\n`;
            message += `Pressão: ${data.pressure} Pa`;
            if (data.immediateCorrection) {
                message += `\nCorreção: ${data.immediateCorrection}`;
            }
        } else if (recordType === 'osmosis_daily') {
            title = `💧 ${alertType === 'critical' ? 'CRÍTICO' : 'ALERTA'}: Osmose`;
            message = `Condutividade: ${data.conductivity} µS/cm\n`;
            message += `Limite: 1.3 µS/cm`;
        }
        
        message += `\n\n📝 Registrado por: ${userName} (${userRole})`;
        message += `\n🕒 Data: ${new Date().toLocaleString('pt-BR')}`;
        
        // Criar notificação do sistema (qualquer usuário pode criar)
        const systemNotification = {
            type: alertType,
            title: title,
            message: message,
            recordId: recordId,
            recordType: recordType,
            // IMPORTANTE: Não temos 'userId' aqui - é uma notificação do sistema
            // Admin/qualidade vão buscar todas as notificações do sistema
            createdByUserId: currentUser?.uid || 'system',
            createdByName: userName,
            createdByRole: userRole,
            readBy: [], // Array de IDs de admin/qualidade que leram
            systemNotification: true, // Flag para identificar como notificação do sistema
            createdAt: new Date(),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('system_notifications').add(systemNotification);
        console.log(`✅ Notificação do sistema criada com sucesso!`);
        
        // Se o usuário atual for admin/qualidade, também criar notificação pessoal
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'qualidade')) {
            await createPersonalNotificationForAdmins(data, recordType, recordId, alertType);
        }
        
    } catch (error) {
        console.error('❌ Erro ao criar notificação do sistema:', error);
    }
}

// ========== FUNÇÃO PARA CRIAR NOTIFICAÇÕES PESSOAIS (APENAS ADMIN/QUALIDADE) ==========
async function createPersonalNotificationForAdmins(data, recordType, recordId, alertType) {
    // Esta função só é chamada se o usuário atual for admin/qualidade
    console.log(`Criando notificações pessoais para outros admins...`);
    
    try {
        // Buscar todos os outros admin/qualidade (excluindo o usuário atual)
        const adminsSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .where('role', 'in', ['admin', 'qualidade'])
            .get();
        
        for (const doc of adminsSnapshot.docs) {
            const adminUser = doc.data();
            const adminUserId = doc.id;
            
            // Pular o usuário atual
            if (adminUserId === currentUser?.uid) {
                continue;
            }
            
            // Criar notificação pessoal
            const personalNotification = {
                type: alertType,
                title: `📢 Notificação de ${currentUser?.name || 'Sistema'}`,
                message: `Novo apontamento ${alertType} registrado`,
                recordId: recordId,
                recordType: recordType,
                userId: adminUserId, // Para quem é a notificação
                userName: adminUser.name || 'Administrador',
                read: false,
                createdByUserId: currentUser?.uid,
                createdAt: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('notifications').add(personalNotification);
            console.log(`Notificação pessoal criada para: ${adminUser.email}`);
        }
        
    } catch (error) {
        console.error('Erro ao criar notificações pessoais:', error);
    }
}

// ========== FUNÇÃO PRINCIPAL ATUALIZADA ==========
// ========== FUNÇÃO checkAndCreateNotification() ATUALIZADA ==========
async function checkAndCreateNotification(data, recordType, recordId) {
    console.log(`=== VERIFICANDO NOTIFICAÇÃO PARA ${recordType.toUpperCase()} ===`);
    
    // 1. VERIFICAR SE PRECISA DE NOTIFICAÇÃO (QUALQUER USUÁRIO)
    let needsNotification = false;
    let alertType = '';
    
    switch(recordType) {
        case 'temperature_readings':
            console.log(`Status temperatura: ${data.status}`);
            if (data.status === 'alert' || data.status === 'critical') {
                needsNotification = true;
                alertType = data.status;
                console.log(`⚠️ Temperatura ${alertType} detectada!`);
            }
            break;
            
        case 'pressure_readings':
            console.log(`Status pressão: ${data.status}`);
            if (data.status === 'alert' || data.status === 'critical') {
                needsNotification = true;
                alertType = data.status;
                console.log(`⚠️ Pressão ${alertType} detectada!`);
            }
            break;
            
        case 'osmosis_daily':
            console.log(`Status osmose: ${data.conductivityStatus}`);
            if (data.conductivityStatus === 'alert' || data.conductivityStatus === 'critical') {
                needsNotification = true;
                alertType = data.conductivityStatus;
                console.log(`⚠️ Osmose ${alertType} detectada!`);
            }
            break;
    }
    
    // 2. CRIAR NOTIFICAÇÃO SE NECESSÁRIO (PARA QUALQUER USUÁRIO)
    if (needsNotification && alertType) {
        console.log(`✅ CRIANDO NOTIFICAÇÃO ${alertType.toUpperCase()} PARA ADMIN/QUALIDADE`);
        console.log(`Usuário que fez apontamento: ${currentUser?.name} (${currentUser?.role})`);
        console.log(`Registro: ${recordType} - ID: ${recordId}`);
        
        // CHAMAR FUNÇÃO DE CRIAÇÃO DE NOTIFICAÇÃO
        await createNotificationForAdmins(data, recordType, recordId, alertType);
        
        // Registrar rastreabilidade
        await addTraceability(
            'Notificação automática criada',
            `${recordType.replace('_', ' ')} com status ${alertType} criou notificação para admin/qualidade`
        );
        
    } else {
        console.log('✅ Status normal, sem notificação necessária');
    }
}

// ========== FUNÇÃO PARA CARREGAR NOTIFICAÇÕES DO SISTEMA ==========
async function loadSystemNotifications() {
    // Esta função é chamada apenas por admin/qualidade
    if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'qualidade')) {
        return;
    }
    
    try {
        const snapshot = await db.collection('system_notifications')
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        // Processar notificações do sistema
        snapshot.forEach(doc => {
            const notification = doc.data();
            // Marcar como lida pelo usuário atual (se ainda não foi)
            if (!notification.readBy || !notification.readBy.includes(currentUser.uid)) {
                // Atualizar array de leitores
                db.collection('system_notifications').doc(doc.id).update({
                    readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            }
        });
        
    } catch (error) {
        console.error('Erro ao carregar notificações do sistema:', error);
    }
}

// ========== FUNÇÃO createIndividualNotifications() - MÉTODO ALTERNATIVO ==========
async function createIndividualNotifications(data, recordType, recordId, alertType, title, message) {
    console.log('🔄 Tentando método alternativo de criação individual...');
    
    try {
        const userName = data.userName || currentUser?.name || 'Usuário Desconhecido';
        const userRole = currentUser?.role || 'usuário';
        const now = new Date();
        
        // Buscar admin/qualidade individualmente
        const adminsSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .get();
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const doc of adminsSnapshot.docs) {
            const user = doc.data();
            
            // Apenas admin e qualidade
            if (user.role !== 'admin' && user.role !== 'qualidade') {
                continue;
            }
            
            try {
                const notificationData = {
                    type: alertType,
                    title: title,
                    message: message,
                    recordId: recordId,
                    recordType: recordType,
                    userId: doc.id,
                    userName: user.name || 'Usuário',
                    userEmail: user.email,
                    userRole: user.role,
                    read: false,
                    systemGenerated: true,
                    triggeredByUserId: currentUser?.uid || 'system',
                    triggeredByName: userName,
                    triggeredByRole: userRole,
                    createdAt: now,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('notifications').add(notificationData);
                successCount++;
                console.log(`✅ Notificação criada para: ${user.email}`);
                
            } catch (individualError) {
                errorCount++;
                console.error(`❌ Erro para ${user.email}:`, individualError.message);
            }
        }
        
        console.log(`📊 Resultado: ${successCount} sucessos, ${errorCount} erros`);
        
        if (successCount > 0) {
            console.log(`🎉 Notificações criadas com sucesso via método alternativo!`);
        }
        
    } catch (error) {
        console.error('❌ Erro no método alternativo:', error);
    }
}

// ========== SISTEMA DE MODAIS ESTILIZADOS ==========

// Objeto para armazenar callbacks
let modalCallbacks = {
    ok: null,
    cancel: null,
    confirmYes: null,
    confirmNo: null
};

// Inicializar modais após DOM carregado
document.addEventListener('DOMContentLoaded', function() {
    setupModals();
});

function setupModals() {
    // Modal padrão
    const modal = document.getElementById('custom-modal');
    const modalOkBtn = document.getElementById('modal-ok-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    
    modalOkBtn.addEventListener('click', function() {
        hideModal();
        if (modalCallbacks.ok) {
            modalCallbacks.ok();
            modalCallbacks.ok = null;
        }
    });
    
    modalCancelBtn.addEventListener('click', function() {
        hideModal();
        if (modalCallbacks.cancel) {
            modalCallbacks.cancel();
            modalCallbacks.cancel = null;
        }
    });
    
    // Modal de confirmação
    const confirmModal = document.getElementById('confirm-modal');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    
    confirmYesBtn.addEventListener('click', function() {
        hideConfirmModal();
        if (modalCallbacks.confirmYes) {
            modalCallbacks.confirmYes();
            modalCallbacks.confirmYes = null;
        }
    });
    
    confirmNoBtn.addEventListener('click', function() {
        hideConfirmModal();
        if (modalCallbacks.confirmNo) {
            modalCallbacks.confirmNo();
            modalCallbacks.confirmNo = null;
        }
    });
    
    // Fechar ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            hideModal();
        }
    });
    
    confirmModal.addEventListener('click', function(e) {
        if (e.target === confirmModal) {
            hideConfirmModal();
        }
    });
    
    // Fechar com ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (modal.style.display === 'flex') hideModal();
            if (confirmModal.style.display === 'flex') hideConfirmModal();
        }
    });
}

// Função para mostrar modal de alerta
function showModal(title, message, type = 'info', options = {}) {
    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalIcon = document.getElementById('modal-icon');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalOkBtn = document.getElementById('modal-ok-btn');
    
    // Configurar tipo
    modal.className = 'custom-modal';
    modal.classList.add(type);
    
    // Configurar ícone baseado no tipo
    let iconClass = 'fa-info-circle';
    let okText = 'OK';
    
    switch(type) {
        case 'success':
            iconClass = 'fa-check-circle';
            break;
        case 'warning':
            iconClass = 'fa-exclamation-triangle';
            break;
        case 'error':
            iconClass = 'fa-times-circle';
            break;
        case 'info':
            iconClass = 'fa-info-circle';
            break;
    }
    
    // Configurar conteúdo
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalIcon.className = `fas ${iconClass}`;
    
    // Configurar botões
    modalCancelBtn.style.display = options.showCancel ? 'inline-block' : 'none';
    modalOkBtn.textContent = options.okText || 'OK';
    
    // Armazenar callbacks
    modalCallbacks.ok = options.onOk || null;
    modalCallbacks.cancel = options.onCancel || null;
    
    // Mostrar modal
    modal.style.display = 'flex';
    
    // Focar no botão OK
    setTimeout(() => modalOkBtn.focus(), 100);
}

function hideModal() {
    document.getElementById('custom-modal').style.display = 'none';
}

// Função para mostrar modal de confirmação
function showConfirm(message, options = {}) {
    return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        
        confirmMessage.textContent = message;
        
        modalCallbacks.confirmYes = function() {
            resolve(true);
        };
        
        modalCallbacks.confirmNo = function() {
            resolve(false);
        };
        
        confirmModal.style.display = 'flex';
        setTimeout(() => document.getElementById('confirm-yes-btn').focus(), 100);
    });
}

function hideConfirmModal() {
    document.getElementById('confirm-modal').style.display = 'none';
}

// Funções de conveniência
function showSuccess(title, message, options = {}) {
    showModal(title, message, 'success', options);
}

function showError(title, message, options = {}) {
    showModal(title, message, 'error', options);
}

function showWarning(title, message, options = {}) {
    showModal(title, message, 'warning', options);
}

function showInfo(title, message, options = {}) {
    showModal(title, message, 'info', options);
}

// Função de fallback se db estiver nulo
function getFirestore() {
    if (!db) {
        console.warn('db é null, tentando re-inicializar...');
        try {
            // Tentar obter novamente
            db = firebase.firestore();
            
            if (!db) {
                throw new Error('Não foi possível obter instância do Firestore');
            }
            
            console.log('Firestore re-inicializado');
            return db;
        } catch (error) {
            console.error('Falha ao re-inicializar Firestore:', error);
            
            // Mostrar erro amigável
            showError('Erro do Sistema', 
                'O sistema não conseguiu conectar ao banco de dados.\n\n' +
                'Por favor:\n' +
                '1. Verifique sua conexão com a internet\n' +
                '2. Recarregue a página (F5)\n' +
                '3. Entre em contato com o administrador');
            
            throw error;
        }
    }
    
    return db;
}

// Use assim em todas as funções:
async function exemploFuncao() {
    try {
        const firestore = getFirestore(); // Usar esta função em vez de db direto
        const snapshot = await firestore.collection('exemplo').get();
        // ...
    } catch (error) {
        // Tratar erro
    }
}

// Adicione esta função para mostrar/ocultar itens do menu baseado no role
function updateMenuVisibility() {
    if (!currentUser) return;
    
    const menuItems = document.querySelectorAll('.menu-item');
    
    menuItems.forEach(item => {
        const page = item.getAttribute('data-page');
        
        // Sempre visível para todos
        const alwaysVisible = ['temperature', 'pressure', 'osmosis'];
        
        if (alwaysVisible.includes(page)) {
            item.style.display = 'flex';
            return;
        }
        
        // Verificar acesso para outras páginas
        if (checkUserAccess(page)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// Função de diagnóstico
async function diagnoseLoginProblems() {
    console.log('=== DIAGNÓSTICO DE LOGIN ===');
    
    // 1. Verificar Firebase
    console.log('1. Firebase:', firebase ? 'OK' : 'FALHA');
    console.log('2. Auth:', auth ? 'OK' : 'FALHA');
    console.log('3. Firestore:', db ? 'OK' : 'FALHA');
    
    // 2. Tentar conexão simples
    try {
        console.log('4. Testando conexão com Firestore...');
        const test = await db.collection('system_config').limit(1).get();
        console.log('   Conexão:', test ? 'OK' : 'FALHA');
    } catch (error) {
        console.log('   Conexão: FALHA -', error.message);
    }
    
    // 3. Verificar regras
    console.log('5. Verificando usuários existentes...');
    try {
        const users = await db.collection('users').limit(5).get();
        console.log(`   ${users.size} usuários encontrados`);
    } catch (error) {
        console.log('   Erro:', error.message);
    }
    
    console.log('=== FIM DO DIAGNÓSTICO ===');
}

// Adicione esta função para verificar se usuário pode editar
function canUserEdit() {
    if (!currentUser) return false;
    
    // Admin sempre pode editar
    if (currentUser.role === 'admin') return true;
    
    // Qualidade pode editar
    if (currentUser.role === 'qualidade') return true;
    
    // Manutenção pode editar (se aplicável)
    if (currentUser.role === 'manutencao') return true;
    
    return false;
}

// Atualize a função createTemperatureRow para mostrar botões de edição para qualidade:
function createTemperatureRow(data, docId) {
    const row = document.createElement('tr');
    const statusClass = `status-${data.status || 'normal'}`;
    const createdAt = data.createdAt ? 
        new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
    
    // Verificar se usuário pode editar
    const canEdit = canUserEdit();
    
    row.innerHTML = `
        <td>${createdAt}</td>
        <td>${data.roomName || '-'}</td>
        <td>${data.period || '-'}</td>
        <td>${data.tempMin || '-'}°C</td>
        <td>${data.tempMax || '-'}°C</td>
        <td>${data.tempActual || '-'}°C</td>
        <td>${data.humidityMin || '-'}%</td>
        <td>${data.humidityMax || '-'}%</td>
        <td>${data.humidityActual || '-'}%</td>
        <td><span class="status ${statusClass}">${getStatusText(data.status)}</span></td>
        <td>${data.userName || '-'}</td>
        <td class="${canEdit ? '' : 'admin-only'}">
            ${canEdit ? `
            <button class="btn btn-primary btn-sm" onclick="editTemperatureReading('${docId}')">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteRecord('temperature_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de temperatura?')">
                <i class="fas fa-trash"></i>
            </button>
            ` : `
            <span class="text-muted" style="font-size: 12px;">
                <i class="fas fa-lock"></i> Sem permissão
            </span>
            `}
        </td>
    `;
    return row;
}

// Atualize também a função createPressureRow:
function createPressureRow(data, docId) {
    const row = document.createElement('tr');
    const statusClass = `status-${data.status || 'normal'}`;
    const createdAt = data.createdAt ? 
        new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
    
    const canEdit = canUserEdit();
    
    row.innerHTML = `
        <td>${createdAt}</td>
        <td>${data.roomName || '-'}</td>
        <td>${data.period || '-'}</td>
        <td>${data.pressure || '-'} Pa</td>
        <td>${data.immediateCorrection || '-'}</td>
        <td><span class="status ${statusClass}">${getStatusText(data.status)}</span></td>
        <td>${data.userName || '-'}</td>
        <td class="${canEdit ? '' : 'admin-only'}">
            ${canEdit ? `
            <button class="btn btn-primary btn-sm" onclick="editPressureReading('${docId}')">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteRecord('pressure_readings', '${docId}', 'Tem certeza que deseja excluir esta leitura de pressão?')">
                <i class="fas fa-trash"></i>
            </button>
            ` : `
            <span class="text-muted" style="font-size: 12px;">
                <i class="fas fa-lock"></i> Sem permissão
            </span>
            `}
        </td>
    `;
    return row;
}

// Atualize a função createOsmosisRow:
function createOsmosisRow(data, docId) {
    const row = document.createElement('tr');
    const statusClass = `status-${data.conductivityStatus || 'normal'}`;
    const createdAt = data.createdAt ? 
        new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleString('pt-BR') : '-';
    
    const canEdit = canUserEdit();
    
    row.innerHTML = `
        <td>${createdAt}</td>
        <td>${data.conductivity || '-'} µS/cm</td>
        <td><span class="status ${statusClass}">${getStatusText(data.conductivityStatus)}</span></td>
        <td>${data.hasAbnormality ? 'Sim' : 'Não'}</td>
        <td>${data.userName || '-'}</td>
        <td class="${canEdit ? '' : 'admin-only'}">
            ${canEdit ? `
            <button class="btn btn-primary btn-sm">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteRecord('osmosis_daily', '${docId}', 'Tem certeza que deseja excluir este registro de osmose?')">
                <i class="fas fa-trash"></i>
            </button>
            ` : `
            <span class="text-muted" style="font-size: 12px;">
                <i class="fas fa-lock"></i> Sem permissão
            </span>
            `}
        </td>
    `;
    return row;
}

// Chamar no console: diagnoseLoginProblems()


// Chamar após login
// No handleUserLogin, após updateUI():
// setTimeout(addDebugButtonToUI, 1000);
    </script>
</body>
</html>